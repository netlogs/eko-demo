(()=>{"use strict";const e="mac";var t;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.FATAL=4]="FATAL",e[e.OFF=5]="OFF"}(t||(t={}));class n{log(e,n){({[t.DEBUG]:console.debug,[t.INFO]:console.info,[t.WARN]:console.warn,[t.ERROR]:console.error,[t.FATAL]:console.error,[t.OFF]:()=>{}}[e]||console.log)(n)}}class s{constructor(e={}){this.level=e.level??t.INFO,this.prefix=e.prefix??"",this.dateFormat=e.dateFormat??!0,this.transports=e.transport??[new n]}setLevel(e){return this.level=e,this}setPrefix(e){return this.prefix=e,this}addTransport(e){return this.transports.push(e),this}formatMessage(e,n){const s={[t.DEBUG]:"DEBUG",[t.INFO]:"INFO",[t.WARN]:"WARN",[t.ERROR]:"ERROR",[t.FATAL]:"FATAL",[t.OFF]:"OFF"};let o="";return this.dateFormat&&(o+=`[${(new Date).toLocaleString()}] `),o+=`[${s[e]||"UNKNOWN"}] `,this.prefix&&(o+=`[${this.prefix}] `),o+=n,o}log(e,t,...n){if(e<this.level)return;let s;s=t instanceof Error?`${t.message}\n${t.stack}`:t,n.length>0&&(s+=" "+n.map(e=>null==e||null==e?e+"":e instanceof Error||e.stack&&e.message?`${e.message}\n${e.stack}`:"object"==typeof e?JSON.stringify(e):String(e)).join(" "));const o=this.formatMessage(e,s);this.transports.forEach(t=>{t.log(e,o)})}isEnableDebug(){return this.level<=t.DEBUG}debug(e,...n){this.log(t.DEBUG,e,...n)}isEnableInfo(){return this.level<=t.INFO}info(e,...n){this.log(t.INFO,e,...n)}warn(e,...n){this.log(t.WARN,e,...n)}error(e,...n){this.log(t.ERROR,e,...n)}fatal(e,...n){this.log(t.FATAL,e,...n)}createChild(e,t={}){const n=this.prefix?`${this.prefix}.${e}`:e;return new s({level:t.level||this.level,prefix:n,dateFormat:void 0!==t.dateFormat?t.dateFormat:this.dateFormat,transport:t.transport||this.transports})}}const o=new s;function r(e){return new Promise(t=>setTimeout(()=>t(),e))}function a(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function i(e,t,n){return new Promise(async(s,o)=>{let r=setTimeout(()=>{o(new Error("Timeout")),n&&n("Timeout")},t);try{const t=await e();clearTimeout(r),s(t)}catch(e){clearTimeout(r),o(e),n&&n(e+"")}})}function l(e){let t=null;if(e.startsWith("http://")||e.startsWith("https://"))t=new URL(e);else if(e.startsWith("data:image/")&&(e=e.substring(e.indexOf(",")+1)),"undefined"!=typeof Buffer){const n=Buffer.from(e,"base64");t=new Uint8Array(n)}else{const n=atob(e);t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e)}return t}function u(e,t){let n=[],s=t.reduce((e,t)=>(e[t.name]=t,e),{}),o=[];for(let t=0;t<e.length;t++){let o=e[t],r=s[o.name];r?(n.push(r),delete s[o.name]):n.push(o)}for(let e=0;e<t.length;e++){let r=t[e];s[r.name]&&-1===o.indexOf(r.name)&&(n.push(r),o.push(r.name))}return n}function c(e,t){let n=[],s=t.reduce((e,t)=>(e[t.Name]=t,e),{});for(let t=0;t<e.length;t++){let o=e[t],r=s[o.Name];r?(n.push(r),delete s[o.Name]):n.push(o)}for(let e=0;e<t.length;e++){let o=t[e];s[o.Name]&&n.push(o)}return n}function d(e,t,n=!0){return e?e.length>t?e.substring(0,t)+(n?"...":""):e:""}class p{constructor(e,t,n,s){this.conversation=[],this.pauseStatus=0,this.currentStepControllers=new Set,this.taskId=e,this.config=t,this.agents=n,this.chain=s,this.variables=new Map,this.controller=new AbortController}async checkAborted(e){if(this.controller.signal.aborted){const e=new Error("Operation was interrupted");throw e.name="AbortError",e}for(;this.pauseStatus>0&&!e;)if(await r(500),2==this.pauseStatus&&(this.currentStepControllers.forEach(e=>{e.abort("Pause")}),this.currentStepControllers.clear()),this.controller.signal.aborted){const e=new Error("Operation was interrupted");throw e.name="AbortError",e}}currentAgent(){const e=this.chain.agents[this.chain.agents.length-1];if(!e)return null;const t=this.agents.filter(t=>t.Name==e.agent.name)[0];if(!t)return null;const n=t.AgentContext;return[t,e.agent,n]}get pause(){return this.pauseStatus>0}setPause(e,t){this.pauseStatus=e?t?2:1:0,2==this.pauseStatus&&(this.currentStepControllers.forEach(e=>{e.abort("Pause")}),this.currentStepControllers.clear())}}class h{constructor(e,t,n){this.context=e,this.agent=t,this.agentChain=n,this.variables=new Map,this.consecutiveErrorNum=0}}var m,g="vercel.ai.error",f=Symbol.for(g),y=class e extends Error{constructor({name:e,message:t,cause:n}){super(t),this[m]=!0,this.name=e,this.cause=n}static isInstance(t){return e.hasMarker(t,g)}static hasMarker(e,t){const n=Symbol.for(t);return null!=e&&"object"==typeof e&&n in e&&"boolean"==typeof e[n]&&!0===e[n]}};m=f;var b,v=y,w="AI_APICallError",_=`vercel.ai.error.${w}`,x=Symbol.for(_),k=class extends v{constructor({message:e,url:t,requestBodyValues:n,statusCode:s,responseHeaders:o,responseBody:r,cause:a,isRetryable:i=null!=s&&(408===s||409===s||429===s||s>=500),data:l}){super({name:w,message:e,cause:a}),this[b]=!0,this.url=t,this.requestBodyValues=n,this.statusCode=s,this.responseHeaders=o,this.responseBody=r,this.isRetryable=i,this.data=l}static isInstance(e){return v.hasMarker(e,_)}};b=x;var T,N="AI_EmptyResponseBodyError",I=`vercel.ai.error.${N}`,C=Symbol.for(I),S=class extends v{constructor({message:e="Empty response body"}={}){super({name:N,message:e}),this[T]=!0}static isInstance(e){return v.hasMarker(e,I)}};function E(e){return null==e?"unknown error":"string"==typeof e?e:e instanceof Error?e.message:JSON.stringify(e)}T=C;var A,O="AI_InvalidArgumentError",j=`vercel.ai.error.${O}`,R=Symbol.for(j),M=class extends v{constructor({message:e,cause:t,argument:n}){super({name:O,message:e,cause:t}),this[A]=!0,this.argument=n}static isInstance(e){return v.hasMarker(e,j)}};A=R;var D,$="AI_InvalidPromptError",U=`vercel.ai.error.${$}`,P=Symbol.for(U),q=class extends v{constructor({prompt:e,message:t,cause:n}){super({name:$,message:`Invalid prompt: ${t}`,cause:n}),this[D]=!0,this.prompt=e}static isInstance(e){return v.hasMarker(e,U)}};D=P;var L,F="AI_InvalidResponseDataError",B=`vercel.ai.error.${F}`,H=Symbol.for(B),Z=class extends v{constructor({data:e,message:t=`Invalid response data: ${JSON.stringify(e)}.`}){super({name:F,message:t}),this[L]=!0,this.data=e}static isInstance(e){return v.hasMarker(e,B)}};L=H;var W,V="AI_JSONParseError",z=`vercel.ai.error.${V}`,K=Symbol.for(z),G=class extends v{constructor({text:e,cause:t}){super({name:V,message:`JSON parsing failed: Text: ${e}.\nError message: ${E(t)}`,cause:t}),this[W]=!0,this.text=e}static isInstance(e){return v.hasMarker(e,z)}};W=K;var J,X="AI_LoadAPIKeyError",Y=`vercel.ai.error.${X}`,Q=Symbol.for(Y),ee=class extends v{constructor({message:e}){super({name:X,message:e}),this[J]=!0}static isInstance(e){return v.hasMarker(e,Y)}};J=Q;var te,ne="AI_LoadSettingError",se=`vercel.ai.error.${ne}`,oe=Symbol.for(se),re=class extends v{constructor({message:e}){super({name:ne,message:e}),this[te]=!0}static isInstance(e){return v.hasMarker(e,se)}};te=oe;var ae,ie="AI_NoSuchModelError",le=`vercel.ai.error.${ie}`,ue=Symbol.for(le),ce=class extends v{constructor({errorName:e=ie,modelId:t,modelType:n,message:s=`No such ${n}: ${t}`}){super({name:e,message:s}),this[ae]=!0,this.modelId=t,this.modelType=n}static isInstance(e){return v.hasMarker(e,le)}};ae=ue;var de,pe="AI_TooManyEmbeddingValuesForCallError",he=`vercel.ai.error.${pe}`,me=Symbol.for(he),ge=class extends v{constructor(e){super({name:pe,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[de]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return v.hasMarker(e,he)}};de=me;var fe,ye="AI_TypeValidationError",be=`vercel.ai.error.${ye}`,ve=Symbol.for(be);fe=ve;var we,_e=class e extends v{constructor({value:e,cause:t}){super({name:ye,message:`Type validation failed: Value: ${JSON.stringify(e)}.\nError message: ${E(t)}`,cause:t}),this[fe]=!0,this.value=e}static isInstance(e){return v.hasMarker(e,be)}static wrap({value:t,cause:n}){return e.isInstance(n)&&n.value===t?n:new e({value:t,cause:n})}},xe="AI_UnsupportedFunctionalityError",ke=`vercel.ai.error.${xe}`,Te=Symbol.for(ke),Ne=class extends v{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:xe,message:t}),this[we]=!0,this.functionality=e}static isInstance(e){return v.hasMarker(e,ke)}};function Ie(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}we=Te;var Ce,Se={exports:{}},Ee=Ie(function(){if(Ce)return Se.exports;Ce=1;const e="undefined"!=typeof Buffer,t=/"(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])"\s*:/,n=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/;function s(s,r,a){null==a&&null!==r&&"object"==typeof r&&(a=r,r=void 0),e&&Buffer.isBuffer(s)&&(s=s.toString()),s&&65279===s.charCodeAt(0)&&(s=s.slice(1));const i=JSON.parse(s,r);if(null===i||"object"!=typeof i)return i;const l=a&&a.protoAction||"error",u=a&&a.constructorAction||"error";if("ignore"===l&&"ignore"===u)return i;if("ignore"!==l&&"ignore"!==u){if(!1===t.test(s)&&!1===n.test(s))return i}else if("ignore"!==l&&"ignore"===u){if(!1===t.test(s))return i}else if(!1===n.test(s))return i;return o(i,{protoAction:l,constructorAction:u,safe:a&&a.safe})}function o(e,{protoAction:t="error",constructorAction:n="error",safe:s}={}){let o=[e];for(;o.length;){const e=o;o=[];for(const r of e){if("ignore"!==t&&Object.prototype.hasOwnProperty.call(r,"__proto__")){if(!0===s)return null;if("error"===t)throw new SyntaxError("Object contains forbidden prototype property");delete r.__proto__}if("ignore"!==n&&Object.prototype.hasOwnProperty.call(r,"constructor")&&Object.prototype.hasOwnProperty.call(r.constructor,"prototype")){if(!0===s)return null;if("error"===n)throw new SyntaxError("Object contains forbidden prototype property");delete r.constructor}for(const e in r){const t=r[e];t&&"object"==typeof t&&o.push(t)}}}return e}function r(e,t,n){const o=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(e,t,n)}finally{Error.stackTraceLimit=o}}return Se.exports=r,Se.exports.default=r,Se.exports.parse=r,Se.exports.safeParse=function(e,t){const n=Error.stackTraceLimit;Error.stackTraceLimit=0;try{return s(e,t,{safe:!0})}catch(e){return null}finally{Error.stackTraceLimit=n}},Se.exports.scan=o,Se.exports}());function Ae(...e){return e.reduce((e,t)=>({...e,...null!=t?t:{}}),{})}function Oe(){let e,t,n,s="",o=[];function r(e,t){if(""===e)return void a(t);if(e.startsWith(":"))return;const n=e.indexOf(":");if(-1===n)return void i(e,"");const s=n+1;i(e.slice(0,n),s<e.length&&" "===e[s]?e.slice(s+1):e.slice(s))}function a(s){o.length>0&&(s.enqueue({event:e,data:o.join("\n"),id:t,retry:n}),o=[],e=void 0,n=void 0)}function i(s,r){switch(s){case"event":e=r;break;case"data":o.push(r);break;case"id":t=r;break;case"retry":const s=parseInt(r,10);isNaN(s)||(n=s)}}return new TransformStream({transform(e,t){const{lines:n,incompleteLine:o}=function(e,t){const n=[];let s=e;for(let e=0;e<t.length;){const o=t[e++];"\n"===o?(n.push(s),s=""):"\r"===o?(n.push(s),s="","\n"===t[e]&&e++):s+=o}return{lines:n,incompleteLine:s}}(s,e);s=o;for(let e=0;e<n.length;e++)r(n[e],t)},flush(e){r(s,e),a(e)}})}function je(e){const t={};return e.headers.forEach((e,n)=>{t[n]=e}),t}var Re=({prefix:e,size:t=16,alphabet:n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",separator:s="-"}={})=>{const o=((e,t=21)=>(n=t)=>{let s="",o=0|n;for(;o--;)s+=e[Math.random()*e.length|0];return s})(n,t);if(null==e)return o;if(n.includes(s))throw new M({argument:"separator",message:`The separator "${s}" must not be part of the alphabet "${n}".`});return t=>`${e}${s}${o(t)}`},Me=Re();function De(e){return Object.fromEntries(Object.entries(e).filter(([e,t])=>null!=t))}function $e(e){return e instanceof Error&&("AbortError"===e.name||"TimeoutError"===e.name)}function Ue({apiKey:e,environmentVariableName:t,apiKeyParameterName:n="apiKey",description:s}){if("string"==typeof e)return e;if(null!=e)throw new ee({message:`${s} API key must be a string.`});if("undefined"==typeof process)throw new ee({message:`${s} API key is missing. Pass it using the '${n}' parameter. Environment variables is not supported in this environment.`});if(null==(e=process.env[t]))throw new ee({message:`${s} API key is missing. Pass it using the '${n}' parameter or the ${t} environment variable.`});if("string"!=typeof e)throw new ee({message:`${s} API key must be a string. The value of the ${t} environment variable is not a string.`});return e}function Pe({settingValue:e,environmentVariableName:t}){return"string"==typeof e||null==e&&"undefined"!=typeof process&&null!=(e=process.env[t])&&"string"==typeof e?e:void 0}function qe({settingValue:e,environmentVariableName:t,settingName:n,description:s}){if("string"==typeof e)return e;if(null!=e)throw new re({message:`${s} setting must be a string.`});if("undefined"==typeof process)throw new re({message:`${s} setting is missing. Pass it using the '${n}' parameter. Environment variables is not supported in this environment.`});if(null==(e=process.env[t]))throw new re({message:`${s} setting is missing. Pass it using the '${n}' parameter or the ${t} environment variable.`});if("string"!=typeof e)throw new re({message:`${s} setting must be a string. The value of the ${t} environment variable is not a string.`});return e}var Le=Symbol.for("vercel.ai.validator");function Fe({value:e,schema:t}){const n=function(e){return function(e){return"object"==typeof e&&null!==e&&Le in e&&!0===e[Le]&&"validate"in e}(e)?e:(t=e,n=e=>{const n=t.safeParse(e);return n.success?{success:!0,value:n.data}:{success:!1,error:n.error}},{[Le]:!0,validate:n});var t,n}(t);try{if(null==n.validate)return{success:!0,value:e};const t=n.validate(e);return t.success?t:{success:!1,error:_e.wrap({value:e,cause:t.error})}}catch(t){return{success:!1,error:_e.wrap({value:e,cause:t})}}}function Be({text:e,schema:t}){try{const n=Ee.parse(e);if(null==t)return{success:!0,value:n,rawValue:n};const s=Fe({value:n,schema:t});return s.success?{...s,rawValue:n}:s}catch(t){return{success:!1,error:G.isInstance(t)?t:new G({text:e,cause:t})}}}function He(e){try{return Ee.parse(e),!0}catch(e){return!1}}function Ze({provider:e,providerOptions:t,schema:n}){if(null==(null==t?void 0:t[e]))return;const s=Fe({value:t[e],schema:n});if(!s.success)throw new M({argument:"providerOptions",message:`invalid ${e} provider options`,cause:s.error});return s.value}var We=()=>globalThis.fetch,Ve=async({url:e,headers:t,body:n,failedResponseHandler:s,successfulResponseHandler:o,abortSignal:r,fetch:a})=>ze({url:e,headers:{"Content-Type":"application/json",...t},body:{content:JSON.stringify(n),values:n},failedResponseHandler:s,successfulResponseHandler:o,abortSignal:r,fetch:a}),ze=async({url:e,headers:t={},body:n,successfulResponseHandler:s,failedResponseHandler:o,abortSignal:r,fetch:a=We()})=>{try{const i=await a(e,{method:"POST",headers:De(t),body:n.content,signal:r}),l=je(i);if(!i.ok){let t;try{t=await o({response:i,url:e,requestBodyValues:n.values})}catch(t){if($e(t)||k.isInstance(t))throw t;throw new k({message:"Failed to process error response",cause:t,statusCode:i.status,url:e,responseHeaders:l,requestBodyValues:n.values})}throw t.value}try{return await s({response:i,url:e,requestBodyValues:n.values})}catch(t){if(t instanceof Error&&($e(t)||k.isInstance(t)))throw t;throw new k({message:"Failed to process successful response",cause:t,statusCode:i.status,url:e,responseHeaders:l,requestBodyValues:n.values})}}catch(t){if($e(t))throw t;if(t instanceof TypeError&&"fetch failed"===t.message){const s=t.cause;if(null!=s)throw new k({message:`Cannot connect to API: ${s.message}`,cause:s,url:e,requestBodyValues:n.values,isRetryable:!0})}throw t}};async function Ke(e){return"function"==typeof e&&(e=e()),Promise.resolve(e)}var Ge,Je,Xe=({errorSchema:e,errorToMessage:t,isRetryable:n})=>async({response:s,url:o,requestBodyValues:r})=>{const a=await s.text(),i=je(s);if(""===a.trim())return{responseHeaders:i,value:new k({message:s.statusText,url:o,requestBodyValues:r,statusCode:s.status,responseHeaders:i,responseBody:a,isRetryable:null==n?void 0:n(s)})};try{const l=function({text:e,schema:t}){try{const n=Ee.parse(e);return null==t?n:function({value:e,schema:t}){const n=Fe({value:e,schema:t});if(!n.success)throw _e.wrap({value:e,cause:n.error});return n.value}({value:n,schema:t})}catch(t){if(G.isInstance(t)||_e.isInstance(t))throw t;throw new G({text:e,cause:t})}}({text:a,schema:e});return{responseHeaders:i,value:new k({message:t(l),url:o,requestBodyValues:r,statusCode:s.status,responseHeaders:i,responseBody:a,data:l,isRetryable:null==n?void 0:n(s,l)})}}catch(e){return{responseHeaders:i,value:new k({message:s.statusText,url:o,requestBodyValues:r,statusCode:s.status,responseHeaders:i,responseBody:a,isRetryable:null==n?void 0:n(s)})}}},Ye=e=>async({response:t})=>{const n=je(t);if(null==t.body)throw new S({});return{responseHeaders:n,value:t.body.pipeThrough(new TextDecoderStream).pipeThrough(Oe()).pipeThrough(new TransformStream({transform({data:t},n){"[DONE]"!==t&&n.enqueue(Be({text:t,schema:e}))}}))}},Qe=e=>async({response:t,url:n,requestBodyValues:s})=>{const o=await t.text(),r=Be({text:o,schema:e}),a=je(t);if(!r.success)throw new k({message:"Invalid JSON response",cause:r.error,statusCode:t.status,responseHeaders:a,responseBody:o,url:n,requestBodyValues:s});return{responseHeaders:a,value:r.value,rawValue:r.rawValue}},{btoa:et,atob:tt}=globalThis;function nt(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=tt(t);return Uint8Array.from(n,e=>e.codePointAt(0))}function st(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCodePoint(e[n]);return et(t)}function ot(e){return null==e?void 0:e.replace(/\/$/,"")}!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),s={};for(const e of n)s[e]=t[e];return e.objectValues(s)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(Ge||(Ge={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Je||(Je={}));const rt=Ge.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),at=e=>{switch(typeof e){case"undefined":return rt.undefined;case"string":return rt.string;case"number":return isNaN(e)?rt.nan:rt.number;case"boolean":return rt.boolean;case"function":return rt.function;case"bigint":return rt.bigint;case"symbol":return rt.symbol;case"object":return Array.isArray(e)?rt.array:null===e?rt.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?rt.promise:"undefined"!=typeof Map&&e instanceof Map?rt.map:"undefined"!=typeof Set&&e instanceof Set?rt.set:"undefined"!=typeof Date&&e instanceof Date?rt.date:rt.object;default:return rt.unknown}},it=Ge.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class lt extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},s=e=>{for(const o of e.issues)if("invalid_union"===o.code)o.unionErrors.map(s);else if("invalid_return_type"===o.code)s(o.returnTypeError);else if("invalid_arguments"===o.code)s(o.argumentsError);else if(0===o.path.length)n._errors.push(t(o));else{let e=n,s=0;for(;s<o.path.length;){const n=o.path[s];s===o.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(o))):e[n]=e[n]||{_errors:[]},e=e[n],s++}}};return s(this),n}static assert(e){if(!(e instanceof lt))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Ge.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}lt.create=e=>new lt(e);const ut=(e,t)=>{let n;switch(e.code){case it.invalid_type:n=e.received===rt.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case it.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,Ge.jsonStringifyReplacer)}`;break;case it.unrecognized_keys:n=`Unrecognized key(s) in object: ${Ge.joinValues(e.keys,", ")}`;break;case it.invalid_union:n="Invalid input";break;case it.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${Ge.joinValues(e.options)}`;break;case it.invalid_enum_value:n=`Invalid enum value. Expected ${Ge.joinValues(e.options)}, received '${e.received}'`;break;case it.invalid_arguments:n="Invalid function arguments";break;case it.invalid_return_type:n="Invalid function return type";break;case it.invalid_date:n="Invalid date";break;case it.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:Ge.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case it.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case it.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case it.custom:n="Invalid input";break;case it.invalid_intersection_types:n="Intersection results could not be merged";break;case it.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case it.not_finite:n="Number must be finite";break;default:n=t.defaultError,Ge.assertNever(e)}return{message:n}};let ct=ut;function dt(){return ct}const pt=e=>{const{data:t,path:n,errorMaps:s,issueData:o}=e,r=[...n,...o.path||[]],a={...o,path:r};if(void 0!==o.message)return{...o,path:r,message:o.message};let i="";const l=s.filter(e=>!!e).slice().reverse();for(const e of l)i=e(a,{data:t,defaultError:i}).message;return{...o,path:r,message:i}};function ht(e,t){const n=dt(),s=pt({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===ut?void 0:ut].filter(e=>!!e)});e.common.issues.push(s)}class mt{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if("aborted"===s.status)return gt;"dirty"===s.status&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,s=await e.value;n.push({key:t,value:s})}return mt.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:t,value:o}=s;if("aborted"===t.status)return gt;if("aborted"===o.status)return gt;"dirty"===t.status&&e.dirty(),"dirty"===o.status&&e.dirty(),"__proto__"===t.value||void 0===o.value&&!s.alwaysSet||(n[t.value]=o.value)}return{status:e.value,value:n}}}const gt=Object.freeze({status:"aborted"}),ft=e=>({status:"dirty",value:e}),yt=e=>({status:"valid",value:e}),bt=e=>"aborted"===e.status,vt=e=>"dirty"===e.status,wt=e=>"valid"===e.status,_t=e=>"undefined"!=typeof Promise&&e instanceof Promise;function xt(e,t,n,s){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function kt(e,t,n,s,o){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,n),n}var Tt,Nt,It;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(Tt||(Tt={}));class Ct{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const St=(e,t)=>{if(wt(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new lt(e.common.issues);return this._error=t,this._error}}};function Et(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:s,description:o}=e;if(t&&(n||s))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:o}:{errorMap:(t,o)=>{var r,a;const{message:i}=e;return"invalid_enum_value"===t.code?{message:null!=i?i:o.defaultError}:void 0===o.data?{message:null!==(r=null!=i?i:s)&&void 0!==r?r:o.defaultError}:"invalid_type"!==t.code?{message:o.defaultError}:{message:null!==(a=null!=i?i:n)&&void 0!==a?a:o.defaultError}},description:o}}class At{get description(){return this._def.description}_getType(e){return at(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:at(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new mt,ctx:{common:e.parent.common,data:e.data,parsedType:at(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(_t(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const s={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:at(e)},o=this._parseSync({data:e,path:s.path,parent:s});return St(s,o)}"~validate"(e){var t,n;const s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:at(e)};if(!this["~standard"].async)try{const t=this._parseSync({data:e,path:[],parent:s});return wt(t)?{value:t.value}:{issues:s.common.issues}}catch(e){(null===(n=null===(t=null==e?void 0:e.message)||void 0===t?void 0:t.toLowerCase())||void 0===n?void 0:n.includes("encountered"))&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(e=>wt(e)?{value:e.value}:{issues:s.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:at(e)},s=this._parse({data:e,path:n.path,parent:n}),o=await(_t(s)?s:Promise.resolve(s));return St(n,o)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,s)=>{const o=e(t),r=()=>s.addIssue({code:it.custom,...n(t)});return"undefined"!=typeof Promise&&o instanceof Promise?o.then(e=>!!e||(r(),!1)):!!o||(r(),!1)})}refinement(e,t){return this._refinement((n,s)=>!!e(n)||(s.addIssue("function"==typeof t?t(n,s):t),!1))}_refinement(e){return new Rn({schema:this,typeName:Vn.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Mn.create(this,this._def)}nullable(){return Dn.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return mn.create(this)}promise(){return jn.create(this,this._def)}or(e){return yn.create([this,e],this._def)}and(e){return _n.create(this,e,this._def)}transform(e){return new Rn({...Et(this._def),schema:this,typeName:Vn.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new $n({...Et(this._def),innerType:this,defaultValue:t,typeName:Vn.ZodDefault})}brand(){return new Ln({typeName:Vn.ZodBranded,type:this,...Et(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new Un({...Et(this._def),innerType:this,catchValue:t,typeName:Vn.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Fn.create(this,e)}readonly(){return Bn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Ot=/^c[^\s-]{8,}$/i,jt=/^[0-9a-z]+$/,Rt=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Mt=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Dt=/^[a-z0-9_-]{21}$/i,$t=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Ut=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Pt=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let qt;const Lt=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Ft=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Bt=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ht=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Zt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Wt=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Vt="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",zt=new RegExp(`^${Vt}$`);function Kt(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function Gt(e){return new RegExp(`^${Kt(e)}$`)}function Jt(e){let t=`${Vt}T${Kt(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function Xt(e,t){return!("v4"!==t&&t||!Lt.test(e))||!("v6"!==t&&t||!Bt.test(e))}function Yt(e,t){if(!$t.test(e))return!1;try{const[n]=e.split("."),s=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),o=JSON.parse(atob(s));return!("object"!=typeof o||null===o||!o.typ||!o.alg||t&&o.alg!==t)}catch(e){return!1}}function Qt(e,t){return!("v4"!==t&&t||!Ft.test(e))||!("v6"!==t&&t||!Ht.test(e))}class en extends At{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==rt.string){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.string,received:t.parsedType}),gt}const t=new mt;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const o=e.data.length>s.value,r=e.data.length<s.value;(o||r)&&(n=this._getOrReturnCtx(e,n),o?ht(n,{code:it.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):r&&ht(n,{code:it.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)Pt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"email",code:it.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)qt||(qt=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),qt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"emoji",code:it.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)Mt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"uuid",code:it.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)Dt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"nanoid",code:it.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)Ot.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"cuid",code:it.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)jt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"cuid2",code:it.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)Rt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"ulid",code:it.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch(o){n=this._getOrReturnCtx(e,n),ht(n,{validation:"url",code:it.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"regex",code:it.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?Jt(s).test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?zt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?Gt(s).test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{code:it.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?Ut.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"duration",code:it.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?Xt(e.data,s.version)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"ip",code:it.invalid_string,message:s.message}),t.dirty()):"jwt"===s.kind?Yt(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"jwt",code:it.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?Qt(e.data,s.version)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"cidr",code:it.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?Zt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"base64",code:it.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?Wt.test(e.data)||(n=this._getOrReturnCtx(e,n),ht(n,{validation:"base64url",code:it.invalid_string,message:s.message}),t.dirty()):Ge.assertNever(s);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:it.invalid_string,...Tt.errToObj(n)})}_addCheck(e){return new en({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Tt.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Tt.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Tt.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Tt.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Tt.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Tt.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Tt.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Tt.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Tt.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Tt.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Tt.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Tt.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Tt.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...Tt.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...Tt.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Tt.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Tt.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...Tt.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Tt.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Tt.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Tt.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Tt.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Tt.errToObj(t)})}nonempty(e){return this.min(1,Tt.errToObj(e))}trim(){return new en({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new en({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new en({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function tn(e,t){const n=(e.toString().split(".")[1]||"").length,s=(t.toString().split(".")[1]||"").length,o=n>s?n:s;return parseInt(e.toFixed(o).replace(".",""))%parseInt(t.toFixed(o).replace(".",""))/Math.pow(10,o)}en.create=e=>{var t;return new en({checks:[],typeName:Vn.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...Et(e)})};class nn extends At{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==rt.number){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.number,received:t.parsedType}),gt}let t;const n=new mt;for(const s of this._def.checks)"int"===s.kind?Ge.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),ht(t,{code:it.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty()):"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"multipleOf"===s.kind?0!==tn(e.data,s.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):"finite"===s.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),ht(t,{code:it.not_finite,message:s.message}),n.dirty()):Ge.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Tt.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Tt.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Tt.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Tt.toString(t))}setLimit(e,t,n,s){return new nn({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Tt.toString(s)}]})}_addCheck(e){return new nn({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Tt.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Tt.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Tt.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Tt.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Tt.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Tt.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Tt.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Tt.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Tt.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&Ge.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}nn.create=e=>new nn({checks:[],typeName:Vn.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...Et(e)});class sn extends At{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(t){return this._getInvalidInput(e)}if(this._getType(e)!==rt.bigint)return this._getInvalidInput(e);let t;const n=new mt;for(const s of this._def.checks)"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"multipleOf"===s.kind?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),ht(t,{code:it.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):Ge.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.bigint,received:t.parsedType}),gt}gte(e,t){return this.setLimit("min",e,!0,Tt.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Tt.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Tt.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Tt.toString(t))}setLimit(e,t,n,s){return new sn({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Tt.toString(s)}]})}_addCheck(e){return new sn({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Tt.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Tt.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Tt.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Tt.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Tt.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}sn.create=e=>{var t;return new sn({checks:[],typeName:Vn.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...Et(e)})};class on extends At{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==rt.boolean){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.boolean,received:t.parsedType}),gt}return yt(e.data)}}on.create=e=>new on({typeName:Vn.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...Et(e)});class rn extends At{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==rt.date){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.date,received:t.parsedType}),gt}if(isNaN(e.data.getTime()))return ht(this._getOrReturnCtx(e),{code:it.invalid_date}),gt;const t=new mt;let n;for(const s of this._def.checks)"min"===s.kind?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),t.dirty()):"max"===s.kind?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),ht(n,{code:it.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),t.dirty()):Ge.assertNever(s);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new rn({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Tt.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Tt.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}rn.create=e=>new rn({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Vn.ZodDate,...Et(e)});class an extends At{_parse(e){if(this._getType(e)!==rt.symbol){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.symbol,received:t.parsedType}),gt}return yt(e.data)}}an.create=e=>new an({typeName:Vn.ZodSymbol,...Et(e)});class ln extends At{_parse(e){if(this._getType(e)!==rt.undefined){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.undefined,received:t.parsedType}),gt}return yt(e.data)}}ln.create=e=>new ln({typeName:Vn.ZodUndefined,...Et(e)});class un extends At{_parse(e){if(this._getType(e)!==rt.null){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.null,received:t.parsedType}),gt}return yt(e.data)}}un.create=e=>new un({typeName:Vn.ZodNull,...Et(e)});class cn extends At{constructor(){super(...arguments),this._any=!0}_parse(e){return yt(e.data)}}cn.create=e=>new cn({typeName:Vn.ZodAny,...Et(e)});class dn extends At{constructor(){super(...arguments),this._unknown=!0}_parse(e){return yt(e.data)}}dn.create=e=>new dn({typeName:Vn.ZodUnknown,...Et(e)});class pn extends At{_parse(e){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.never,received:t.parsedType}),gt}}pn.create=e=>new pn({typeName:Vn.ZodNever,...Et(e)});class hn extends At{_parse(e){if(this._getType(e)!==rt.undefined){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.void,received:t.parsedType}),gt}return yt(e.data)}}hn.create=e=>new hn({typeName:Vn.ZodVoid,...Et(e)});class mn extends At{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==rt.array)return ht(t,{code:it.invalid_type,expected:rt.array,received:t.parsedType}),gt;if(null!==s.exactLength){const e=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(e||o)&&(ht(t,{code:e?it.too_big:it.too_small,minimum:o?s.exactLength.value:void 0,maximum:e?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(null!==s.minLength&&t.data.length<s.minLength.value&&(ht(t,{code:it.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),null!==s.maxLength&&t.data.length>s.maxLength.value&&(ht(t,{code:it.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>s.type._parseAsync(new Ct(t,e,t.path,n)))).then(e=>mt.mergeArray(n,e));const o=[...t.data].map((e,n)=>s.type._parseSync(new Ct(t,e,t.path,n)));return mt.mergeArray(n,o)}get element(){return this._def.type}min(e,t){return new mn({...this._def,minLength:{value:e,message:Tt.toString(t)}})}max(e,t){return new mn({...this._def,maxLength:{value:e,message:Tt.toString(t)}})}length(e,t){return new mn({...this._def,exactLength:{value:e,message:Tt.toString(t)}})}nonempty(e){return this.min(1,e)}}function gn(e){if(e instanceof fn){const t={};for(const n in e.shape){const s=e.shape[n];t[n]=Mn.create(gn(s))}return new fn({...e._def,shape:()=>t})}return e instanceof mn?new mn({...e._def,type:gn(e.element)}):e instanceof Mn?Mn.create(gn(e.unwrap())):e instanceof Dn?Dn.create(gn(e.unwrap())):e instanceof xn?xn.create(e.items.map(e=>gn(e))):e}mn.create=(e,t)=>new mn({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Vn.ZodArray,...Et(t)});class fn extends At{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=Ge.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==rt.object){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.object,received:t.parsedType}),gt}const{status:t,ctx:n}=this._processInputParams(e),{shape:s,keys:o}=this._getCached(),r=[];if(!(this._def.catchall instanceof pn&&"strip"===this._def.unknownKeys))for(const e in n.data)o.includes(e)||r.push(e);const a=[];for(const e of o){const t=s[e],o=n.data[e];a.push({key:{status:"valid",value:e},value:t._parse(new Ct(n,o,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof pn){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of r)a.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)r.length>0&&(ht(n,{code:it.unrecognized_keys,keys:r}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of r){const s=n.data[t];a.push({key:{status:"valid",value:t},value:e._parse(new Ct(n,s,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of a){const n=await t.key,s=await t.value;e.push({key:n,value:s,alwaysSet:t.alwaysSet})}return e}).then(e=>mt.mergeObjectSync(t,e)):mt.mergeObjectSync(t,a)}get shape(){return this._def.shape()}strict(e){return Tt.errToObj,new fn({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var s,o,r,a;const i=null!==(r=null===(o=(s=this._def).errorMap)||void 0===o?void 0:o.call(s,t,n).message)&&void 0!==r?r:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(a=Tt.errToObj(e).message)&&void 0!==a?a:i}:{message:i}}}:{}})}strip(){return new fn({...this._def,unknownKeys:"strip"})}passthrough(){return new fn({...this._def,unknownKeys:"passthrough"})}extend(e){return new fn({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new fn({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Vn.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new fn({...this._def,catchall:e})}pick(e){const t={};return Ge.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])}),new fn({...this._def,shape:()=>t})}omit(e){const t={};return Ge.objectKeys(this.shape).forEach(n=>{e[n]||(t[n]=this.shape[n])}),new fn({...this._def,shape:()=>t})}deepPartial(){return gn(this)}partial(e){const t={};return Ge.objectKeys(this.shape).forEach(n=>{const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}),new fn({...this._def,shape:()=>t})}required(e){const t={};return Ge.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Mn;)e=e._def.innerType;t[n]=e}}),new fn({...this._def,shape:()=>t})}keyof(){return En(Ge.objectKeys(this.shape))}}fn.create=(e,t)=>new fn({shape:()=>e,unknownKeys:"strip",catchall:pn.create(),typeName:Vn.ZodObject,...Et(t)}),fn.strictCreate=(e,t)=>new fn({shape:()=>e,unknownKeys:"strict",catchall:pn.create(),typeName:Vn.ZodObject,...Et(t)}),fn.lazycreate=(e,t)=>new fn({shape:e,unknownKeys:"strip",catchall:pn.create(),typeName:Vn.ZodObject,...Et(t)});class yn extends At{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new lt(e.ctx.common.issues));return ht(t,{code:it.invalid_union,unionErrors:n}),gt});{let e;const s=[];for(const o of n){const n={...t,common:{...t.common,issues:[]},parent:null},r=o._parseSync({data:t.data,path:t.path,parent:n});if("valid"===r.status)return r;"dirty"!==r.status||e||(e={result:r,ctx:n}),n.common.issues.length&&s.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const o=s.map(e=>new lt(e));return ht(t,{code:it.invalid_union,unionErrors:o}),gt}}get options(){return this._def.options}}yn.create=(e,t)=>new yn({options:e,typeName:Vn.ZodUnion,...Et(t)});const bn=e=>e instanceof Cn?bn(e.schema):e instanceof Rn?bn(e.innerType()):e instanceof Sn?[e.value]:e instanceof An?e.options:e instanceof On?Ge.objectValues(e.enum):e instanceof $n?bn(e._def.innerType):e instanceof ln?[void 0]:e instanceof un?[null]:e instanceof Mn?[void 0,...bn(e.unwrap())]:e instanceof Dn?[null,...bn(e.unwrap())]:e instanceof Ln||e instanceof Bn?bn(e.unwrap()):e instanceof Un?bn(e._def.innerType):[];class vn extends At{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==rt.object)return ht(t,{code:it.invalid_type,expected:rt.object,received:t.parsedType}),gt;const n=this.discriminator,s=t.data[n],o=this.optionsMap.get(s);return o?t.common.async?o._parseAsync({data:t.data,path:t.path,parent:t}):o._parseSync({data:t.data,path:t.path,parent:t}):(ht(t,{code:it.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),gt)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const s=new Map;for(const n of t){const t=bn(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of t){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,n)}}return new vn({typeName:Vn.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...Et(n)})}}function wn(e,t){const n=at(e),s=at(t);if(e===t)return{valid:!0,data:e};if(n===rt.object&&s===rt.object){const n=Ge.objectKeys(t),s=Ge.objectKeys(e).filter(e=>-1!==n.indexOf(e)),o={...e,...t};for(const n of s){const s=wn(e[n],t[n]);if(!s.valid)return{valid:!1};o[n]=s.data}return{valid:!0,data:o}}if(n===rt.array&&s===rt.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let s=0;s<e.length;s++){const o=wn(e[s],t[s]);if(!o.valid)return{valid:!1};n.push(o.data)}return{valid:!0,data:n}}return n===rt.date&&s===rt.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}class _n extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(e,s)=>{if(bt(e)||bt(s))return gt;const o=wn(e.value,s.value);return o.valid?((vt(e)||vt(s))&&t.dirty(),{status:t.value,value:o.data}):(ht(n,{code:it.invalid_intersection_types}),gt)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}_n.create=(e,t,n)=>new _n({left:e,right:t,typeName:Vn.ZodIntersection,...Et(n)});class xn extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==rt.array)return ht(n,{code:it.invalid_type,expected:rt.array,received:n.parsedType}),gt;if(n.data.length<this._def.items.length)return ht(n,{code:it.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),gt;!this._def.rest&&n.data.length>this._def.items.length&&(ht(n,{code:it.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((e,t)=>{const s=this._def.items[t]||this._def.rest;return s?s._parse(new Ct(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(s).then(e=>mt.mergeArray(t,e)):mt.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new xn({...this._def,rest:e})}}xn.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new xn({items:e,typeName:Vn.ZodTuple,rest:null,...Et(t)})};class kn extends At{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==rt.object)return ht(n,{code:it.invalid_type,expected:rt.object,received:n.parsedType}),gt;const s=[],o=this._def.keyType,r=this._def.valueType;for(const e in n.data)s.push({key:o._parse(new Ct(n,e,n.path,e)),value:r._parse(new Ct(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?mt.mergeObjectAsync(t,s):mt.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,n){return new kn(t instanceof At?{keyType:e,valueType:t,typeName:Vn.ZodRecord,...Et(n)}:{keyType:en.create(),valueType:e,typeName:Vn.ZodRecord,...Et(t)})}}class Tn extends At{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==rt.map)return ht(n,{code:it.invalid_type,expected:rt.map,received:n.parsedType}),gt;const s=this._def.keyType,o=this._def.valueType,r=[...n.data.entries()].map(([e,t],r)=>({key:s._parse(new Ct(n,e,n.path,[r,"key"])),value:o._parse(new Ct(n,t,n.path,[r,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of r){const s=await n.key,o=await n.value;if("aborted"===s.status||"aborted"===o.status)return gt;"dirty"!==s.status&&"dirty"!==o.status||t.dirty(),e.set(s.value,o.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of r){const s=n.key,o=n.value;if("aborted"===s.status||"aborted"===o.status)return gt;"dirty"!==s.status&&"dirty"!==o.status||t.dirty(),e.set(s.value,o.value)}return{status:t.value,value:e}}}}Tn.create=(e,t,n)=>new Tn({valueType:t,keyType:e,typeName:Vn.ZodMap,...Et(n)});class Nn extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==rt.set)return ht(n,{code:it.invalid_type,expected:rt.set,received:n.parsedType}),gt;const s=this._def;null!==s.minSize&&n.data.size<s.minSize.value&&(ht(n,{code:it.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),null!==s.maxSize&&n.data.size>s.maxSize.value&&(ht(n,{code:it.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const o=this._def.valueType;function r(e){const n=new Set;for(const s of e){if("aborted"===s.status)return gt;"dirty"===s.status&&t.dirty(),n.add(s.value)}return{status:t.value,value:n}}const a=[...n.data.values()].map((e,t)=>o._parse(new Ct(n,e,n.path,t)));return n.common.async?Promise.all(a).then(e=>r(e)):r(a)}min(e,t){return new Nn({...this._def,minSize:{value:e,message:Tt.toString(t)}})}max(e,t){return new Nn({...this._def,maxSize:{value:e,message:Tt.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Nn.create=(e,t)=>new Nn({valueType:e,minSize:null,maxSize:null,typeName:Vn.ZodSet,...Et(t)});class In extends At{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==rt.function)return ht(t,{code:it.invalid_type,expected:rt.function,received:t.parsedType}),gt;function n(e,n){return pt({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,dt(),ut].filter(e=>!!e),issueData:{code:it.invalid_arguments,argumentsError:n}})}function s(e,n){return pt({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,dt(),ut].filter(e=>!!e),issueData:{code:it.invalid_return_type,returnTypeError:n}})}const o={errorMap:t.common.contextualErrorMap},r=t.data;if(this._def.returns instanceof jn){const e=this;return yt(async function(...t){const a=new lt([]),i=await e._def.args.parseAsync(t,o).catch(e=>{throw a.addIssue(n(t,e)),a}),l=await Reflect.apply(r,this,i);return await e._def.returns._def.type.parseAsync(l,o).catch(e=>{throw a.addIssue(s(l,e)),a})})}{const e=this;return yt(function(...t){const a=e._def.args.safeParse(t,o);if(!a.success)throw new lt([n(t,a.error)]);const i=Reflect.apply(r,this,a.data),l=e._def.returns.safeParse(i,o);if(!l.success)throw new lt([s(i,l.error)]);return l.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new In({...this._def,args:xn.create(e).rest(dn.create())})}returns(e){return new In({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new In({args:e||xn.create([]).rest(dn.create()),returns:t||dn.create(),typeName:Vn.ZodFunction,...Et(n)})}}class Cn extends At{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Cn.create=(e,t)=>new Cn({getter:e,typeName:Vn.ZodLazy,...Et(t)});class Sn extends At{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return ht(t,{received:t.data,code:it.invalid_literal,expected:this._def.value}),gt}return{status:"valid",value:e.data}}get value(){return this._def.value}}function En(e,t){return new An({values:e,typeName:Vn.ZodEnum,...Et(t)})}Sn.create=(e,t)=>new Sn({value:e,typeName:Vn.ZodLiteral,...Et(t)});class An extends At{constructor(){super(...arguments),Nt.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return ht(t,{expected:Ge.joinValues(n),received:t.parsedType,code:it.invalid_type}),gt}if(xt(this,Nt)||kt(this,Nt,new Set(this._def.values)),!xt(this,Nt).has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return ht(t,{received:t.data,code:it.invalid_enum_value,options:n}),gt}return yt(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return An.create(e,{...this._def,...t})}exclude(e,t=this._def){return An.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Nt=new WeakMap,An.create=En;class On extends At{constructor(){super(...arguments),It.set(this,void 0)}_parse(e){const t=Ge.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==rt.string&&n.parsedType!==rt.number){const e=Ge.objectValues(t);return ht(n,{expected:Ge.joinValues(e),received:n.parsedType,code:it.invalid_type}),gt}if(xt(this,It)||kt(this,It,new Set(Ge.getValidEnumValues(this._def.values))),!xt(this,It).has(e.data)){const e=Ge.objectValues(t);return ht(n,{received:n.data,code:it.invalid_enum_value,options:e}),gt}return yt(e.data)}get enum(){return this._def.values}}It=new WeakMap,On.create=(e,t)=>new On({values:e,typeName:Vn.ZodNativeEnum,...Et(t)});class jn extends At{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==rt.promise&&!1===t.common.async)return ht(t,{code:it.invalid_type,expected:rt.promise,received:t.parsedType}),gt;const n=t.parsedType===rt.promise?t.data:Promise.resolve(t.data);return yt(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}jn.create=(e,t)=>new jn({type:e,typeName:Vn.ZodPromise,...Et(t)});class Rn extends At{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Vn.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,o={addIssue:e=>{ht(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(o.addIssue=o.addIssue.bind(o),"preprocess"===s.type){const e=s.transform(n.data,o);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return gt;const s=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===s.status?gt:"dirty"===s.status||"dirty"===t.value?ft(s.value):s});{if("aborted"===t.value)return gt;const s=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===s.status?gt:"dirty"===s.status||"dirty"===t.value?ft(s.value):s}}if("refinement"===s.type){const e=e=>{const t=s.refinement(e,o);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===s.status?gt:("dirty"===s.status&&t.dirty(),e(s.value),{status:t.value,value:s.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?gt:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===s.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!wt(e))return e;const r=s.transform(e.value,o);if(r instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:r}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>wt(e)?Promise.resolve(s.transform(e.value,o)).then(e=>({status:t.value,value:e})):e)}Ge.assertNever(s)}}Rn.create=(e,t,n)=>new Rn({schema:e,typeName:Vn.ZodEffects,effect:t,...Et(n)}),Rn.createWithPreprocess=(e,t,n)=>new Rn({schema:t,effect:{type:"preprocess",transform:e},typeName:Vn.ZodEffects,...Et(n)});class Mn extends At{_parse(e){return this._getType(e)===rt.undefined?yt(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Mn.create=(e,t)=>new Mn({innerType:e,typeName:Vn.ZodOptional,...Et(t)});class Dn extends At{_parse(e){return this._getType(e)===rt.null?yt(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Dn.create=(e,t)=>new Dn({innerType:e,typeName:Vn.ZodNullable,...Et(t)});class $n extends At{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===rt.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}$n.create=(e,t)=>new $n({innerType:e,typeName:Vn.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...Et(t)});class Un extends At{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return _t(s)?s.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new lt(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===s.status?s.value:this._def.catchValue({get error(){return new lt(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}Un.create=(e,t)=>new Un({innerType:e,typeName:Vn.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...Et(t)});class Pn extends At{_parse(e){if(this._getType(e)!==rt.nan){const t=this._getOrReturnCtx(e);return ht(t,{code:it.invalid_type,expected:rt.nan,received:t.parsedType}),gt}return{status:"valid",value:e.data}}}Pn.create=e=>new Pn({typeName:Vn.ZodNaN,...Et(e)});const qn=Symbol("zod_brand");class Ln extends At{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Fn extends At{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?gt:"dirty"===e.status?(t.dirty(),ft(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?gt:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Fn({in:e,out:t,typeName:Vn.ZodPipeline})}}class Bn extends At{_parse(e){const t=this._def.innerType._parse(e),n=e=>(wt(e)&&(e.value=Object.freeze(e.value)),e);return _t(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}function Hn(e,t){const n="function"==typeof e?e(t):"string"==typeof e?{message:e}:e;return"string"==typeof n?{message:n}:n}function Zn(e,t={},n){return e?cn.create().superRefine((s,o)=>{var r,a;const i=e(s);if(i instanceof Promise)return i.then(e=>{var r,a;if(!e){const e=Hn(t,s),i=null===(a=null!==(r=e.fatal)&&void 0!==r?r:n)||void 0===a||a;o.addIssue({code:"custom",...e,fatal:i})}});if(!i){const e=Hn(t,s),i=null===(a=null!==(r=e.fatal)&&void 0!==r?r:n)||void 0===a||a;o.addIssue({code:"custom",...e,fatal:i})}}):cn.create()}Bn.create=(e,t)=>new Bn({innerType:e,typeName:Vn.ZodReadonly,...Et(t)});const Wn={object:fn.lazycreate};var Vn;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Vn||(Vn={}));const zn=en.create,Kn=nn.create,Gn=Pn.create,Jn=sn.create,Xn=on.create,Yn=rn.create,Qn=an.create,es=ln.create,ts=un.create,ns=cn.create,ss=dn.create,os=pn.create,rs=hn.create,as=mn.create,is=fn.create,ls=fn.strictCreate,us=yn.create,cs=vn.create,ds=_n.create,ps=xn.create,hs=kn.create,ms=Tn.create,gs=Nn.create,fs=In.create,ys=Cn.create,bs=Sn.create,vs=An.create,ws=On.create,_s=jn.create,xs=Rn.create,ks=Mn.create,Ts=Dn.create,Ns=Rn.createWithPreprocess,Is=Fn.create,Cs={string:e=>en.create({...e,coerce:!0}),number:e=>nn.create({...e,coerce:!0}),boolean:e=>on.create({...e,coerce:!0}),bigint:e=>sn.create({...e,coerce:!0}),date:e=>rn.create({...e,coerce:!0})},Ss=gt;var Es=Object.freeze({__proto__:null,defaultErrorMap:ut,setErrorMap:function(e){ct=e},getErrorMap:dt,makeIssue:pt,EMPTY_PATH:[],addIssueToContext:ht,ParseStatus:mt,INVALID:gt,DIRTY:ft,OK:yt,isAborted:bt,isDirty:vt,isValid:wt,isAsync:_t,get util(){return Ge},get objectUtil(){return Je},ZodParsedType:rt,getParsedType:at,ZodType:At,datetimeRegex:Jt,ZodString:en,ZodNumber:nn,ZodBigInt:sn,ZodBoolean:on,ZodDate:rn,ZodSymbol:an,ZodUndefined:ln,ZodNull:un,ZodAny:cn,ZodUnknown:dn,ZodNever:pn,ZodVoid:hn,ZodArray:mn,ZodObject:fn,ZodUnion:yn,ZodDiscriminatedUnion:vn,ZodIntersection:_n,ZodTuple:xn,ZodRecord:kn,ZodMap:Tn,ZodSet:Nn,ZodFunction:In,ZodLazy:Cn,ZodLiteral:Sn,ZodEnum:An,ZodNativeEnum:On,ZodPromise:jn,ZodEffects:Rn,ZodTransformer:Rn,ZodOptional:Mn,ZodNullable:Dn,ZodDefault:$n,ZodCatch:Un,ZodNaN:Pn,BRAND:qn,ZodBranded:Ln,ZodPipeline:Fn,ZodReadonly:Bn,custom:Zn,Schema:At,ZodSchema:At,late:Wn,get ZodFirstPartyTypeKind(){return Vn},coerce:Cs,any:ns,array:as,bigint:Jn,boolean:Xn,date:Yn,discriminatedUnion:cs,effect:xs,enum:vs,function:fs,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Zn(t=>t instanceof e,t),intersection:ds,lazy:ys,literal:bs,map:ms,nan:Gn,nativeEnum:ws,never:os,null:ts,nullable:Ts,number:Kn,object:is,oboolean:()=>Xn().optional(),onumber:()=>Kn().optional(),optional:ks,ostring:()=>zn().optional(),pipeline:Is,preprocess:Ns,promise:_s,record:hs,set:gs,strictObject:ls,string:zn,symbol:Qn,transformer:xs,tuple:ps,undefined:es,union:us,unknown:ss,void:rs,NEVER:Ss,ZodIssueCode:it,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:lt});function As(e){var t,n;return null!=(n=null==(t=null==e?void 0:e.content)?void 0:t.map(({token:e,logprob:t,top_logprobs:n})=>({token:e,logprob:t,topLogprobs:n?n.map(({token:e,logprob:t})=>({token:e,logprob:t})):[]})))?n:void 0}function Os(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var js=Es.object({error:Es.object({message:Es.string(),type:Es.string().nullish(),param:Es.any().nullish(),code:Es.union([Es.string(),Es.number()]).nullish()})}),Rs=Xe({errorSchema:js,errorToMessage:e=>e.error.message});function Ms({id:e,model:t,created:n}){return{id:null!=e?e:void 0,modelId:null!=t?t:void 0,timestamp:null!=n?new Date(1e3*n):void 0}}var Ds=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get supportsStructuredOutputs(){var e;return null!=(e=this.settings.structuredOutputs)?e:qs(this.modelId)}get defaultObjectGenerationMode(){return this.modelId.startsWith("gpt-4o-audio-preview")?"tool":this.supportsStructuredOutputs?"json":"tool"}get provider(){return this.config.provider}get supportsImageUrls(){return!this.settings.downloadImages}getArgs({mode:e,prompt:t,maxTokens:n,temperature:s,topP:o,topK:r,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m,g,f,y,b,v;const w=e.type,_=[];null!=r&&_.push({type:"unsupported-setting",setting:"topK"}),"json"!==(null==u?void 0:u.type)||null==u.schema||this.supportsStructuredOutputs||_.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is only supported with structuredOutputs"});const x=this.settings.useLegacyFunctionCalling;if(x&&!0===this.settings.parallelToolCalls)throw new Ne({functionality:"useLegacyFunctionCalling with parallelToolCalls"});if(x&&this.supportsStructuredOutputs)throw new Ne({functionality:"structuredOutputs with useLegacyFunctionCalling"});const{messages:k,warnings:T}=function({prompt:e,useLegacyFunctionCalling:t=!1,systemMessageMode:n="system"}){const s=[],o=[];for(const{role:r,content:a}of e)switch(r){case"system":switch(n){case"system":s.push({role:"system",content:a});break;case"developer":s.push({role:"developer",content:a});break;case"remove":o.push({type:"other",message:"system messages are removed for this model"});break;default:throw new Error(`Unsupported system message mode: ${n}`)}break;case"user":if(1===a.length&&"text"===a[0].type){s.push({role:"user",content:a[0].text});break}s.push({role:"user",content:a.map((e,t)=>{var n,s,o,r;switch(e.type){case"text":return{type:"text",text:e.text};case"image":return{type:"image_url",image_url:{url:e.image instanceof URL?e.image.toString():`data:${null!=(n=e.mimeType)?n:"image/jpeg"};base64,${st(e.image)}`,detail:null==(o=null==(s=e.providerMetadata)?void 0:s.openai)?void 0:o.imageDetail}};case"file":if(e.data instanceof URL)throw new Ne({functionality:"'File content parts with URL data' functionality not supported."});switch(e.mimeType){case"audio/wav":return{type:"input_audio",input_audio:{data:e.data,format:"wav"}};case"audio/mp3":case"audio/mpeg":return{type:"input_audio",input_audio:{data:e.data,format:"mp3"}};case"application/pdf":return{type:"file",file:{filename:null!=(r=e.filename)?r:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${e.data}`}};default:throw new Ne({functionality:`File content part type ${e.mimeType} in user messages`})}}})});break;case"assistant":{let e="";const n=[];for(const t of a)switch(t.type){case"text":e+=t.text;break;case"tool-call":n.push({id:t.toolCallId,type:"function",function:{name:t.toolName,arguments:JSON.stringify(t.args)}})}if(t){if(n.length>1)throw new Ne({functionality:"useLegacyFunctionCalling with multiple tool calls in one message"});s.push({role:"assistant",content:e,function_call:n.length>0?n[0].function:void 0})}else s.push({role:"assistant",content:e,tool_calls:n.length>0?n:void 0});break}case"tool":for(const e of a)t?s.push({role:"function",name:e.toolName,content:JSON.stringify(e.result)}):s.push({role:"tool",tool_call_id:e.toolCallId,content:JSON.stringify(e.result)});break;default:throw new Error(`Unsupported role: ${r}`)}return{messages:s,warnings:o}}({prompt:t,useLegacyFunctionCalling:x,systemMessageMode:Ls(this.modelId)});_.push(...T);const N={model:this.modelId,logit_bias:this.settings.logitBias,logprobs:!0===this.settings.logprobs||"number"==typeof this.settings.logprobs||void 0,top_logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:n,temperature:s,top_p:o,frequency_penalty:a,presence_penalty:i,response_format:"json"===(null==u?void 0:u.type)?this.supportsStructuredOutputs&&null!=u.schema?{type:"json_schema",json_schema:{schema:u.schema,strict:!0,name:null!=(p=u.name)?p:"response",description:u.description}}:{type:"json_object"}:void 0,stop:l,seed:c,max_completion_tokens:null==(h=null==d?void 0:d.openai)?void 0:h.maxCompletionTokens,store:null==(m=null==d?void 0:d.openai)?void 0:m.store,metadata:null==(g=null==d?void 0:d.openai)?void 0:g.metadata,prediction:null==(f=null==d?void 0:d.openai)?void 0:f.prediction,reasoning_effort:null!=(b=null==(y=null==d?void 0:d.openai)?void 0:y.reasoningEffort)?b:this.settings.reasoningEffort,messages:k};switch(qs(this.modelId)?(null!=N.temperature&&(N.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=N.top_p&&(N.top_p=void 0,_.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"})),null!=N.frequency_penalty&&(N.frequency_penalty=void 0,_.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"frequencyPenalty is not supported for reasoning models"})),null!=N.presence_penalty&&(N.presence_penalty=void 0,_.push({type:"unsupported-setting",setting:"presencePenalty",details:"presencePenalty is not supported for reasoning models"})),null!=N.logit_bias&&(N.logit_bias=void 0,_.push({type:"other",message:"logitBias is not supported for reasoning models"})),null!=N.logprobs&&(N.logprobs=void 0,_.push({type:"other",message:"logprobs is not supported for reasoning models"})),null!=N.top_logprobs&&(N.top_logprobs=void 0,_.push({type:"other",message:"topLogprobs is not supported for reasoning models"})),null!=N.max_tokens&&(null==N.max_completion_tokens&&(N.max_completion_tokens=N.max_tokens),N.max_tokens=void 0)):(this.modelId.startsWith("gpt-4o-search-preview")||this.modelId.startsWith("gpt-4o-mini-search-preview"))&&null!=N.temperature&&(N.temperature=void 0,_.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for the search preview models and has been removed."})),w){case"regular":{const{tools:t,tool_choice:n,functions:s,function_call:o,toolWarnings:r}=function({mode:e,useLegacyFunctionCalling:t=!1,structuredOutputs:n}){var s;const o=(null==(s=e.tools)?void 0:s.length)?e.tools:void 0,r=[];if(null==o)return{tools:void 0,tool_choice:void 0,toolWarnings:r};const a=e.toolChoice;if(t){const e=[];for(const t of o)"provider-defined"===t.type?r.push({type:"unsupported-tool",tool:t}):e.push({name:t.name,description:t.description,parameters:t.parameters});if(null==a)return{functions:e,function_call:void 0,toolWarnings:r};switch(a.type){case"auto":case"none":case void 0:return{functions:e,function_call:void 0,toolWarnings:r};case"required":throw new Ne({functionality:"useLegacyFunctionCalling and toolChoice: required"});default:return{functions:e,function_call:{name:a.toolName},toolWarnings:r}}}const i=[];for(const e of o)"provider-defined"===e.type?r.push({type:"unsupported-tool",tool:e}):i.push({type:"function",function:{name:e.name,description:e.description,parameters:e.parameters,strict:!!n||void 0}});if(null==a)return{tools:i,tool_choice:void 0,toolWarnings:r};const l=a.type;switch(l){case"auto":case"none":case"required":return{tools:i,tool_choice:l,toolWarnings:r};case"tool":return{tools:i,tool_choice:{type:"function",function:{name:a.toolName}},toolWarnings:r};default:throw new Ne({functionality:`Unsupported tool choice type: ${l}`})}}({mode:e,useLegacyFunctionCalling:x,structuredOutputs:this.supportsStructuredOutputs});return{args:{...N,tools:t,tool_choice:n,functions:s,function_call:o},warnings:[..._,...r]}}case"object-json":return{args:{...N,response_format:this.supportsStructuredOutputs&&null!=e.schema?{type:"json_schema",json_schema:{schema:e.schema,strict:!0,name:null!=(v=e.name)?v:"response",description:e.description}}:{type:"json_object"}},warnings:_};case"object-tool":return{args:x?{...N,function_call:{name:e.tool.name},functions:[{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}]}:{...N,tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:!!this.supportsStructuredOutputs||void 0}}]},warnings:_};default:throw new Error(`Unsupported type: ${w}`)}}async doGenerate(e){var t,n,s,o,r,a,i,l;const{args:u,warnings:c}=this.getArgs(e),{responseHeaders:d,value:p,rawValue:h}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:u,failedResponseHandler:Rs,successfulResponseHandler:Qe(Us),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:m,...g}=u,f=p.choices[0],y=null==(t=p.usage)?void 0:t.completion_tokens_details,b=null==(n=p.usage)?void 0:n.prompt_tokens_details,v={openai:{}};return null!=(null==y?void 0:y.reasoning_tokens)&&(v.openai.reasoningTokens=null==y?void 0:y.reasoning_tokens),null!=(null==y?void 0:y.accepted_prediction_tokens)&&(v.openai.acceptedPredictionTokens=null==y?void 0:y.accepted_prediction_tokens),null!=(null==y?void 0:y.rejected_prediction_tokens)&&(v.openai.rejectedPredictionTokens=null==y?void 0:y.rejected_prediction_tokens),null!=(null==b?void 0:b.cached_tokens)&&(v.openai.cachedPromptTokens=null==b?void 0:b.cached_tokens),{text:null!=(s=f.message.content)?s:void 0,toolCalls:this.settings.useLegacyFunctionCalling&&f.message.function_call?[{toolCallType:"function",toolCallId:Me(),toolName:f.message.function_call.name,args:f.message.function_call.arguments}]:null==(o=f.message.tool_calls)?void 0:o.map(e=>{var t;return{toolCallType:"function",toolCallId:null!=(t=e.id)?t:Me(),toolName:e.function.name,args:e.function.arguments}}),finishReason:Os(f.finish_reason),usage:{promptTokens:null!=(a=null==(r=p.usage)?void 0:r.prompt_tokens)?a:NaN,completionTokens:null!=(l=null==(i=p.usage)?void 0:i.completion_tokens)?l:NaN},rawCall:{rawPrompt:m,rawSettings:g},rawResponse:{headers:d,body:h},request:{body:JSON.stringify(u)},response:Ms(p),warnings:c,logprobs:As(f.logprobs),providerMetadata:v}}async doStream(e){if(this.settings.simulateStreaming){const t=await this.doGenerate(e);return{stream:new ReadableStream({start(e){if(e.enqueue({type:"response-metadata",...t.response}),t.text&&e.enqueue({type:"text-delta",textDelta:t.text}),t.toolCalls)for(const n of t.toolCalls)e.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:n.toolCallId,toolName:n.toolName,argsTextDelta:n.args}),e.enqueue({type:"tool-call",...n});e.enqueue({type:"finish",finishReason:t.finishReason,usage:t.usage,logprobs:t.logprobs,providerMetadata:t.providerMetadata}),e.close()}}),rawCall:t.rawCall,rawResponse:t.rawResponse,warnings:t.warnings}}const{args:t,warnings:n}=this.getArgs(e),s={...t,stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0},{responseHeaders:o,value:r}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:s,failedResponseHandler:Rs,successfulResponseHandler:Ye(Ps),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...i}=t,l=[];let u,c="unknown",d={promptTokens:void 0,completionTokens:void 0},p=!0;const{useLegacyFunctionCalling:h}=this.settings,m={openai:{}};return{stream:r.pipeThrough(new TransformStream({transform(e,t){var n,s,o,r,a,i,g,f,y,b,v,w;if(!e.success)return c="error",void t.enqueue({type:"error",error:e.error});const _=e.value;if("error"in _)return c="error",void t.enqueue({type:"error",error:_.error});if(p&&(p=!1,t.enqueue({type:"response-metadata",...Ms(_)})),null!=_.usage){const{prompt_tokens:e,completion_tokens:t,prompt_tokens_details:n,completion_tokens_details:s}=_.usage;d={promptTokens:null!=e?e:void 0,completionTokens:null!=t?t:void 0},null!=(null==s?void 0:s.reasoning_tokens)&&(m.openai.reasoningTokens=null==s?void 0:s.reasoning_tokens),null!=(null==s?void 0:s.accepted_prediction_tokens)&&(m.openai.acceptedPredictionTokens=null==s?void 0:s.accepted_prediction_tokens),null!=(null==s?void 0:s.rejected_prediction_tokens)&&(m.openai.rejectedPredictionTokens=null==s?void 0:s.rejected_prediction_tokens),null!=(null==n?void 0:n.cached_tokens)&&(m.openai.cachedPromptTokens=null==n?void 0:n.cached_tokens)}const x=_.choices[0];if(null!=(null==x?void 0:x.finish_reason)&&(c=Os(x.finish_reason)),null==(null==x?void 0:x.delta))return;const k=x.delta;null!=k.content&&t.enqueue({type:"text-delta",textDelta:k.content});const T=As(null==x?void 0:x.logprobs);(null==T?void 0:T.length)&&(void 0===u&&(u=[]),u.push(...T));const N=h&&null!=k.function_call?[{type:"function",id:Me(),function:k.function_call,index:0}]:k.tool_calls;if(null!=N)for(const e of N){const u=e.index;if(null==l[u]){if("function"!==e.type)throw new Z({data:e,message:"Expected 'function' type."});if(null==e.id)throw new Z({data:e,message:"Expected 'id' to be a string."});if(null==(null==(n=e.function)?void 0:n.name))throw new Z({data:e,message:"Expected 'function.name' to be a string."});l[u]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(s=e.function.arguments)?s:""},hasFinished:!1};const i=l[u];null!=(null==(o=i.function)?void 0:o.name)&&null!=(null==(r=i.function)?void 0:r.arguments)&&(i.function.arguments.length>0&&t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:i.id,toolName:i.function.name,argsTextDelta:i.function.arguments}),He(i.function.arguments)&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(a=i.id)?a:Me(),toolName:i.function.name,args:i.function.arguments}),i.hasFinished=!0));continue}const c=l[u];c.hasFinished||(null!=(null==(i=e.function)?void 0:i.arguments)&&(c.function.arguments+=null!=(f=null==(g=e.function)?void 0:g.arguments)?f:""),t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:c.id,toolName:c.function.name,argsTextDelta:null!=(y=e.function.arguments)?y:""}),null!=(null==(b=c.function)?void 0:b.name)&&null!=(null==(v=c.function)?void 0:v.arguments)&&He(c.function.arguments)&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(w=c.id)?w:Me(),toolName:c.function.name,args:c.function.arguments}),c.hasFinished=!0))}},flush(e){var t,n;e.enqueue({type:"finish",finishReason:c,logprobs:u,usage:{promptTokens:null!=(t=d.promptTokens)?t:NaN,completionTokens:null!=(n=d.completionTokens)?n:NaN},...null!=m?{providerMetadata:m}:{}})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:o},request:{body:JSON.stringify(s)},warnings:n}}},$s=Es.object({prompt_tokens:Es.number().nullish(),completion_tokens:Es.number().nullish(),prompt_tokens_details:Es.object({cached_tokens:Es.number().nullish()}).nullish(),completion_tokens_details:Es.object({reasoning_tokens:Es.number().nullish(),accepted_prediction_tokens:Es.number().nullish(),rejected_prediction_tokens:Es.number().nullish()}).nullish()}).nullish(),Us=Es.object({id:Es.string().nullish(),created:Es.number().nullish(),model:Es.string().nullish(),choices:Es.array(Es.object({message:Es.object({role:Es.literal("assistant").nullish(),content:Es.string().nullish(),function_call:Es.object({arguments:Es.string(),name:Es.string()}).nullish(),tool_calls:Es.array(Es.object({id:Es.string().nullish(),type:Es.literal("function"),function:Es.object({name:Es.string(),arguments:Es.string()})})).nullish()}),index:Es.number(),logprobs:Es.object({content:Es.array(Es.object({token:Es.string(),logprob:Es.number(),top_logprobs:Es.array(Es.object({token:Es.string(),logprob:Es.number()}))})).nullable()}).nullish(),finish_reason:Es.string().nullish()})),usage:$s}),Ps=Es.union([Es.object({id:Es.string().nullish(),created:Es.number().nullish(),model:Es.string().nullish(),choices:Es.array(Es.object({delta:Es.object({role:Es.enum(["assistant"]).nullish(),content:Es.string().nullish(),function_call:Es.object({name:Es.string().optional(),arguments:Es.string().optional()}).nullish(),tool_calls:Es.array(Es.object({index:Es.number(),id:Es.string().nullish(),type:Es.literal("function").nullish(),function:Es.object({name:Es.string().nullish(),arguments:Es.string().nullish()})})).nullish()}).nullish(),logprobs:Es.object({content:Es.array(Es.object({token:Es.string(),logprob:Es.number(),top_logprobs:Es.array(Es.object({token:Es.string(),logprob:Es.number()}))})).nullable()}).nullish(),finish_reason:Es.string().nullish(),index:Es.number()})),usage:$s}),js]);function qs(e){return e.startsWith("o")}function Ls(e){var t,n;return qs(e)?null!=(n=null==(t=Fs[e])?void 0:t.systemMessageMode)?n:"developer":"system"}var Fs={"o1-mini":{systemMessageMode:"remove"},"o1-mini-2024-09-12":{systemMessageMode:"remove"},"o1-preview":{systemMessageMode:"remove"},"o1-preview-2024-09-12":{systemMessageMode:"remove"},o3:{systemMessageMode:"developer"},"o3-2025-04-16":{systemMessageMode:"developer"},"o3-mini":{systemMessageMode:"developer"},"o3-mini-2025-01-31":{systemMessageMode:"developer"},"o4-mini":{systemMessageMode:"developer"},"o4-mini-2025-04-16":{systemMessageMode:"developer"}};function Bs(e){return null==e?void 0:e.tokens.map((t,n)=>({token:t,logprob:e.token_logprobs[n],topLogprobs:e.top_logprobs?Object.entries(e.top_logprobs[n]).map(([e,t])=>({token:e,logprob:t})):[]}))}var Hs=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:t,prompt:n,maxTokens:s,temperature:o,topP:r,topK:a,frequencyPenalty:i,presencePenalty:l,stopSequences:u,responseFormat:c,seed:d}){var p;const h=e.type,m=[];null!=a&&m.push({type:"unsupported-setting",setting:"topK"}),null!=c&&"text"!==c.type&&m.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:g,stopSequences:f}=function({prompt:e,inputFormat:t,user:n="user",assistant:s="assistant"}){if("prompt"===t&&1===e.length&&"user"===e[0].role&&1===e[0].content.length&&"text"===e[0].content[0].type)return{prompt:e[0].content[0].text};let o="";"system"===e[0].role&&(o+=`${e[0].content}\n\n`,e=e.slice(1));for(const{role:t,content:r}of e)switch(t){case"system":throw new q({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":o+=`${n}:\n${r.map(e=>{switch(e.type){case"text":return e.text;case"image":throw new Ne({functionality:"images"})}}).join("")}\n\n`;break;case"assistant":o+=`${s}:\n${r.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new Ne({functionality:"tool-call messages"})}}).join("")}\n\n`;break;case"tool":throw new Ne({functionality:"tool messages"});default:throw new Error(`Unsupported role: ${t}`)}return o+=`${s}:\n`,{prompt:o,stopSequences:[`\n${n}:`]}}({prompt:n,inputFormat:t}),y=[...null!=f?f:[],...null!=u?u:[]],b={model:this.modelId,echo:this.settings.echo,logit_bias:this.settings.logitBias,logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:s,temperature:o,top_p:r,frequency_penalty:i,presence_penalty:l,seed:d,prompt:g,stop:y.length>0?y:void 0};switch(h){case"regular":if(null==(p=e.tools)?void 0:p.length)throw new Ne({functionality:"tools"});if(e.toolChoice)throw new Ne({functionality:"toolChoice"});return{args:b,warnings:m};case"object-json":throw new Ne({functionality:"object-json mode"});case"object-tool":throw new Ne({functionality:"object-tool mode"});default:throw new Error(`Unsupported type: ${h}`)}}async doGenerate(e){const{args:t,warnings:n}=this.getArgs(e),{responseHeaders:s,value:o,rawValue:r}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:t,failedResponseHandler:Rs,successfulResponseHandler:Qe(Zs),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...i}=t,l=o.choices[0];return{text:l.text,usage:{promptTokens:o.usage.prompt_tokens,completionTokens:o.usage.completion_tokens},finishReason:Os(l.finish_reason),logprobs:Bs(l.logprobs),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:s,body:r},response:Ms(o),warnings:n,request:{body:JSON.stringify(t)}}}async doStream(e){const{args:t,warnings:n}=this.getArgs(e),s={...t,stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0},{responseHeaders:o,value:r}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:s,failedResponseHandler:Rs,successfulResponseHandler:Ye(Ws),abortSignal:e.abortSignal,fetch:this.config.fetch}),{prompt:a,...i}=t;let l,u="unknown",c={promptTokens:Number.NaN,completionTokens:Number.NaN},d=!0;return{stream:r.pipeThrough(new TransformStream({transform(e,t){if(!e.success)return u="error",void t.enqueue({type:"error",error:e.error});const n=e.value;if("error"in n)return u="error",void t.enqueue({type:"error",error:n.error});d&&(d=!1,t.enqueue({type:"response-metadata",...Ms(n)})),null!=n.usage&&(c={promptTokens:n.usage.prompt_tokens,completionTokens:n.usage.completion_tokens});const s=n.choices[0];null!=(null==s?void 0:s.finish_reason)&&(u=Os(s.finish_reason)),null!=(null==s?void 0:s.text)&&t.enqueue({type:"text-delta",textDelta:s.text});const o=Bs(null==s?void 0:s.logprobs);(null==o?void 0:o.length)&&(void 0===l&&(l=[]),l.push(...o))},flush(e){e.enqueue({type:"finish",finishReason:u,logprobs:l,usage:c})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:o},warnings:n,request:{body:JSON.stringify(s)}}}},Zs=Es.object({id:Es.string().nullish(),created:Es.number().nullish(),model:Es.string().nullish(),choices:Es.array(Es.object({text:Es.string(),finish_reason:Es.string(),logprobs:Es.object({tokens:Es.array(Es.string()),token_logprobs:Es.array(Es.number()),top_logprobs:Es.array(Es.record(Es.string(),Es.number())).nullable()}).nullish()})),usage:Es.object({prompt_tokens:Es.number(),completion_tokens:Es.number()})}),Ws=Es.union([Es.object({id:Es.string().nullish(),created:Es.number().nullish(),model:Es.string().nullish(),choices:Es.array(Es.object({text:Es.string(),finish_reason:Es.string().nullish(),index:Es.number(),logprobs:Es.object({tokens:Es.array(Es.string()),token_logprobs:Es.array(Es.number()),top_logprobs:Es.array(Es.record(Es.string(),Es.number())).nullable()}).nullish()})),usage:Es.object({prompt_tokens:Es.number(),completion_tokens:Es.number()}).nullish()}),js]),Vs=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return null!=(e=this.settings.maxEmbeddingsPerCall)?e:2048}get supportsParallelCalls(){var e;return null==(e=this.settings.supportsParallelCalls)||e}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new ge({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:s,value:o}=await Ve({url:this.config.url({path:"/embeddings",modelId:this.modelId}),headers:Ae(this.config.headers(),t),body:{model:this.modelId,input:e,encoding_format:"float",dimensions:this.settings.dimensions,user:this.settings.user},failedResponseHandler:Rs,successfulResponseHandler:Qe(zs),abortSignal:n,fetch:this.config.fetch});return{embeddings:o.data.map(e=>e.embedding),usage:o.usage?{tokens:o.usage.prompt_tokens}:void 0,rawResponse:{headers:s}}}},zs=Es.object({data:Es.array(Es.object({embedding:Es.array(Es.number())})),usage:Es.object({prompt_tokens:Es.number()}).nullish()}),Ks={"dall-e-3":1,"dall-e-2":10,"gpt-image-1":10},Gs=new Set(["gpt-image-1"]),Js=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1"}get maxImagesPerCall(){var e,t;return null!=(t=null!=(e=this.settings.maxImagesPerCall)?e:Ks[this.modelId])?t:1}get provider(){return this.config.provider}async doGenerate({prompt:e,n:t,size:n,aspectRatio:s,seed:o,providerOptions:r,headers:a,abortSignal:i}){var l,u,c,d;const p=[];null!=s&&p.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."}),null!=o&&p.push({type:"unsupported-setting",setting:"seed"});const h=null!=(c=null==(u=null==(l=this.config._internal)?void 0:l.currentDate)?void 0:u.call(l))?c:new Date,{value:m,responseHeaders:g}=await Ve({url:this.config.url({path:"/images/generations",modelId:this.modelId}),headers:Ae(this.config.headers(),a),body:{model:this.modelId,prompt:e,n:t,size:n,...null!=(d=r.openai)?d:{},...Gs.has(this.modelId)?{}:{response_format:"b64_json"}},failedResponseHandler:Rs,successfulResponseHandler:Qe(Xs),abortSignal:i,fetch:this.config.fetch});return{images:m.data.map(e=>e.b64_json),warnings:p,response:{timestamp:h,modelId:this.modelId,headers:g}}}},Xs=Es.object({data:Es.array(Es.object({b64_json:Es.string()}))}),Ys=Es.object({include:Es.array(Es.string()).nullish(),language:Es.string().nullish(),prompt:Es.string().nullish(),temperature:Es.number().min(0).max(1).nullish().default(0),timestampGranularities:Es.array(Es.enum(["word","segment"])).nullish().default(["segment"])}),Qs={afrikaans:"af",arabic:"ar",armenian:"hy",azerbaijani:"az",belarusian:"be",bosnian:"bs",bulgarian:"bg",catalan:"ca",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",finnish:"fi",french:"fr",galician:"gl",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",icelandic:"is",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",macedonian:"mk",malay:"ms",marathi:"mr",maori:"mi",nepali:"ne",norwegian:"no",persian:"fa",polish:"pl",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"sr",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",vietnamese:"vi",welsh:"cy"},eo=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v1"}get provider(){return this.config.provider}getArgs({audio:e,mediaType:t,providerOptions:n}){var s,o,r,a,i;const l=Ze({provider:"openai",providerOptions:n,schema:Ys}),u=new FormData,c=e instanceof Uint8Array?new Blob([e]):new Blob([nt(e)]);if(u.append("model",this.modelId),u.append("file",new File([c],"audio",{type:t})),l){const e={include:null!=(s=l.include)?s:void 0,language:null!=(o=l.language)?o:void 0,prompt:null!=(r=l.prompt)?r:void 0,temperature:null!=(a=l.temperature)?a:void 0,timestamp_granularities:null!=(i=l.timestampGranularities)?i:void 0};for(const t in e){const n=e[t];void 0!==n&&u.append(t,String(n))}}return{formData:u,warnings:[]}}async doGenerate(e){var t,n,s,o,r,a;const i=null!=(s=null==(n=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:n.call(t))?s:new Date,{formData:l,warnings:u}=this.getArgs(e),{value:c,responseHeaders:d,rawValue:p}=await(async({url:e,headers:t,formData:n,failedResponseHandler:s,successfulResponseHandler:o,abortSignal:r,fetch:a})=>ze({url:e,headers:t,body:{content:n,values:Object.fromEntries(n.entries())},failedResponseHandler:s,successfulResponseHandler:o,abortSignal:r,fetch:a}))({url:this.config.url({path:"/audio/transcriptions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),formData:l,failedResponseHandler:Rs,successfulResponseHandler:Qe(to),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=null!=c.language&&c.language in Qs?Qs[c.language]:void 0;return{text:c.text,segments:null!=(r=null==(o=c.words)?void 0:o.map(e=>({text:e.word,startSecond:e.start,endSecond:e.end})))?r:[],language:h,durationInSeconds:null!=(a=c.duration)?a:void 0,warnings:u,response:{timestamp:i,modelId:this.modelId,headers:d,body:p}}}},to=Es.object({text:Es.string(),language:Es.string().nullish(),duration:Es.number().nullish(),words:Es.array(Es.object({word:Es.string(),start:Es.number(),end:Es.number()})).nullish()});function no({finishReason:e,hasToolCalls:t}){switch(e){case void 0:case null:return t?"tool-calls":"stop";case"max_output_tokens":return"length";case"content_filter":return"content-filter";default:return t?"tool-calls":"unknown"}}var so=class{constructor(e,t){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsStructuredOutputs=!0,this.modelId=e,this.config=t}get provider(){return this.config.provider}getArgs({mode:e,maxTokens:t,temperature:n,stopSequences:s,topP:o,topK:r,presencePenalty:a,frequencyPenalty:i,seed:l,prompt:u,providerMetadata:c,responseFormat:d}){var p,h,m;const g=[],f=(b=this.modelId).startsWith("o")?b.startsWith("o1-mini")||b.startsWith("o1-preview")?{isReasoningModel:!0,systemMessageMode:"remove",requiredAutoTruncation:!1}:{isReasoningModel:!0,systemMessageMode:"developer",requiredAutoTruncation:!1}:{isReasoningModel:!1,systemMessageMode:"system",requiredAutoTruncation:!1},y=e.type;var b;null!=r&&g.push({type:"unsupported-setting",setting:"topK"}),null!=l&&g.push({type:"unsupported-setting",setting:"seed"}),null!=a&&g.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=i&&g.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=s&&g.push({type:"unsupported-setting",setting:"stopSequences"});const{messages:v,warnings:w}=function({prompt:e,systemMessageMode:t}){const n=[],s=[];for(const{role:o,content:r}of e)switch(o){case"system":switch(t){case"system":n.push({role:"system",content:r});break;case"developer":n.push({role:"developer",content:r});break;case"remove":s.push({type:"other",message:"system messages are removed for this model"});break;default:throw new Error(`Unsupported system message mode: ${t}`)}break;case"user":n.push({role:"user",content:r.map((e,t)=>{var n,s,o,r;switch(e.type){case"text":return{type:"input_text",text:e.text};case"image":return{type:"input_image",image_url:e.image instanceof URL?e.image.toString():`data:${null!=(n=e.mimeType)?n:"image/jpeg"};base64,${st(e.image)}`,detail:null==(o=null==(s=e.providerMetadata)?void 0:s.openai)?void 0:o.imageDetail};case"file":if(e.data instanceof URL)throw new Ne({functionality:"File URLs in user messages"});if("application/pdf"===e.mimeType)return{type:"input_file",filename:null!=(r=e.filename)?r:`part-${t}.pdf`,file_data:`data:application/pdf;base64,${e.data}`};throw new Ne({functionality:"Only PDF files are supported in user messages"})}})});break;case"assistant":for(const e of r)switch(e.type){case"text":n.push({role:"assistant",content:[{type:"output_text",text:e.text}]});break;case"tool-call":n.push({type:"function_call",call_id:e.toolCallId,name:e.toolName,arguments:JSON.stringify(e.args)})}break;case"tool":for(const e of r)n.push({type:"function_call_output",call_id:e.toolCallId,output:JSON.stringify(e.result)});break;default:throw new Error(`Unsupported role: ${o}`)}return{messages:n,warnings:s}}({prompt:u,systemMessageMode:f.systemMessageMode});g.push(...w);const _=Ze({provider:"openai",providerOptions:c,schema:go}),x=null==(p=null==_?void 0:_.strictSchemas)||p,k={model:this.modelId,input:v,temperature:n,top_p:o,max_output_tokens:t,..."json"===(null==d?void 0:d.type)&&{text:{format:null!=d.schema?{type:"json_schema",strict:x,name:null!=(h=d.name)?h:"response",description:d.description,schema:d.schema}:{type:"json_object"}}},metadata:null==_?void 0:_.metadata,parallel_tool_calls:null==_?void 0:_.parallelToolCalls,previous_response_id:null==_?void 0:_.previousResponseId,store:null==_?void 0:_.store,user:null==_?void 0:_.user,instructions:null==_?void 0:_.instructions,...f.isReasoningModel&&(null!=(null==_?void 0:_.reasoningEffort)||null!=(null==_?void 0:_.reasoningSummary))&&{reasoning:{...null!=(null==_?void 0:_.reasoningEffort)&&{effort:_.reasoningEffort},...null!=(null==_?void 0:_.reasoningSummary)&&{summary:_.reasoningSummary}}},...f.requiredAutoTruncation&&{truncation:"auto"}};switch(f.isReasoningModel&&(null!=k.temperature&&(k.temperature=void 0,g.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported for reasoning models"})),null!=k.top_p&&(k.top_p=void 0,g.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported for reasoning models"}))),y){case"regular":{const{tools:t,tool_choice:n,toolWarnings:s}=function({mode:e,strict:t}){var n;const s=(null==(n=e.tools)?void 0:n.length)?e.tools:void 0,o=[];if(null==s)return{tools:void 0,tool_choice:void 0,toolWarnings:o};const r=e.toolChoice,a=[];for(const e of s)switch(e.type){case"function":a.push({type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:!!t||void 0});break;case"provider-defined":"openai.web_search_preview"===e.id?a.push({type:"web_search_preview",search_context_size:e.args.searchContextSize,user_location:e.args.userLocation}):o.push({type:"unsupported-tool",tool:e});break;default:o.push({type:"unsupported-tool",tool:e})}if(null==r)return{tools:a,tool_choice:void 0,toolWarnings:o};const i=r.type;switch(i){case"auto":case"none":case"required":return{tools:a,tool_choice:i,toolWarnings:o};case"tool":return"web_search_preview"===r.toolName?{tools:a,tool_choice:{type:"web_search_preview"},toolWarnings:o}:{tools:a,tool_choice:{type:"function",name:r.toolName},toolWarnings:o};default:throw new Ne({functionality:`Unsupported tool choice type: ${i}`})}}({mode:e,strict:x});return{args:{...k,tools:t,tool_choice:n},warnings:[...g,...s]}}case"object-json":return{args:{...k,text:{format:null!=e.schema?{type:"json_schema",strict:x,name:null!=(m=e.name)?m:"response",description:e.description,schema:e.schema}:{type:"json_object"}}},warnings:g};case"object-tool":return{args:{...k,tool_choice:{type:"function",name:e.tool.name},tools:[{type:"function",name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters,strict:x}]},warnings:g};default:throw new Error(`Unsupported type: ${y}`)}}async doGenerate(e){var t,n,s,o,r,a,i;const{args:l,warnings:u}=this.getArgs(e),{responseHeaders:c,value:d,rawValue:p}=await Ve({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:l,failedResponseHandler:Rs,successfulResponseHandler:Qe(Es.object({id:Es.string(),created_at:Es.number(),model:Es.string(),output:Es.array(Es.discriminatedUnion("type",[Es.object({type:Es.literal("message"),role:Es.literal("assistant"),content:Es.array(Es.object({type:Es.literal("output_text"),text:Es.string(),annotations:Es.array(Es.object({type:Es.literal("url_citation"),start_index:Es.number(),end_index:Es.number(),url:Es.string(),title:Es.string()}))}))}),Es.object({type:Es.literal("function_call"),call_id:Es.string(),name:Es.string(),arguments:Es.string()}),Es.object({type:Es.literal("web_search_call")}),Es.object({type:Es.literal("computer_call")}),Es.object({type:Es.literal("reasoning"),summary:Es.array(Es.object({type:Es.literal("summary_text"),text:Es.string()}))})])),incomplete_details:Es.object({reason:Es.string()}).nullable(),usage:oo})),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=d.output.filter(e=>"message"===e.type).flatMap(e=>e.content).filter(e=>"output_text"===e.type),m=d.output.filter(e=>"function_call"===e.type).map(e=>({toolCallType:"function",toolCallId:e.call_id,toolName:e.name,args:e.arguments})),g=null!=(n=null==(t=d.output.find(e=>"reasoning"===e.type))?void 0:t.summary)?n:null;return{text:h.map(e=>e.text).join("\n"),sources:h.flatMap(e=>e.annotations.map(e=>{var t,n,s;return{sourceType:"url",id:null!=(s=null==(n=(t=this.config).generateId)?void 0:n.call(t))?s:Me(),url:e.url,title:e.title}})),finishReason:no({finishReason:null==(s=d.incomplete_details)?void 0:s.reason,hasToolCalls:m.length>0}),toolCalls:m.length>0?m:void 0,reasoning:g?g.map(e=>({type:"text",text:e.text})):void 0,usage:{promptTokens:d.usage.input_tokens,completionTokens:d.usage.output_tokens},rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:c,body:p},request:{body:JSON.stringify(l)},response:{id:d.id,timestamp:new Date(1e3*d.created_at),modelId:d.model},providerMetadata:{openai:{responseId:d.id,cachedPromptTokens:null!=(r=null==(o=d.usage.input_tokens_details)?void 0:o.cached_tokens)?r:null,reasoningTokens:null!=(i=null==(a=d.usage.output_tokens_details)?void 0:a.reasoning_tokens)?i:null}},warnings:u}}async doStream(e){const{args:t,warnings:n}=this.getArgs(e),{responseHeaders:s,value:o}=await Ve({url:this.config.url({path:"/responses",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:{...t,stream:!0},failedResponseHandler:Rs,successfulResponseHandler:Ye(mo),abortSignal:e.abortSignal,fetch:this.config.fetch}),r=this;let a="unknown",i=NaN,l=NaN,u=null,c=null,d=null;const p={};let h=!1;return{stream:o.pipeThrough(new TransformStream({transform(e,t){var n,s,o,m,g,f,y,b;if(!e.success)return a="error",void t.enqueue({type:"error",error:e.error});const v=e.value;if(function(e){return"response.output_item.added"===e.type}(v))"function_call"===v.item.type&&(p[v.output_index]={toolName:v.item.name,toolCallId:v.item.call_id},t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:v.item.call_id,toolName:v.item.name,argsTextDelta:v.item.arguments}));else if(function(e){return"response.function_call_arguments.delta"===e.type}(v)){const e=p[v.output_index];null!=e&&t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:v.delta})}else!function(e){return"response.created"===e.type}(v)?function(e){return"response.output_text.delta"===e.type}(v)?t.enqueue({type:"text-delta",textDelta:v.delta}):function(e){return"response.reasoning_summary_text.delta"===e.type}(v)?t.enqueue({type:"reasoning",textDelta:v.delta}):function(e){return"response.output_item.done"===e.type}(v)&&"function_call"===v.item.type?(p[v.output_index]=void 0,h=!0,t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:v.item.call_id,toolName:v.item.name,args:v.item.arguments})):function(e){return"response.completed"===e.type||"response.incomplete"===e.type}(v)?(a=no({finishReason:null==(n=v.response.incomplete_details)?void 0:n.reason,hasToolCalls:h}),i=v.response.usage.input_tokens,l=v.response.usage.output_tokens,u=null!=(o=null==(s=v.response.usage.input_tokens_details)?void 0:s.cached_tokens)?o:u,c=null!=(g=null==(m=v.response.usage.output_tokens_details)?void 0:m.reasoning_tokens)?g:c):function(e){return"response.output_text.annotation.added"===e.type}(v)&&t.enqueue({type:"source",source:{sourceType:"url",id:null!=(b=null==(y=(f=r.config).generateId)?void 0:y.call(f))?b:Me(),url:v.annotation.url,title:v.annotation.title}}):(d=v.response.id,t.enqueue({type:"response-metadata",id:v.response.id,timestamp:new Date(1e3*v.response.created_at),modelId:v.response.model}))},flush(e){e.enqueue({type:"finish",finishReason:a,usage:{promptTokens:i,completionTokens:l},...(null!=u||null!=c)&&{providerMetadata:{openai:{responseId:d,cachedPromptTokens:u,reasoningTokens:c}}}})}})),rawCall:{rawPrompt:void 0,rawSettings:{}},rawResponse:{headers:s},request:{body:JSON.stringify(t)},warnings:n}}},oo=Es.object({input_tokens:Es.number(),input_tokens_details:Es.object({cached_tokens:Es.number().nullish()}).nullish(),output_tokens:Es.number(),output_tokens_details:Es.object({reasoning_tokens:Es.number().nullish()}).nullish()}),ro=Es.object({type:Es.literal("response.output_text.delta"),delta:Es.string()}),ao=Es.object({type:Es.enum(["response.completed","response.incomplete"]),response:Es.object({incomplete_details:Es.object({reason:Es.string()}).nullish(),usage:oo})}),io=Es.object({type:Es.literal("response.created"),response:Es.object({id:Es.string(),created_at:Es.number(),model:Es.string()})}),lo=Es.object({type:Es.literal("response.output_item.done"),output_index:Es.number(),item:Es.discriminatedUnion("type",[Es.object({type:Es.literal("message")}),Es.object({type:Es.literal("function_call"),id:Es.string(),call_id:Es.string(),name:Es.string(),arguments:Es.string(),status:Es.literal("completed")})])}),uo=Es.object({type:Es.literal("response.function_call_arguments.delta"),item_id:Es.string(),output_index:Es.number(),delta:Es.string()}),co=Es.object({type:Es.literal("response.output_item.added"),output_index:Es.number(),item:Es.discriminatedUnion("type",[Es.object({type:Es.literal("message")}),Es.object({type:Es.literal("function_call"),id:Es.string(),call_id:Es.string(),name:Es.string(),arguments:Es.string()})])}),po=Es.object({type:Es.literal("response.output_text.annotation.added"),annotation:Es.object({type:Es.literal("url_citation"),url:Es.string(),title:Es.string()})}),ho=Es.object({type:Es.literal("response.reasoning_summary_text.delta"),item_id:Es.string(),output_index:Es.number(),summary_index:Es.number(),delta:Es.string()}),mo=Es.union([ro,ao,io,lo,uo,co,po,ho,Es.object({type:Es.string()}).passthrough()]),go=Es.object({metadata:Es.any().nullish(),parallelToolCalls:Es.boolean().nullish(),previousResponseId:Es.string().nullish(),store:Es.boolean().nullish(),user:Es.string().nullish(),reasoningEffort:Es.string().nullish(),strictSchemas:Es.boolean().nullish(),instructions:Es.string().nullish(),reasoningSummary:Es.string().nullish()}),fo=Es.object({}),yo={webSearchPreview:function({searchContextSize:e,userLocation:t}={}){return{type:"provider-defined",id:"openai.web_search_preview",args:{searchContextSize:e,userLocation:t},parameters:fo}}},bo=Es.object({instructions:Es.string().nullish(),speed:Es.number().min(.25).max(4).default(1).nullish()}),vo=class{constructor(e,t){this.modelId=e,this.config=t,this.specificationVersion="v1"}get provider(){return this.config.provider}getArgs({text:e,voice:t="alloy",outputFormat:n="mp3",speed:s,instructions:o,providerOptions:r}){const a=[],i=Ze({provider:"openai",providerOptions:r,schema:bo}),l={model:this.modelId,input:e,voice:t,response_format:"mp3",speed:s,instructions:o};if(n&&(["mp3","opus","aac","flac","wav","pcm"].includes(n)?l.response_format=n:a.push({type:"unsupported-setting",setting:"outputFormat",details:`Unsupported output format: ${n}. Using mp3 instead.`})),i){const e={};for(const t in e){const n=e[t];void 0!==n&&(l[t]=n)}}return{requestBody:l,warnings:a}}async doGenerate(e){var t,n,s;const o=null!=(s=null==(n=null==(t=this.config._internal)?void 0:t.currentDate)?void 0:n.call(t))?s:new Date,{requestBody:r,warnings:a}=this.getArgs(e),{value:i,responseHeaders:l,rawValue:u}=await Ve({url:this.config.url({path:"/audio/speech",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:r,failedResponseHandler:Rs,successfulResponseHandler:async({response:e,url:t,requestBodyValues:n})=>{const s=je(e);if(!e.body)throw new k({message:"Response body is empty",url:t,requestBodyValues:n,statusCode:e.status,responseHeaders:s,responseBody:void 0});try{const t=await e.arrayBuffer();return{responseHeaders:s,value:new Uint8Array(t)}}catch(o){throw new k({message:"Failed to read response as array buffer",url:t,requestBodyValues:n,statusCode:e.status,responseHeaders:s,responseBody:void 0,cause:o})}},abortSignal:e.abortSignal,fetch:this.config.fetch});return{audio:i,warnings:a,request:{body:JSON.stringify(r)},response:{timestamp:o,modelId:this.modelId,headers:l,body:u}}}};function wo(e={}){var t,n,s;const o=null!=(t=ot(e.baseURL))?t:"https://api.openai.com/v1",r=null!=(n=e.compatibility)?n:"compatible",a=null!=(s=e.name)?s:"openai",i=()=>({Authorization:`Bearer ${Ue({apiKey:e.apiKey,environmentVariableName:"OPENAI_API_KEY",description:"OpenAI"})}`,"OpenAI-Organization":e.organization,"OpenAI-Project":e.project,...e.headers}),l=(t,n={})=>new Ds(t,n,{provider:`${a}.chat`,url:({path:e})=>`${o}${e}`,headers:i,compatibility:r,fetch:e.fetch}),u=(t,n={})=>new Hs(t,n,{provider:`${a}.completion`,url:({path:e})=>`${o}${e}`,headers:i,compatibility:r,fetch:e.fetch}),c=(t,n={})=>new Vs(t,n,{provider:`${a}.embedding`,url:({path:e})=>`${o}${e}`,headers:i,fetch:e.fetch}),d=(t,n={})=>new Js(t,n,{provider:`${a}.image`,url:({path:e})=>`${o}${e}`,headers:i,fetch:e.fetch}),p=t=>new eo(t,{provider:`${a}.transcription`,url:({path:e})=>`${o}${e}`,headers:i,fetch:e.fetch}),h=t=>new vo(t,{provider:`${a}.speech`,url:({path:e})=>`${o}${e}`,headers:i,fetch:e.fetch}),m=(e,t)=>{if(new.target)throw new Error("The OpenAI model function cannot be called with the new keyword.");return"gpt-3.5-turbo-instruct"===e?u(e,t):l(e,t)},g=function(e,t){return m(e,t)};return g.languageModel=m,g.chat=l,g.completion=u,g.responses=t=>new so(t,{provider:`${a}.responses`,url:({path:e})=>`${o}${e}`,headers:i,fetch:e.fetch}),g.embedding=c,g.textEmbedding=c,g.textEmbeddingModel=c,g.image=d,g.imageModel=d,g.transcription=p,g.transcriptionModel=p,g.speech=h,g.speechModel=h,g.tools=yo,g}wo({compatibility:"strict"});var _o=Es.object({type:Es.literal("error"),error:Es.object({type:Es.string(),message:Es.string()})}),xo=Xe({errorSchema:_o,errorToMessage:e=>e.error.message});function ko(e){switch(e){case"end_turn":case"stop_sequence":return"stop";case"tool_use":return"tool-calls";case"max_tokens":return"length";default:return"unknown"}}var To=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="tool",this.modelId=e,this.settings=t,this.config=n}supportsUrl(e){return"https:"===e.protocol}get provider(){return this.config.provider}get supportsImageUrls(){return this.config.supportsImageUrls}async getArgs({mode:e,prompt:t,maxTokens:n=4096,temperature:s,topP:o,topK:r,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m;const g=e.type,f=[];null!=a&&f.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&f.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=c&&f.push({type:"unsupported-setting",setting:"seed"}),null!=u&&"text"!==u.type&&f.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{prompt:y,betas:b}=function({prompt:e,sendReasoning:t,warnings:n}){var s,o,r,a;const i=new Set,l=function(e){const t=[];let n;for(const s of e){const{role:e}=s;switch(e){case"system":"system"!==(null==n?void 0:n.type)&&(n={type:"system",messages:[]},t.push(n)),n.messages.push(s);break;case"assistant":"assistant"!==(null==n?void 0:n.type)&&(n={type:"assistant",messages:[]},t.push(n)),n.messages.push(s);break;case"user":case"tool":"user"!==(null==n?void 0:n.type)&&(n={type:"user",messages:[]},t.push(n)),n.messages.push(s);break;default:throw new Error(`Unsupported role: ${e}`)}}return t}(e);let u;const c=[];function d(e){var t;const n=null==e?void 0:e.anthropic;return null!=(t=null==n?void 0:n.cacheControl)?t:null==n?void 0:n.cache_control}for(let e=0;e<l.length;e++){const p=l[e],h=e===l.length-1,m=p.type;switch(m){case"system":if(null!=u)throw new Ne({functionality:"Multiple system messages that are separated by user/assistant messages"});u=p.messages.map(({content:e,providerMetadata:t})=>({type:"text",text:e,cache_control:d(t)}));break;case"user":{const e=[];for(const t of p.messages){const{role:n,content:a}=t;switch(n){case"user":for(let n=0;n<a.length;n++){const r=a[n],l=n===a.length-1,u=null!=(s=d(r.providerMetadata))?s:l?d(t.providerMetadata):void 0;switch(r.type){case"text":e.push({type:"text",text:r.text,cache_control:u});break;case"image":e.push({type:"image",source:r.image instanceof URL?{type:"url",url:r.image.toString()}:{type:"base64",media_type:null!=(o=r.mimeType)?o:"image/jpeg",data:st(r.image)},cache_control:u});break;case"file":if("application/pdf"!==r.mimeType)throw new Ne({functionality:"Non-PDF files in user messages"});i.add("pdfs-2024-09-25"),e.push({type:"document",source:r.data instanceof URL?{type:"url",url:r.data.toString()}:{type:"base64",media_type:"application/pdf",data:r.data},cache_control:u})}}break;case"tool":for(let n=0;n<a.length;n++){const s=a[n],o=n===a.length-1,i=null!=(r=d(s.providerMetadata))?r:o?d(t.providerMetadata):void 0,l=null!=s.content?s.content.map(e=>{var t;switch(e.type){case"text":return{type:"text",text:e.text,cache_control:void 0};case"image":return{type:"image",source:{type:"base64",media_type:null!=(t=e.mimeType)?t:"image/jpeg",data:e.data},cache_control:void 0}}}):JSON.stringify(s.result);e.push({type:"tool_result",tool_use_id:s.toolCallId,content:l,is_error:s.isError,cache_control:i})}break;default:throw new Error(`Unsupported role: ${n}`)}}c.push({role:"user",content:e});break}case"assistant":{const e=[];for(let s=0;s<p.messages.length;s++){const o=p.messages[s],r=s===p.messages.length-1,{content:i}=o;for(let s=0;s<i.length;s++){const l=i[s],u=s===i.length-1,c=null!=(a=d(l.providerMetadata))?a:u?d(o.providerMetadata):void 0;switch(l.type){case"text":e.push({type:"text",text:h&&r&&u?l.text.trim():l.text,cache_control:c});break;case"reasoning":t?e.push({type:"thinking",thinking:l.text,signature:l.signature,cache_control:c}):n.push({type:"other",message:"sending reasoning content is disabled for this model"});break;case"redacted-reasoning":e.push({type:"redacted_thinking",data:l.data,cache_control:c});break;case"tool-call":e.push({type:"tool_use",id:l.toolCallId,name:l.toolName,input:l.args,cache_control:c})}}}c.push({role:"assistant",content:e});break}default:throw new Error(`Unsupported type: ${m}`)}}return{prompt:{system:u,messages:c},betas:i}}({prompt:t,sendReasoning:null==(p=this.settings.sendReasoning)||p,warnings:f}),v=Ze({provider:"anthropic",providerOptions:d,schema:Co}),w="enabled"===(null==(h=null==v?void 0:v.thinking)?void 0:h.type),_=null==(m=null==v?void 0:v.thinking)?void 0:m.budgetTokens,x={model:this.modelId,max_tokens:n,temperature:s,top_k:r,top_p:o,stop_sequences:l,...w&&{thinking:{type:"enabled",budget_tokens:_}},system:y.system,messages:y.messages};if(w){if(null==_)throw new Ne({functionality:"thinking requires a budget"});null!=x.temperature&&(x.temperature=void 0,f.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported when thinking is enabled"})),null!=r&&(x.top_k=void 0,f.push({type:"unsupported-setting",setting:"topK",details:"topK is not supported when thinking is enabled"})),null!=o&&(x.top_p=void 0,f.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported when thinking is enabled"})),x.max_tokens=n+_}switch(g){case"regular":{const{tools:t,tool_choice:n,toolWarnings:s,betas:o}=function(e){var t;const n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0,s=[],o=new Set;if(null==n)return{tools:void 0,tool_choice:void 0,toolWarnings:s,betas:o};const r=[];for(const e of n)switch(e.type){case"function":r.push({name:e.name,description:e.description,input_schema:e.parameters});break;case"provider-defined":switch(e.id){case"anthropic.computer_20250124":o.add("computer-use-2025-01-24"),r.push({name:e.name,type:"computer_20250124",display_width_px:e.args.displayWidthPx,display_height_px:e.args.displayHeightPx,display_number:e.args.displayNumber});break;case"anthropic.computer_20241022":o.add("computer-use-2024-10-22"),r.push({name:e.name,type:"computer_20241022",display_width_px:e.args.displayWidthPx,display_height_px:e.args.displayHeightPx,display_number:e.args.displayNumber});break;case"anthropic.text_editor_20250124":o.add("computer-use-2025-01-24"),r.push({name:e.name,type:"text_editor_20250124"});break;case"anthropic.text_editor_20241022":o.add("computer-use-2024-10-22"),r.push({name:e.name,type:"text_editor_20241022"});break;case"anthropic.bash_20250124":o.add("computer-use-2025-01-24"),r.push({name:e.name,type:"bash_20250124"});break;case"anthropic.bash_20241022":o.add("computer-use-2024-10-22"),r.push({name:e.name,type:"bash_20241022"});break;default:s.push({type:"unsupported-tool",tool:e})}break;default:s.push({type:"unsupported-tool",tool:e})}const a=e.toolChoice;if(null==a)return{tools:r,tool_choice:void 0,toolWarnings:s,betas:o};const i=a.type;switch(i){case"auto":return{tools:r,tool_choice:{type:"auto"},toolWarnings:s,betas:o};case"required":return{tools:r,tool_choice:{type:"any"},toolWarnings:s,betas:o};case"none":return{tools:void 0,tool_choice:void 0,toolWarnings:s,betas:o};case"tool":return{tools:r,tool_choice:{type:"tool",name:a.toolName},toolWarnings:s,betas:o};default:throw new Ne({functionality:`Unsupported tool choice type: ${i}`})}}(e);return{args:{...x,tools:t,tool_choice:n},warnings:[...f,...s],betas:new Set([...b,...o])}}case"object-json":throw new Ne({functionality:"json-mode object generation"});case"object-tool":{const{name:t,description:n,parameters:s}=e.tool;return{args:{...x,tools:[{name:t,description:n,input_schema:s}],tool_choice:{type:"tool",name:t}},warnings:f,betas:b}}default:throw new Error(`Unsupported type: ${g}`)}}async getHeaders({betas:e,headers:t}){return Ae(await Ke(this.config.headers),e.size>0?{"anthropic-beta":Array.from(e).join(",")}:{},t)}buildRequestUrl(e){var t,n,s;return null!=(s=null==(n=(t=this.config).buildRequestUrl)?void 0:n.call(t,this.config.baseURL,e))?s:`${this.config.baseURL}/messages`}transformRequestBody(e){var t,n,s;return null!=(s=null==(n=(t=this.config).transformRequestBody)?void 0:n.call(t,e))?s:e}async doGenerate(e){var t,n,s,o;const{args:r,warnings:a,betas:i}=await this.getArgs(e),{responseHeaders:l,value:u,rawValue:c}=await Ve({url:this.buildRequestUrl(!1),headers:await this.getHeaders({betas:i,headers:e.headers}),body:this.transformRequestBody(r),failedResponseHandler:xo,successfulResponseHandler:Qe(No),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:d,...p}=r;let h,m="";for(const e of u.content)"text"===e.type&&(m+=e.text);if(u.content.some(e=>"tool_use"===e.type)){h=[];for(const e of u.content)"tool_use"===e.type&&h.push({toolCallType:"function",toolCallId:e.id,toolName:e.name,args:JSON.stringify(e.input)})}const g=u.content.filter(e=>"redacted_thinking"===e.type||"thinking"===e.type).map(e=>"thinking"===e.type?{type:"text",text:e.thinking,signature:e.signature}:{type:"redacted",data:e.data});return{text:m,reasoning:g.length>0?g:void 0,toolCalls:h,finishReason:ko(u.stop_reason),usage:{promptTokens:u.usage.input_tokens,completionTokens:u.usage.output_tokens},rawCall:{rawPrompt:d,rawSettings:p},rawResponse:{headers:l,body:c},response:{id:null!=(t=u.id)?t:void 0,modelId:null!=(n=u.model)?n:void 0},warnings:a,providerMetadata:{anthropic:{cacheCreationInputTokens:null!=(s=u.usage.cache_creation_input_tokens)?s:null,cacheReadInputTokens:null!=(o=u.usage.cache_read_input_tokens)?o:null}},request:{body:JSON.stringify(r)}}}async doStream(e){const{args:t,warnings:n,betas:s}=await this.getArgs(e),o={...t,stream:!0},{responseHeaders:r,value:a}=await Ve({url:this.buildRequestUrl(!0),headers:await this.getHeaders({betas:s,headers:e.headers}),body:this.transformRequestBody(o),failedResponseHandler:xo,successfulResponseHandler:Ye(Io),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:i,...l}=t;let u="unknown";const c={promptTokens:Number.NaN,completionTokens:Number.NaN},d={};let p,h;return{stream:a.pipeThrough(new TransformStream({transform(e,t){var n,s,o,r;if(!e.success)return void t.enqueue({type:"error",error:e.error});const a=e.value;switch(a.type){case"ping":return;case"content_block_start":{const e=a.content_block.type;switch(h=e,e){case"text":case"thinking":return;case"redacted_thinking":return void t.enqueue({type:"redacted-reasoning",data:a.content_block.data});case"tool_use":return void(d[a.index]={toolCallId:a.content_block.id,toolName:a.content_block.name,jsonText:""});default:throw new Error(`Unsupported content block type: ${e}`)}}case"content_block_stop":if(null!=d[a.index]){const e=d[a.index];t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,args:e.jsonText}),delete d[a.index]}return void(h=void 0);case"content_block_delta":{const e=a.delta.type;switch(e){case"text_delta":return void t.enqueue({type:"text-delta",textDelta:a.delta.text});case"thinking_delta":return void t.enqueue({type:"reasoning",textDelta:a.delta.thinking});case"signature_delta":return void("thinking"===h&&t.enqueue({type:"reasoning-signature",signature:a.delta.signature}));case"input_json_delta":{const e=d[a.index];return t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:a.delta.partial_json}),void(e.jsonText+=a.delta.partial_json)}default:throw new Error(`Unsupported delta type: ${e}`)}}case"message_start":return c.promptTokens=a.message.usage.input_tokens,c.completionTokens=a.message.usage.output_tokens,p={anthropic:{cacheCreationInputTokens:null!=(n=a.message.usage.cache_creation_input_tokens)?n:null,cacheReadInputTokens:null!=(s=a.message.usage.cache_read_input_tokens)?s:null}},void t.enqueue({type:"response-metadata",id:null!=(o=a.message.id)?o:void 0,modelId:null!=(r=a.message.model)?r:void 0});case"message_delta":return c.completionTokens=a.usage.output_tokens,void(u=ko(a.delta.stop_reason));case"message_stop":return void t.enqueue({type:"finish",finishReason:u,usage:c,providerMetadata:p});case"error":return void t.enqueue({type:"error",error:a.error});default:throw new Error(`Unsupported chunk type: ${a}`)}}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:r},warnings:n,request:{body:JSON.stringify(o)}}}},No=Es.object({type:Es.literal("message"),id:Es.string().nullish(),model:Es.string().nullish(),content:Es.array(Es.discriminatedUnion("type",[Es.object({type:Es.literal("text"),text:Es.string()}),Es.object({type:Es.literal("thinking"),thinking:Es.string(),signature:Es.string()}),Es.object({type:Es.literal("redacted_thinking"),data:Es.string()}),Es.object({type:Es.literal("tool_use"),id:Es.string(),name:Es.string(),input:Es.unknown()})])),stop_reason:Es.string().nullish(),usage:Es.object({input_tokens:Es.number(),output_tokens:Es.number(),cache_creation_input_tokens:Es.number().nullish(),cache_read_input_tokens:Es.number().nullish()})}),Io=Es.discriminatedUnion("type",[Es.object({type:Es.literal("message_start"),message:Es.object({id:Es.string().nullish(),model:Es.string().nullish(),usage:Es.object({input_tokens:Es.number(),output_tokens:Es.number(),cache_creation_input_tokens:Es.number().nullish(),cache_read_input_tokens:Es.number().nullish()})})}),Es.object({type:Es.literal("content_block_start"),index:Es.number(),content_block:Es.discriminatedUnion("type",[Es.object({type:Es.literal("text"),text:Es.string()}),Es.object({type:Es.literal("thinking"),thinking:Es.string()}),Es.object({type:Es.literal("tool_use"),id:Es.string(),name:Es.string()}),Es.object({type:Es.literal("redacted_thinking"),data:Es.string()})])}),Es.object({type:Es.literal("content_block_delta"),index:Es.number(),delta:Es.discriminatedUnion("type",[Es.object({type:Es.literal("input_json_delta"),partial_json:Es.string()}),Es.object({type:Es.literal("text_delta"),text:Es.string()}),Es.object({type:Es.literal("thinking_delta"),thinking:Es.string()}),Es.object({type:Es.literal("signature_delta"),signature:Es.string()})])}),Es.object({type:Es.literal("content_block_stop"),index:Es.number()}),Es.object({type:Es.literal("error"),error:Es.object({type:Es.string(),message:Es.string()})}),Es.object({type:Es.literal("message_delta"),delta:Es.object({stop_reason:Es.string().nullish()}),usage:Es.object({output_tokens:Es.number()})}),Es.object({type:Es.literal("message_stop")}),Es.object({type:Es.literal("ping")})]),Co=Es.object({thinking:Es.object({type:Es.union([Es.literal("enabled"),Es.literal("disabled")]),budgetTokens:Es.number().optional()}).optional()}),So=Es.object({command:Es.string(),restart:Es.boolean().optional()}),Eo=Es.object({command:Es.string(),restart:Es.boolean().optional()}),Ao=Es.object({command:Es.enum(["view","create","str_replace","insert","undo_edit"]),path:Es.string(),file_text:Es.string().optional(),insert_line:Es.number().int().optional(),new_str:Es.string().optional(),old_str:Es.string().optional(),view_range:Es.array(Es.number().int()).optional()}),Oo=Es.object({command:Es.enum(["view","create","str_replace","insert","undo_edit"]),path:Es.string(),file_text:Es.string().optional(),insert_line:Es.number().int().optional(),new_str:Es.string().optional(),old_str:Es.string().optional(),view_range:Es.array(Es.number().int()).optional()}),jo=Es.object({action:Es.enum(["key","type","mouse_move","left_click","left_click_drag","right_click","middle_click","double_click","screenshot","cursor_position"]),coordinate:Es.array(Es.number().int()).optional(),text:Es.string().optional()}),Ro=Es.object({action:Es.enum(["key","hold_key","type","cursor_position","mouse_move","left_mouse_down","left_mouse_up","left_click","left_click_drag","right_click","middle_click","double_click","triple_click","scroll","wait","screenshot"]),coordinate:Es.tuple([Es.number().int(),Es.number().int()]).optional(),duration:Es.number().optional(),scroll_amount:Es.number().optional(),scroll_direction:Es.enum(["up","down","left","right"]).optional(),start_coordinate:Es.tuple([Es.number().int(),Es.number().int()]).optional(),text:Es.string().optional()}),Mo={bash_20241022:function(e={}){return{type:"provider-defined",id:"anthropic.bash_20241022",args:{},parameters:So,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},bash_20250124:function(e={}){return{type:"provider-defined",id:"anthropic.bash_20250124",args:{},parameters:Eo,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},textEditor_20241022:function(e={}){return{type:"provider-defined",id:"anthropic.text_editor_20241022",args:{},parameters:Ao,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},textEditor_20250124:function(e={}){return{type:"provider-defined",id:"anthropic.text_editor_20250124",args:{},parameters:Oo,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},computer_20241022:function(e){return{type:"provider-defined",id:"anthropic.computer_20241022",args:{displayWidthPx:e.displayWidthPx,displayHeightPx:e.displayHeightPx,displayNumber:e.displayNumber},parameters:jo,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}},computer_20250124:function(e){return{type:"provider-defined",id:"anthropic.computer_20250124",args:{displayWidthPx:e.displayWidthPx,displayHeightPx:e.displayHeightPx,displayNumber:e.displayNumber},parameters:Ro,execute:e.execute,experimental_toToolResultContent:e.experimental_toToolResultContent}}};function Do(e={}){var t;const n=null!=(t=ot(e.baseURL))?t:"https://api.anthropic.com/v1",s=()=>({"anthropic-version":"2023-06-01","x-api-key":Ue({apiKey:e.apiKey,environmentVariableName:"ANTHROPIC_API_KEY",description:"Anthropic"}),...e.headers}),o=(t,o={})=>new To(t,o,{provider:"anthropic.messages",baseURL:n,headers:s,fetch:e.fetch,supportsImageUrls:!0}),r=function(e,t){if(new.target)throw new Error("The Anthropic model function cannot be called with the new keyword.");return o(e,t)};return r.languageModel=o,r.chat=o,r.messages=o,r.textEmbeddingModel=e=>{throw new ce({modelId:e,modelType:"textEmbeddingModel"})},r.tools=Mo,r}function $o(e){if(function(e){return null!=e&&"object"==typeof e&&"object"===e.type&&(null==e.properties||0===Object.keys(e.properties).length)}(e))return;if("boolean"==typeof e)return{type:"boolean",properties:{}};const{type:t,description:n,required:s,properties:o,items:r,allOf:a,anyOf:i,oneOf:l,format:u,const:c,minLength:d,enum:p}=e,h={};if(n&&(h.description=n),s&&(h.required=s),u&&(h.format=u),void 0!==c&&(h.enum=[c]),t&&(Array.isArray(t)?t.includes("null")?(h.type=t.filter(e=>"null"!==e)[0],h.nullable=!0):h.type=t:h.type="null"===t?"null":t),void 0!==p&&(h.enum=p),null!=o&&(h.properties=Object.entries(o).reduce((e,[t,n])=>(e[t]=$o(n),e),{})),r&&(h.items=Array.isArray(r)?r.map($o):$o(r)),a&&(h.allOf=a.map($o)),i)if(i.some(e=>"object"==typeof e&&"null"===(null==e?void 0:e.type))){const e=i.filter(e=>!("object"==typeof e&&"null"===(null==e?void 0:e.type)));if(1===e.length){const t=$o(e[0]);"object"==typeof t&&(h.nullable=!0,Object.assign(h,t))}else h.anyOf=e.map($o),h.nullable=!0}else h.anyOf=i.map($o);return l&&(h.oneOf=l.map($o)),void 0!==d&&(h.minLength=d),h}function Uo(e){return e.includes("/")?e:`models/${e}`}Do();var Po=Es.object({error:Es.object({code:Es.number().nullable(),message:Es.string(),status:Es.string()})}),qo=Xe({errorSchema:Po,errorToMessage:e=>e.error.message});function Lo({finishReason:e,hasToolCalls:t}){switch(e){case"STOP":return t?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"IMAGE_SAFETY":case"RECITATION":case"SAFETY":case"BLOCKLIST":case"PROHIBITED_CONTENT":case"SPII":return"content-filter";case"FINISH_REASON_UNSPECIFIED":case"OTHER":return"other";case"MALFORMED_FUNCTION_CALL":return"error";default:return"unknown"}}var Fo=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsImageUrls=!1,this.modelId=e,this.settings=t,this.config=n}get supportsStructuredOutputs(){var e;return null==(e=this.settings.structuredOutputs)||e}get provider(){return this.config.provider}async getArgs({mode:e,prompt:t,maxTokens:n,temperature:s,topP:o,topK:r,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m;const g=e.type,f=[],y=Ze({provider:"google",providerOptions:d,schema:Qo});!0!==(null==(p=null==y?void 0:y.thinkingConfig)?void 0:p.includeThoughts)||this.config.provider.startsWith("google.vertex.")||f.push({type:"other",message:`The 'includeThoughts' option is only supported with the Google Vertex provider and might not be supported or could behave unexpectedly with the current Google provider (${this.config.provider}).`});const b={maxOutputTokens:n,temperature:s,topK:r,topP:o,frequencyPenalty:a,presencePenalty:i,stopSequences:l,seed:c,responseMimeType:"json"===(null==u?void 0:u.type)?"application/json":void 0,responseSchema:"json"===(null==u?void 0:u.type)&&null!=u.schema&&this.supportsStructuredOutputs?$o(u.schema):void 0,...this.settings.audioTimestamp&&{audioTimestamp:this.settings.audioTimestamp},responseModalities:null==y?void 0:y.responseModalities,thinkingConfig:null==y?void 0:y.thinkingConfig},{contents:v,systemInstruction:w}=function(e){var t,n;const s=[],o=[];let r=!0;for(const{role:a,content:i}of e)switch(a){case"system":if(!r)throw new Ne({functionality:"system messages are only supported at the beginning of the conversation"});s.push({text:i});break;case"user":{r=!1;const e=[];for(const s of i)switch(s.type){case"text":e.push({text:s.text});break;case"image":e.push(s.image instanceof URL?{fileData:{mimeType:null!=(t=s.mimeType)?t:"image/jpeg",fileUri:s.image.toString()}}:{inlineData:{mimeType:null!=(n=s.mimeType)?n:"image/jpeg",data:st(s.image)}});break;case"file":e.push(s.data instanceof URL?{fileData:{mimeType:s.mimeType,fileUri:s.data.toString()}}:{inlineData:{mimeType:s.mimeType,data:s.data}})}o.push({role:"user",parts:e});break}case"assistant":r=!1,o.push({role:"model",parts:i.map(e=>{switch(e.type){case"text":return 0===e.text.length?void 0:{text:e.text};case"file":if("image/png"!==e.mimeType)throw new Ne({functionality:"Only PNG images are supported in assistant messages"});if(e.data instanceof URL)throw new Ne({functionality:"File data URLs in assistant messages are not supported"});return{inlineData:{mimeType:e.mimeType,data:e.data}};case"tool-call":return{functionCall:{name:e.toolName,args:e.args}}}}).filter(e=>void 0!==e)});break;case"tool":r=!1,o.push({role:"user",parts:i.map(e=>({functionResponse:{name:e.toolName,response:{name:e.toolName,content:e.result}}}))})}return{systemInstruction:s.length>0?{parts:s}:void 0,contents:o}}(t);switch(g){case"regular":{const{tools:t,toolConfig:n,toolWarnings:s}=function(e,t,n,s){var o,r;const a=(null==(o=e.tools)?void 0:o.length)?e.tools:void 0,i=[],l=s.includes("gemini-2"),u=s.includes("gemini-1.5-flash")&&!s.includes("-8b");if(t)return{tools:l?{googleSearch:{}}:{googleSearchRetrieval:u&&n?{dynamicRetrievalConfig:n}:{}},toolConfig:void 0,toolWarnings:i};if(null==a)return{tools:void 0,toolConfig:void 0,toolWarnings:i};const c=[];for(const e of a)"provider-defined"===e.type?i.push({type:"unsupported-tool",tool:e}):c.push({name:e.name,description:null!=(r=e.description)?r:"",parameters:$o(e.parameters)});const d=e.toolChoice;if(null==d)return{tools:{functionDeclarations:c},toolConfig:void 0,toolWarnings:i};const p=d.type;switch(p){case"auto":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"AUTO"}},toolWarnings:i};case"none":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"NONE"}},toolWarnings:i};case"required":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"ANY"}},toolWarnings:i};case"tool":return{tools:{functionDeclarations:c},toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[d.toolName]}},toolWarnings:i};default:throw new Ne({functionality:`Unsupported tool choice type: ${p}`})}}(e,null!=(h=this.settings.useSearchGrounding)&&h,this.settings.dynamicRetrievalConfig,this.modelId);return{args:{generationConfig:b,contents:v,systemInstruction:w,safetySettings:this.settings.safetySettings,tools:t,toolConfig:n,cachedContent:this.settings.cachedContent},warnings:[...f,...s]}}case"object-json":return{args:{generationConfig:{...b,responseMimeType:"application/json",responseSchema:null!=e.schema&&this.supportsStructuredOutputs?$o(e.schema):void 0},contents:v,systemInstruction:w,safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:f};case"object-tool":return{args:{generationConfig:b,contents:v,tools:{functionDeclarations:[{name:e.tool.name,description:null!=(m=e.tool.description)?m:"",parameters:$o(e.tool.parameters)}]},toolConfig:{functionCallingConfig:{mode:"ANY"}},safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:f};default:throw new Error(`Unsupported type: ${g}`)}}supportsUrl(e){return this.config.isSupportedUrl(e)}async doGenerate(e){var t,n,s,o,r;const{args:a,warnings:i}=await this.getArgs(e),l=JSON.stringify(a),u=Ae(await Ke(this.config.headers),e.headers),{responseHeaders:c,value:d,rawValue:p}=await Ve({url:`${this.config.baseURL}/${Uo(this.modelId)}:generateContent`,headers:u,body:a,failedResponseHandler:qo,successfulResponseHandler:Qe(Xo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:h,...m}=a,g=d.candidates[0],f=null!=g.content&&"object"==typeof g.content&&"parts"in g.content?g.content.parts:[],y=Bo({parts:f,generateId:this.config.generateId}),b=d.usageMetadata;return{text:Ho(f),reasoning:Zo(f),files:null==(t=Wo(f))?void 0:t.map(e=>({data:e.inlineData.data,mimeType:e.inlineData.mimeType})),toolCalls:y,finishReason:Lo({finishReason:g.finishReason,hasToolCalls:null!=y&&y.length>0}),usage:{promptTokens:null!=(n=null==b?void 0:b.promptTokenCount)?n:NaN,completionTokens:null!=(s=null==b?void 0:b.candidatesTokenCount)?s:NaN},rawCall:{rawPrompt:h,rawSettings:m},rawResponse:{headers:c,body:p},warnings:i,providerMetadata:{google:{groundingMetadata:null!=(o=g.groundingMetadata)?o:null,safetyRatings:null!=(r=g.safetyRatings)?r:null}},sources:Vo({groundingMetadata:g.groundingMetadata,generateId:this.config.generateId}),request:{body:l}}}async doStream(e){const{args:t,warnings:n}=await this.getArgs(e),s=JSON.stringify(t),o=Ae(await Ke(this.config.headers),e.headers),{responseHeaders:r,value:a}=await Ve({url:`${this.config.baseURL}/${Uo(this.modelId)}:streamGenerateContent?alt=sse`,headers:o,body:t,failedResponseHandler:qo,successfulResponseHandler:Ye(Yo),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:i,...l}=t;let u,c="unknown",d={promptTokens:Number.NaN,completionTokens:Number.NaN};const p=this.config.generateId;let h=!1;return{stream:a.pipeThrough(new TransformStream({transform(e,t){var n,s,o,r,a,i;if(!e.success)return void t.enqueue({type:"error",error:e.error});const l=e.value,m=l.usageMetadata;null!=m&&(d={promptTokens:null!=(n=m.promptTokenCount)?n:NaN,completionTokens:null!=(s=m.candidatesTokenCount)?s:NaN});const g=null==(o=l.candidates)?void 0:o[0];if(null==g)return;const f=g.content;if(null!=f){const e=Ho(f.parts);null!=e&&t.enqueue({type:"text-delta",textDelta:e});const n=Zo(f.parts);if(null!=n)for(const e of n)t.enqueue({type:"reasoning",textDelta:e.text});const s=Wo(f.parts);if(null!=s)for(const e of s)t.enqueue({type:"file",mimeType:e.inlineData.mimeType,data:e.inlineData.data});const o=Bo({parts:f.parts,generateId:p});if(null!=o)for(const e of o)t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:e.args}),t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,args:e.args}),h=!0}if(null!=g.finishReason){c=Lo({finishReason:g.finishReason,hasToolCalls:h});const e=null!=(r=Vo({groundingMetadata:g.groundingMetadata,generateId:p}))?r:[];for(const n of e)t.enqueue({type:"source",source:n});u={google:{groundingMetadata:null!=(a=g.groundingMetadata)?a:null,safetyRatings:null!=(i=g.safetyRatings)?i:null}}}},flush(e){e.enqueue({type:"finish",finishReason:c,usage:d,providerMetadata:u})}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:r},warnings:n,request:{body:s}}}};function Bo({parts:e,generateId:t}){const n=null==e?void 0:e.filter(e=>"functionCall"in e);return null==n||0===n.length?void 0:n.map(e=>({toolCallType:"function",toolCallId:t(),toolName:e.functionCall.name,args:JSON.stringify(e.functionCall.args)}))}function Ho(e){const t=null==e?void 0:e.filter(e=>"text"in e&&!0!==e.thought);return null==t||0===t.length?void 0:t.map(e=>e.text).join("")}function Zo(e){const t=null==e?void 0:e.filter(e=>"text"in e&&!0===e.thought&&null!=e.text);return null==t||0===t.length?void 0:t.map(e=>({type:"text",text:e.text}))}function Wo(e){return null==e?void 0:e.filter(e=>"inlineData"in e)}function Vo({groundingMetadata:e,generateId:t}){var n;return null==(n=null==e?void 0:e.groundingChunks)?void 0:n.filter(e=>null!=e.web).map(e=>({sourceType:"url",id:t(),url:e.web.uri,title:e.web.title}))}var zo=Es.object({parts:Es.array(Es.union([Es.object({functionCall:Es.object({name:Es.string(),args:Es.unknown()})}),Es.object({inlineData:Es.object({mimeType:Es.string(),data:Es.string()})}),Es.object({text:Es.string().nullish(),thought:Es.boolean().nullish()})])).nullish()}),Ko=Es.object({web:Es.object({uri:Es.string(),title:Es.string()}).nullish(),retrievedContext:Es.object({uri:Es.string(),title:Es.string()}).nullish()}),Go=Es.object({webSearchQueries:Es.array(Es.string()).nullish(),retrievalQueries:Es.array(Es.string()).nullish(),searchEntryPoint:Es.object({renderedContent:Es.string()}).nullish(),groundingChunks:Es.array(Ko).nullish(),groundingSupports:Es.array(Es.object({segment:Es.object({startIndex:Es.number().nullish(),endIndex:Es.number().nullish(),text:Es.string().nullish()}),segment_text:Es.string().nullish(),groundingChunkIndices:Es.array(Es.number()).nullish(),supportChunkIndices:Es.array(Es.number()).nullish(),confidenceScores:Es.array(Es.number()).nullish(),confidenceScore:Es.array(Es.number()).nullish()})).nullish(),retrievalMetadata:Es.union([Es.object({webDynamicRetrievalScore:Es.number()}),Es.object({})]).nullish()}),Jo=Es.object({category:Es.string().nullish(),probability:Es.string().nullish(),probabilityScore:Es.number().nullish(),severity:Es.string().nullish(),severityScore:Es.number().nullish(),blocked:Es.boolean().nullish()}),Xo=Es.object({candidates:Es.array(Es.object({content:zo.nullish().or(Es.object({}).strict()),finishReason:Es.string().nullish(),safetyRatings:Es.array(Jo).nullish(),groundingMetadata:Go.nullish()})),usageMetadata:Es.object({promptTokenCount:Es.number().nullish(),candidatesTokenCount:Es.number().nullish(),totalTokenCount:Es.number().nullish()}).nullish()}),Yo=Es.object({candidates:Es.array(Es.object({content:zo.nullish(),finishReason:Es.string().nullish(),safetyRatings:Es.array(Jo).nullish(),groundingMetadata:Go.nullish()})).nullish(),usageMetadata:Es.object({promptTokenCount:Es.number().nullish(),candidatesTokenCount:Es.number().nullish(),totalTokenCount:Es.number().nullish()}).nullish()}),Qo=Es.object({responseModalities:Es.array(Es.enum(["TEXT","IMAGE"])).nullish(),thinkingConfig:Es.object({thinkingBudget:Es.number().nullish(),includeThoughts:Es.boolean().nullish()}).nullish()}),er=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){return 2048}get supportsParallelCalls(){return!0}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new ge({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const s=Ae(await Ke(this.config.headers),t),{responseHeaders:o,value:r}=await Ve({url:`${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,headers:s,body:{requests:e.map(e=>({model:`models/${this.modelId}`,content:{role:"user",parts:[{text:e}]},outputDimensionality:this.settings.outputDimensionality,taskType:this.settings.taskType}))},failedResponseHandler:qo,successfulResponseHandler:Qe(tr),abortSignal:n,fetch:this.config.fetch});return{embeddings:r.embeddings.map(e=>e.values),usage:void 0,rawResponse:{headers:o}}}},tr=Es.object({embeddings:Es.array(Es.object({values:Es.array(Es.number())}))});function nr(e){return e.toString().startsWith("https://generativelanguage.googleapis.com/v1beta/files/")}function sr(e={}){var t;const n=null!=(t=ot(e.baseURL))?t:"https://generativelanguage.googleapis.com/v1beta",s=()=>({"x-goog-api-key":Ue({apiKey:e.apiKey,environmentVariableName:"GOOGLE_GENERATIVE_AI_API_KEY",description:"Google Generative AI"}),...e.headers}),o=(t,o={})=>{var r;return new Fo(t,o,{provider:"google.generative-ai",baseURL:n,headers:s,generateId:null!=(r=e.generateId)?r:Me,isSupportedUrl:nr,fetch:e.fetch})},r=(t,o={})=>new er(t,o,{provider:"google.generative-ai",baseURL:n,headers:s,fetch:e.fetch}),a=function(e,t){if(new.target)throw new Error("The Google Generative AI model function cannot be called with the new keyword.");return o(e,t)};return a.languageModel=o,a.chat=o,a.generativeAI=o,a.embedding=r,a.textEmbedding=r,a.textEmbeddingModel=r,a}sr(),"function"==typeof SuppressedError&&SuppressedError,"undefined"!=typeof Buffer&&Buffer.from;var or=function(){function e(){this.checksum=4294967295}return e.prototype.update=function(e){var t,n;try{for(var s=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],s=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),o=s.next();!o.done;o=s.next()){var r=o.value;this.checksum=this.checksum>>>8^rr[255&(this.checksum^r)]}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return this},e.prototype.digest=function(){return(4294967295^this.checksum)>>>0},e}(),rr=function(e){if(!Uint32Array.from){for(var t=new Uint32Array(e.length),n=0;n<e.length;)t[n]=e[n],n+=1;return t}return Uint32Array.from(e)}([0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117]);const ar={},ir={};for(let e=0;e<256;e++){let t=e.toString(16).toLowerCase();1===t.length&&(t=`0${t}`),ar[e]=t,ir[t]=e}function lr(e){let t="";for(let n=0;n<e.byteLength;n++)t+=ar[e[n]];return t}class ur{constructor(e){if(this.bytes=e,8!==e.byteLength)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(e){if(e>0x8000000000000000||e<-0x8000000000000000)throw new Error(`${e} is too large (or, if negative, too small) to represent as an Int64`);const t=new Uint8Array(8);for(let n=7,s=Math.abs(Math.round(e));n>-1&&s>0;n--,s/=256)t[n]=s;return e<0&&cr(t),new ur(t)}valueOf(){const e=this.bytes.slice(0),t=128&e[0];return t&&cr(e),parseInt(lr(e),16)*(t?-1:1)}toString(){return String(this.valueOf())}}function cr(e){for(let t=0;t<8;t++)e[t]^=255;for(let t=7;t>-1&&(e[t]++,0===e[t]);t--);}class dr{constructor(e,t){this.toUtf8=e,this.fromUtf8=t}format(e){const t=[];for(const n of Object.keys(e)){const s=this.fromUtf8(n);t.push(Uint8Array.from([s.byteLength]),s,this.formatHeaderValue(e[n]))}const n=new Uint8Array(t.reduce((e,t)=>e+t.byteLength,0));let s=0;for(const e of t)n.set(e,s),s+=e.byteLength;return n}formatHeaderValue(e){switch(e.type){case"boolean":return Uint8Array.from([e.value?0:1]);case"byte":return Uint8Array.from([2,e.value]);case"short":const t=new DataView(new ArrayBuffer(3));return t.setUint8(0,3),t.setInt16(1,e.value,!1),new Uint8Array(t.buffer);case"integer":const n=new DataView(new ArrayBuffer(5));return n.setUint8(0,4),n.setInt32(1,e.value,!1),new Uint8Array(n.buffer);case"long":const s=new Uint8Array(9);return s[0]=5,s.set(e.value.bytes,1),s;case"binary":const o=new DataView(new ArrayBuffer(3+e.value.byteLength));o.setUint8(0,6),o.setUint16(1,e.value.byteLength,!1);const r=new Uint8Array(o.buffer);return r.set(e.value,3),r;case"string":const a=this.fromUtf8(e.value),i=new DataView(new ArrayBuffer(3+a.byteLength));i.setUint8(0,7),i.setUint16(1,a.byteLength,!1);const l=new Uint8Array(i.buffer);return l.set(a,3),l;case"timestamp":const u=new Uint8Array(9);return u[0]=8,u.set(ur.fromNumber(e.value.valueOf()).bytes,1),u;case"uuid":if(!xr.test(e.value))throw new Error(`Invalid UUID received: ${e.value}`);const c=new Uint8Array(17);return c[0]=9,c.set(function(e){if(e.length%2!=0)throw new Error("Hex encoded strings must have an even number length");const t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2){const s=e.slice(n,n+2).toLowerCase();if(!(s in ir))throw new Error(`Cannot decode unrecognized sequence ${s} as hexadecimal`);t[n/2]=ir[s]}return t}(e.value.replace(/\-/g,"")),1),c}}parse(e){const t={};let n=0;for(;n<e.byteLength;){const s=e.getUint8(n++),o=this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,s));switch(n+=s,e.getUint8(n++)){case 0:t[o]={type:hr,value:!0};break;case 1:t[o]={type:hr,value:!1};break;case 2:t[o]={type:mr,value:e.getInt8(n++)};break;case 3:t[o]={type:gr,value:e.getInt16(n,!1)},n+=2;break;case 4:t[o]={type:fr,value:e.getInt32(n,!1)},n+=4;break;case 5:t[o]={type:yr,value:new ur(new Uint8Array(e.buffer,e.byteOffset+n,8))},n+=8;break;case 6:const s=e.getUint16(n,!1);n+=2,t[o]={type:br,value:new Uint8Array(e.buffer,e.byteOffset+n,s)},n+=s;break;case 7:const r=e.getUint16(n,!1);n+=2,t[o]={type:vr,value:this.toUtf8(new Uint8Array(e.buffer,e.byteOffset+n,r))},n+=r;break;case 8:t[o]={type:wr,value:new Date(new ur(new Uint8Array(e.buffer,e.byteOffset+n,8)).valueOf())},n+=8;break;case 9:const a=new Uint8Array(e.buffer,e.byteOffset+n,16);n+=16,t[o]={type:_r,value:`${lr(a.subarray(0,4))}-${lr(a.subarray(4,6))}-${lr(a.subarray(6,8))}-${lr(a.subarray(8,10))}-${lr(a.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return t}}var pr;!function(e){e[e.boolTrue=0]="boolTrue",e[e.boolFalse=1]="boolFalse",e[e.byte=2]="byte",e[e.short=3]="short",e[e.integer=4]="integer",e[e.long=5]="long",e[e.byteArray=6]="byteArray",e[e.string=7]="string",e[e.timestamp=8]="timestamp",e[e.uuid=9]="uuid"}(pr||(pr={}));const hr="boolean",mr="byte",gr="short",fr="integer",yr="long",br="binary",vr="string",wr="timestamp",_r="uuid",xr=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;class kr{constructor(e,t){this.headerMarshaller=new dr(e,t),this.messageBuffer=[],this.isEndOfStream=!1}feed(e){this.messageBuffer.push(this.decode(e))}endOfStream(){this.isEndOfStream=!0}getMessage(){const e=this.messageBuffer.pop(),t=this.isEndOfStream;return{getMessage:()=>e,isEndOfStream:()=>t}}getAvailableMessages(){const e=this.messageBuffer;this.messageBuffer=[];const t=this.isEndOfStream;return{getMessages:()=>e,isEndOfStream:()=>t}}encode({headers:e,body:t}){const n=this.headerMarshaller.format(e),s=n.byteLength+t.byteLength+16,o=new Uint8Array(s),r=new DataView(o.buffer,o.byteOffset,o.byteLength),a=new or;return r.setUint32(0,s,!1),r.setUint32(4,n.byteLength,!1),r.setUint32(8,a.update(o.subarray(0,8)).digest(),!1),o.set(n,12),o.set(t,n.byteLength+12),r.setUint32(s-4,a.update(o.subarray(8,s-4)).digest(),!1),o}decode(e){const{headers:t,body:n}=function({byteLength:e,byteOffset:t,buffer:n}){if(e<16)throw new Error("Provided message too short to accommodate event stream message overhead");const s=new DataView(n,t,e),o=s.getUint32(0,!1);if(e!==o)throw new Error("Reported message length does not match received message length");const r=s.getUint32(4,!1),a=s.getUint32(8,!1),i=s.getUint32(e-4,!1),l=(new or).update(new Uint8Array(n,t,8));if(a!==l.digest())throw new Error(`The prelude checksum specified in the message (${a}) does not match the calculated CRC32 checksum (${l.digest()})`);if(l.update(new Uint8Array(n,t+8,e-12)),i!==l.digest())throw new Error(`The message checksum (${l.digest()}) did not match the expected value of ${i}`);return{headers:new DataView(n,t+8+4,r),body:new Uint8Array(n,t+8+4+r,o-r-16)}}(e);return{headers:this.headerMarshaller.parse(t),body:n}}formatHeaders(e){return this.headerMarshaller.format(e)}}const Tr=e=>(new TextEncoder).encode(e),Nr=e=>{if("string"==typeof e)return e;if("object"!=typeof e||"number"!=typeof e.byteOffset||"number"!=typeof e.byteLength)throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(e)},Ir=new TextEncoder,Cr={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},Sr=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class Er{constructor({method:e,url:t,headers:n,body:s,accessKeyId:o,secretAccessKey:r,sessionToken:a,service:i,region:l,cache:u,datetime:c,signQuery:d,appendSessionToken:p,allHeaders:h,singleEncode:m}){if(null==t)throw new TypeError("url is a required option");if(null==o)throw new TypeError("accessKeyId is a required option");if(null==r)throw new TypeError("secretAccessKey is a required option");let g,f;this.method=e||(s?"POST":"GET"),this.url=new URL(t),this.headers=new Headers(n||{}),this.body=s,this.accessKeyId=o,this.secretAccessKey=r,this.sessionToken=a,i&&l||([g,f]=function(e,t){const{hostname:n,pathname:s}=e;if(n.endsWith(".on.aws")){const e=n.match(/^[^.]{1,63}\.lambda-url\.([^.]{1,63})\.on\.aws$/);return null!=e?["lambda",e[1]||""]:["",""]}if(n.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(n.endsWith(".backblazeb2.com")){const e=n.match(/^(?:[^.]{1,63}\.)?s3\.([^.]{1,63})\.backblazeb2\.com$/);return null!=e?["s3",e[1]||""]:["",""]}const o=n.replace("dualstack.","").match(/([^.]{1,63})\.(?:([^.]{0,63})\.)?amazonaws\.com(?:\.cn)?$/);let r=o&&o[1]||"",a=o&&o[2];if("us-gov"===a)a="us-gov-west-1";else if("s3"===a||"s3-accelerate"===a)a="us-east-1",r="s3";else if("iot"===r)r=n.startsWith("iot.")?"execute-api":n.startsWith("data.jobs.iot.")?"iot-jobs-data":"/mqtt"===s?"iotdevicegateway":"iotdata";else if("autoscaling"===r){const e=(t.get("X-Amz-Target")||"").split(".")[0];"AnyScaleFrontendService"===e?r="application-autoscaling":"AnyScaleScalingPlannerFrontendService"===e&&(r="autoscaling-plans")}else null==a&&r.startsWith("s3-")?(a=r.slice(3).replace(/^fips-|^external-1/,""),r="s3"):r.endsWith("-fips")?r=r.slice(0,-5):a&&/-\d$/.test(r)&&!/-\d$/.test(a)&&([r,a]=[a,r]);return[Cr[r]||r,a||""]}(this.url,this.headers)),this.service=i||g||"",this.region=l||f||"us-east-1",this.cache=u||new Map,this.datetime=c||(new Date).toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=d,this.appendSessionToken=p||"iotdevicegateway"===this.service,this.headers.delete("Host"),"s3"!==this.service||this.signQuery||this.headers.has("X-Amz-Content-Sha256")||this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const y=this.signQuery?this.url.searchParams:this.headers;if(y.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken&&y.set("X-Amz-Security-Token",this.sessionToken),this.signableHeaders=["host",...this.headers.keys()].filter(e=>h||!Sr.has(e)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map(e=>e+":"+("host"===e?this.url.host:(this.headers.get(e)||"").replace(/\s+/g," "))).join("\n"),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery&&("s3"!==this.service||y.has("X-Amz-Expires")||y.set("X-Amz-Expires","86400"),y.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),y.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),y.set("X-Amz-SignedHeaders",this.signedHeaders)),"s3"===this.service)try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch(e){this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");m||(this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/")),this.encodedPath=Mr(this.encodedPath);const b=new Set;this.encodedSearch=[...this.url.searchParams].filter(([e])=>{if(!e)return!1;if("s3"===this.service){if(b.has(e))return!1;b.add(e)}return!0}).map(e=>e.map(e=>Mr(encodeURIComponent(e)))).sort(([e,t],[n,s])=>e<n?-1:e>n?1:t<s?-1:t>s?1:0).map(e=>e.join("=")).join("&")}async sign(){return this.signQuery?(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken&&this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)):this.headers.set("Authorization",await this.authHeader()),{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const e=this.datetime.slice(0,8),t=[this.secretAccessKey,e,this.region,this.service].join();let n=this.cache.get(t);if(!n){const s=await Ar("AWS4"+this.secretAccessKey,e),o=await Ar(s,this.region),r=await Ar(o,this.service);n=await Ar(r,"aws4_request"),this.cache.set(t,n)}return Rr(await Ar(n,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,Rr(await Or(await this.canonicalString()))].join("\n")}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+"\n",this.signedHeaders,await this.hexBodyHash()].join("\n")}async hexBodyHash(){let e=this.headers.get("X-Amz-Content-Sha256")||("s3"===this.service&&this.signQuery?"UNSIGNED-PAYLOAD":null);if(null==e){if(this.body&&"string"!=typeof this.body&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");e=Rr(await Or(this.body||""))}return e}}async function Ar(e,t){const n=await crypto.subtle.importKey("raw","string"==typeof e?Ir.encode(e):e,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",n,Ir.encode(t))}async function Or(e){return crypto.subtle.digest("SHA-256","string"==typeof e?Ir.encode(e):e)}const jr=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function Rr(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.length;e++){const s=t[e];n+=jr[s>>>4&15],n+=jr[15&s]}return n}function Mr(e){return e.replace(/[!'()*]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())}var Dr={cachePoint:{type:"default"}},$r=Es.object({message:Es.string(),type:Es.string().nullish()}),Ur=e=>async({response:t})=>{const n=je(t);if(null==t.body)throw new S({});const s=new kr(Nr,Tr);let o=new Uint8Array(0);const r=new TextDecoder;return{responseHeaders:n,value:t.body.pipeThrough(new TransformStream({transform(t,n){var a,i;const l=new Uint8Array(o.length+t.length);for(l.set(o),l.set(t,o.length),o=l;o.length>=4;){const t=new DataView(o.buffer,o.byteOffset,o.byteLength).getUint32(0,!1);if(o.length<t)break;try{const l=o.subarray(0,t),u=s.decode(l);if(o=o.slice(t),"event"===(null==(a=u.headers[":message-type"])?void 0:a.value)){const t=Be({text:r.decode(u.body)});if(!t.success){n.enqueue(t);break}delete t.value.p;let s={[null==(i=u.headers[":event-type"])?void 0:i.value]:t.value};const o=Fe({value:s,schema:e});o.success?n.enqueue({success:!0,value:o.value,rawValue:s}):n.enqueue(o)}}catch(e){break}}}}))}},Pr=Re({prefix:"file",size:16});function qr(e){var t;return null==(t=null==e?void 0:e.bedrock)?void 0:t.cachePoint}function Lr(e){return["jpeg","png","gif"].includes(e)}function Fr(e,t,n,s){return e&&t&&n?s.trim():s}function Br(e){switch(e){case"stop_sequence":case"end_turn":return"stop";case"max_tokens":return"length";case"content_filtered":case"guardrail_intervened":return"content-filter";case"tool_use":return"tool-calls";default:return"unknown"}}var Hr=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1",this.provider="amazon-bedrock",this.defaultObjectGenerationMode="tool",this.supportsImageUrls=!1}getArgs({mode:e,prompt:t,maxTokens:n,temperature:s,topP:o,topK:r,frequencyPenalty:a,presencePenalty:i,stopSequences:l,responseFormat:u,seed:c,providerMetadata:d}){var p,h,m,g,f,y,b;const v=e.type,w=[];null!=a&&w.push({type:"unsupported-setting",setting:"frequencyPenalty"}),null!=i&&w.push({type:"unsupported-setting",setting:"presencePenalty"}),null!=c&&w.push({type:"unsupported-setting",setting:"seed"}),null!=r&&w.push({type:"unsupported-setting",setting:"topK"}),null!=u&&"text"!==u.type&&w.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported."});const{system:_,messages:x}=function(e){var t,n,s,o,r;const a=function(e){const t=[];let n;for(const s of e){const{role:e}=s;switch(e){case"system":"system"!==(null==n?void 0:n.type)&&(n={type:"system",messages:[]},t.push(n)),n.messages.push(s);break;case"assistant":"assistant"!==(null==n?void 0:n.type)&&(n={type:"assistant",messages:[]},t.push(n)),n.messages.push(s);break;case"user":case"tool":"user"!==(null==n?void 0:n.type)&&(n={type:"user",messages:[]},t.push(n)),n.messages.push(s);break;default:throw new Error(`Unsupported role: ${e}`)}}return t}(e);let i=[];const l=[];for(let e=0;e<a.length;e++){const u=a[e],c=e===a.length-1,d=u.type;switch(d){case"system":if(l.length>0)throw new Ne({functionality:"Multiple system messages that are separated by user/assistant messages"});for(const e of u.messages)i.push({text:e.content}),qr(e.providerMetadata)&&i.push(Dr);break;case"user":{const e=[];for(const a of u.messages){const{role:i,content:l,providerMetadata:u}=a;switch(i){case"user":for(let a=0;a<l.length;a++){const i=l[a];switch(i.type){case"text":e.push({text:i.text});break;case"image":if(i.image instanceof URL)throw new Ne({functionality:"Image URLs in user messages"});e.push({image:{format:null==(n=null==(t=i.mimeType)?void 0:t.split("/"))?void 0:n[1],source:{bytes:st(null!=(s=i.image)?s:i.image)}}});break;case"file":if(i.data instanceof URL)throw new Ne({functionality:"File URLs in user messages"});e.push({document:{format:null==(r=null==(o=i.mimeType)?void 0:o.split("/"))?void 0:r[1],name:Pr(),source:{bytes:i.data}}})}}break;case"tool":for(let t=0;t<l.length;t++){const n=l[t],s=null!=n.content?n.content.map(e=>{switch(e.type){case"text":return{text:e.text};case"image":if(!e.mimeType)throw new Error("Image mime type is required in tool result part content");const t=e.mimeType.split("/")[1];if(!Lr(t))throw new Error(`Unsupported image format: ${t}`);return{image:{format:t,source:{bytes:e.data}}}}}):[{text:JSON.stringify(n.result)}];e.push({toolResult:{toolUseId:n.toolCallId,content:s}})}break;default:throw new Error(`Unsupported role: ${i}`)}qr(u)&&e.push(Dr)}l.push({role:"user",content:e});break}case"assistant":{const e=[];for(let t=0;t<u.messages.length;t++){const n=u.messages[t],s=t===u.messages.length-1,{content:o}=n;for(let t=0;t<o.length;t++){const n=o[t],r=t===o.length-1;switch(n.type){case"text":e.push({text:Fr(c,s,r,n.text)});break;case"reasoning":e.push({reasoningContent:{reasoningText:{text:Fr(c,s,r,n.text),signature:n.signature}}});break;case"redacted-reasoning":e.push({reasoningContent:{redactedReasoning:{data:n.data}}});break;case"tool-call":e.push({toolUse:{toolUseId:n.toolCallId,name:n.toolName,input:n.args}})}}qr(n.providerMetadata)&&e.push(Dr)}l.push({role:"assistant",content:e});break}default:throw new Error(`Unsupported type: ${d}`)}}return{system:i,messages:l}}(t),k=Zr.safeParse(null==(p=null==d?void 0:d.bedrock)?void 0:p.reasoning_config);if(!k.success)throw new M({argument:"providerOptions.bedrock.reasoning_config",message:"invalid reasoning configuration options",cause:k.error});const T="enabled"===(null==(h=k.data)?void 0:h.type),N=null!=(f=null==(m=k.data)?void 0:m.budgetTokens)?f:null==(g=k.data)?void 0:g.budget_tokens,I={...null!=n&&{maxTokens:n},...null!=s&&{temperature:s},...null!=o&&{topP:o},...null!=l&&{stopSequences:l}};T&&null!=N&&(null!=I.maxTokens?I.maxTokens+=N:I.maxTokens=N+4096,this.settings.additionalModelRequestFields={...this.settings.additionalModelRequestFields,reasoning_config:{type:null==(y=k.data)?void 0:y.type,budget_tokens:N}}),T&&null!=I.temperature&&(delete I.temperature,w.push({type:"unsupported-setting",setting:"temperature",details:"temperature is not supported when thinking is enabled"})),T&&null!=I.topP&&(delete I.topP,w.push({type:"unsupported-setting",setting:"topP",details:"topP is not supported when thinking is enabled"}));const C={system:_,additionalModelRequestFields:this.settings.additionalModelRequestFields,...Object.keys(I).length>0&&{inferenceConfig:I},messages:x,...null==d?void 0:d.bedrock};switch(v){case"regular":{const{toolConfig:t,toolWarnings:n}=function(e){var t;const n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0;if(null==n)return{toolConfig:{tools:void 0,toolChoice:void 0},toolWarnings:[]};const s=[],o=[];for(const e of n)"provider-defined"===e.type?s.push({type:"unsupported-tool",tool:e}):o.push({toolSpec:{name:e.name,description:e.description,inputSchema:{json:e.parameters}}});const r=e.toolChoice;if(null==r)return{toolConfig:{tools:o,toolChoice:void 0},toolWarnings:s};const a=r.type;switch(a){case"auto":return{toolConfig:{tools:o,toolChoice:{auto:{}}},toolWarnings:s};case"required":return{toolConfig:{tools:o,toolChoice:{any:{}}},toolWarnings:s};case"none":return{toolConfig:{tools:void 0,toolChoice:void 0},toolWarnings:s};case"tool":return{toolConfig:{tools:o,toolChoice:{tool:{name:r.toolName}}},toolWarnings:s};default:throw new Ne({functionality:`Unsupported tool choice type: ${a}`})}}(e);return{command:{...C,...(null==(b=t.tools)?void 0:b.length)?{toolConfig:t}:{}},warnings:[...w,...n]}}case"object-json":throw new Ne({functionality:"json-mode object generation"});case"object-tool":return{command:{...C,toolConfig:{tools:[{toolSpec:{name:e.tool.name,description:e.tool.description,inputSchema:{json:e.tool.parameters}}}],toolChoice:{tool:{name:e.tool.name}}}},warnings:w};default:throw new Error(`Unsupported type: ${v}`)}}async doGenerate(e){var t,n,s,o,r,a,i,l,u,c,d,p,h,m,g,f;const{command:y,warnings:b}=this.getArgs(e),v=`${this.getUrl(this.modelId)}/converse`,{value:w,responseHeaders:_}=await Ve({url:v,headers:Ae(await Ke(this.config.headers),e.headers),body:y,failedResponseHandler:Xe({errorSchema:$r,errorToMessage:e=>{var t;return`${null!=(t=e.message)?t:"Unknown error"}`}}),successfulResponseHandler:Qe(Gr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:x,...k}=y,T=w.trace||w.usage?{bedrock:{...w.trace&&"object"==typeof w.trace?{trace:w.trace}:{},...w.usage&&{usage:{cacheReadInputTokens:null!=(n=null==(t=w.usage)?void 0:t.cacheReadInputTokens)?n:Number.NaN,cacheWriteInputTokens:null!=(o=null==(s=w.usage)?void 0:s.cacheWriteInputTokens)?o:Number.NaN}}}}:void 0,N=w.output.message.content.filter(e=>e.reasoningContent).map(e=>{var t;return e.reasoningContent&&"reasoningText"in e.reasoningContent?{type:"text",text:e.reasoningContent.reasoningText.text,...e.reasoningContent.reasoningText.signature&&{signature:e.reasoningContent.reasoningText.signature}}:e.reasoningContent&&"redactedReasoning"in e.reasoningContent?{type:"redacted",data:null!=(t=e.reasoningContent.redactedReasoning.data)?t:""}:void 0}).filter(e=>void 0!==e);return{text:null!=(l=null==(i=null==(a=null==(r=w.output)?void 0:r.message)?void 0:a.content)?void 0:i.map(e=>{var t;return null!=(t=e.text)?t:""}).join(""))?l:void 0,toolCalls:null==(p=null==(d=null==(c=null==(u=w.output)?void 0:u.message)?void 0:c.content)?void 0:d.filter(e=>!!e.toolUse))?void 0:p.map(e=>{var t,n,s,o,r,a;return{toolCallType:"function",toolCallId:null!=(n=null==(t=e.toolUse)?void 0:t.toolUseId)?n:this.config.generateId(),toolName:null!=(o=null==(s=e.toolUse)?void 0:s.name)?o:`tool-${this.config.generateId()}`,args:JSON.stringify(null!=(a=null==(r=e.toolUse)?void 0:r.input)?a:"")}}),finishReason:Br(w.stopReason),usage:{promptTokens:null!=(m=null==(h=w.usage)?void 0:h.inputTokens)?m:Number.NaN,completionTokens:null!=(f=null==(g=w.usage)?void 0:g.outputTokens)?f:Number.NaN},rawCall:{rawPrompt:x,rawSettings:k},rawResponse:{headers:_},warnings:b,reasoning:N.length>0?N:void 0,...T&&{providerMetadata:T}}}async doStream(e){const{command:t,warnings:n}=this.getArgs(e),s=`${this.getUrl(this.modelId)}/converse-stream`,{value:o,responseHeaders:r}=await Ve({url:s,headers:Ae(await Ke(this.config.headers),e.headers),body:t,failedResponseHandler:Xe({errorSchema:$r,errorToMessage:e=>`${e.type}: ${e.message}`}),successfulResponseHandler:Ur(Jr),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:a,...i}=t;let l,u="unknown",c={promptTokens:Number.NaN,completionTokens:Number.NaN};const d={};return{stream:o.pipeThrough(new TransformStream({transform(e,t){var n,s,o,r,a,i,p,h,m,g,f,y,b,v;function w(e){u="error",t.enqueue({type:"error",error:e})}if(!e.success)return void w(e.error);const _=e.value;if(_.internalServerException)return void w(_.internalServerException);if(_.modelStreamErrorException)return void w(_.modelStreamErrorException);if(_.throttlingException)return void w(_.throttlingException);if(_.validationException)return void w(_.validationException);if(_.messageStop&&(u=Br(_.messageStop.stopReason)),_.metadata){c={promptTokens:null!=(s=null==(n=_.metadata.usage)?void 0:n.inputTokens)?s:Number.NaN,completionTokens:null!=(r=null==(o=_.metadata.usage)?void 0:o.outputTokens)?r:Number.NaN};const e=null!=(null==(a=_.metadata.usage)?void 0:a.cacheReadInputTokens)||null!=(null==(i=_.metadata.usage)?void 0:i.cacheWriteInputTokens)?{usage:{cacheReadInputTokens:null!=(h=null==(p=_.metadata.usage)?void 0:p.cacheReadInputTokens)?h:Number.NaN,cacheWriteInputTokens:null!=(g=null==(m=_.metadata.usage)?void 0:m.cacheWriteInputTokens)?g:Number.NaN}}:void 0,t=_.metadata.trace?{trace:_.metadata.trace}:void 0;(e||t)&&(l={bedrock:{...e,...t}})}if((null==(f=_.contentBlockDelta)?void 0:f.delta)&&"text"in _.contentBlockDelta.delta&&_.contentBlockDelta.delta.text&&t.enqueue({type:"text-delta",textDelta:_.contentBlockDelta.delta.text}),(null==(y=_.contentBlockDelta)?void 0:y.delta)&&"reasoningContent"in _.contentBlockDelta.delta&&_.contentBlockDelta.delta.reasoningContent){const e=_.contentBlockDelta.delta.reasoningContent;"text"in e&&e.text?t.enqueue({type:"reasoning",textDelta:e.text}):"signature"in e&&e.signature?t.enqueue({type:"reasoning-signature",signature:e.signature}):"data"in e&&e.data&&t.enqueue({type:"redacted-reasoning",data:e.data})}const x=_.contentBlockStart;if(null!=(null==(b=null==x?void 0:x.start)?void 0:b.toolUse)){const e=x.start.toolUse;d[x.contentBlockIndex]={toolCallId:e.toolUseId,toolName:e.name,jsonText:""}}const k=_.contentBlockDelta;if((null==k?void 0:k.delta)&&"toolUse"in k.delta&&k.delta.toolUse){const e=d[k.contentBlockIndex],n=null!=(v=k.delta.toolUse.input)?v:"";t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:e.toolCallId,toolName:e.toolName,argsTextDelta:n}),e.jsonText+=n}const T=_.contentBlockStop;if(null!=T){const e=T.contentBlockIndex,n=d[e];null!=n&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:n.toolCallId,toolName:n.toolName,args:n.jsonText}),delete d[e])}},flush(e){e.enqueue({type:"finish",finishReason:u,usage:c,...l&&{providerMetadata:l}})}})),rawCall:{rawPrompt:a,rawSettings:i},rawResponse:{headers:r},warnings:n}}getUrl(e){const t=encodeURIComponent(e);return`${this.config.baseUrl()}/model/${t}`}},Zr=Es.object({type:Es.union([Es.literal("enabled"),Es.literal("disabled")]).nullish(),budget_tokens:Es.number().nullish(),budgetTokens:Es.number().nullish()}).nullish(),Wr=Es.union([Es.enum(["stop","stop_sequence","end_turn","length","max_tokens","content-filter","content_filtered","guardrail_intervened","tool-calls","tool_use"]),Es.string()]),Vr=Es.object({toolUseId:Es.string(),name:Es.string(),input:Es.unknown()}),zr=Es.object({signature:Es.string().nullish(),text:Es.string()}),Kr=Es.object({data:Es.string()}),Gr=Es.object({metrics:Es.object({latencyMs:Es.number()}).nullish(),output:Es.object({message:Es.object({content:Es.array(Es.object({text:Es.string().nullish(),toolUse:Vr.nullish(),reasoningContent:Es.union([Es.object({reasoningText:zr}),Es.object({redactedReasoning:Kr})]).nullish()})),role:Es.string()})}),stopReason:Wr,trace:Es.unknown().nullish(),usage:Es.object({inputTokens:Es.number(),outputTokens:Es.number(),totalTokens:Es.number(),cacheReadInputTokens:Es.number().nullish(),cacheWriteInputTokens:Es.number().nullish()})}),Jr=Es.object({contentBlockDelta:Es.object({contentBlockIndex:Es.number(),delta:Es.union([Es.object({text:Es.string()}),Es.object({toolUse:Es.object({input:Es.string()})}),Es.object({reasoningContent:Es.object({text:Es.string()})}),Es.object({reasoningContent:Es.object({signature:Es.string()})}),Es.object({reasoningContent:Es.object({data:Es.string()})})]).nullish()}).nullish(),contentBlockStart:Es.object({contentBlockIndex:Es.number(),start:Es.object({toolUse:Vr.nullish()}).nullish()}).nullish(),contentBlockStop:Es.object({contentBlockIndex:Es.number()}).nullish(),internalServerException:Es.record(Es.unknown()).nullish(),messageStop:Es.object({additionalModelResponseFields:Es.record(Es.unknown()).nullish(),stopReason:Wr}).nullish(),metadata:Es.object({trace:Es.unknown().nullish(),usage:Es.object({cacheReadInputTokens:Es.number().nullish(),cacheWriteInputTokens:Es.number().nullish(),inputTokens:Es.number(),outputTokens:Es.number()}).nullish()}).nullish(),modelStreamErrorException:Es.record(Es.unknown()).nullish(),throttlingException:Es.record(Es.unknown()).nullish(),validationException:Es.record(Es.unknown()).nullish()}),Xr=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1",this.provider="amazon-bedrock",this.maxEmbeddingsPerCall=void 0,this.supportsParallelCalls=!0}getUrl(e){const t=encodeURIComponent(e);return`${this.config.baseUrl()}/model/${t}/invoke`}async doEmbed({values:e,headers:t,abortSignal:n}){return(await Promise.all(e.map(async e=>{const s={inputText:e,dimensions:this.settings.dimensions,normalize:this.settings.normalize},o=this.getUrl(this.modelId),{value:r}=await Ve({url:o,headers:await Ke(Ae(await Ke(this.config.headers),t)),body:s,failedResponseHandler:Xe({errorSchema:$r,errorToMessage:e=>`${e.type}: ${e.message}`}),successfulResponseHandler:Qe(Yr),fetch:this.config.fetch,abortSignal:n});return{embedding:r.embedding,inputTextTokenCount:r.inputTextTokenCount}}))).reduce((e,t)=>(e.embeddings.push(t.embedding),e.usage.tokens+=t.inputTextTokenCount,e),{embeddings:[],usage:{tokens:0}})}},Yr=Es.object({embedding:Es.array(Es.number()),inputTextTokenCount:Es.number()}),Qr={"amazon.nova-canvas-v1:0":5},ea=class{constructor(e,t,n){this.modelId=e,this.settings=t,this.config=n,this.specificationVersion="v1",this.provider="amazon-bedrock"}get maxImagesPerCall(){var e,t;return null!=(t=null!=(e=this.settings.maxImagesPerCall)?e:Qr[this.modelId])?t:1}getUrl(e){const t=encodeURIComponent(e);return`${this.config.baseUrl()}/model/${t}/invoke`}async doGenerate({prompt:e,n:t,size:n,aspectRatio:s,seed:o,providerOptions:r,headers:a,abortSignal:i}){var l,u,c,d,p,h;const m=[],[g,f]=n?n.split("x").map(Number):[],y={taskType:"TEXT_IMAGE",textToImageParams:{text:e,...(null==(l=null==r?void 0:r.bedrock)?void 0:l.negativeText)?{negativeText:r.bedrock.negativeText}:{}},imageGenerationConfig:{...g?{width:g}:{},...f?{height:f}:{},...o?{seed:o}:{},...t?{numberOfImages:t}:{},...(null==(u=null==r?void 0:r.bedrock)?void 0:u.quality)?{quality:r.bedrock.quality}:{},...(null==(c=null==r?void 0:r.bedrock)?void 0:c.cfgScale)?{cfgScale:r.bedrock.cfgScale}:{}}};null!=s&&m.push({type:"unsupported-setting",setting:"aspectRatio",details:"This model does not support aspect ratio. Use `size` instead."});const b=null!=(h=null==(p=null==(d=this.config._internal)?void 0:d.currentDate)?void 0:p.call(d))?h:new Date,{value:v,responseHeaders:w}=await Ve({url:this.getUrl(this.modelId),headers:await Ke(Ae(await Ke(this.config.headers),a)),body:y,failedResponseHandler:Xe({errorSchema:$r,errorToMessage:e=>`${e.type}: ${e.message}`}),successfulResponseHandler:Qe(ta),abortSignal:i,fetch:this.config.fetch});return{images:v.images,warnings:m,response:{timestamp:b,modelId:this.modelId,headers:w}}}},ta=Es.object({images:Es.array(Es.string())});function na(e){const t={};return e.forEach((e,n)=>{t[n.toLowerCase()]=e}),t}function sa(e={}){const t=function(e,t=globalThis.fetch){return async(n,s)=>{var o;if("POST"!==(null==(o=null==s?void 0:s.method)?void 0:o.toUpperCase())||!(null==s?void 0:s.body))return t(n,s);const r="string"==typeof n?n:n instanceof URL?n.href:n.url,a=function(e){let t={};if(e)if(e instanceof Headers)t=na(e);else if(Array.isArray(e))for(const[n,s]of e)t[n.toLowerCase()]=s;else t=Object.fromEntries(Object.entries(e).map(([e,t])=>[e.toLowerCase(),t]));return t}(s.headers),i=function(e){return"string"==typeof e?e:e instanceof Uint8Array?(new TextDecoder).decode(e):e instanceof ArrayBuffer?(new TextDecoder).decode(new Uint8Array(e)):JSON.stringify(e)}(s.body),l=await e(),u=new Er({url:r,method:"POST",headers:Object.entries(De(a)),body:i,region:l.region,accessKeyId:l.accessKeyId,secretAccessKey:l.secretAccessKey,sessionToken:l.sessionToken,service:"bedrock"}),c=na((await u.sign()).headers);return t(n,{...s,body:i,headers:De(Ae(a,c))})}}(async()=>{const t=qe({settingValue:e.region,settingName:"region",environmentVariableName:"AWS_REGION",description:"AWS region"});return e.credentialProvider?{...await e.credentialProvider(),region:t}:{region:t,accessKeyId:qe({settingValue:e.accessKeyId,settingName:"accessKeyId",environmentVariableName:"AWS_ACCESS_KEY_ID",description:"AWS access key ID"}),secretAccessKey:qe({settingValue:e.secretAccessKey,settingName:"secretAccessKey",environmentVariableName:"AWS_SECRET_ACCESS_KEY",description:"AWS secret access key"}),sessionToken:Pe({settingValue:e.sessionToken,environmentVariableName:"AWS_SESSION_TOKEN"})}},e.fetch),n=()=>{var t,n;return null!=(n=ot(null!=(t=e.baseURL)?t:`https://bedrock-runtime.${qe({settingValue:e.region,settingName:"region",environmentVariableName:"AWS_REGION",description:"AWS region"})}.amazonaws.com`))?n:"https://bedrock-runtime.us-east-1.amazonaws.com"},s=(s,o={})=>{var r;return new Hr(s,o,{baseUrl:n,headers:null!=(r=e.headers)?r:{},fetch:t,generateId:Me})},o=function(e,t){if(new.target)throw new Error("The Amazon Bedrock model function cannot be called with the new keyword.");return s(e,t)},r=(s,o={})=>{var r;return new Xr(s,o,{baseUrl:n,headers:null!=(r=e.headers)?r:{},fetch:t})},a=(s,o={})=>{var r;return new ea(s,o,{baseUrl:n,headers:null!=(r=e.headers)?r:{},fetch:t})};return o.languageModel=s,o.embedding=r,o.textEmbedding=r,o.textEmbeddingModel=r,o.image=a,o.imageModel=a,o}sa();var oa=Object.defineProperty,ra=Object.defineProperties,aa=Object.getOwnPropertyDescriptors,ia=Object.getOwnPropertySymbols,la=Object.prototype.hasOwnProperty,ua=Object.prototype.propertyIsEnumerable,ca=(e,t,n)=>t in e?oa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,da=(e,t)=>{for(var n in t||(t={}))la.call(t,n)&&ca(e,n,t[n]);if(ia)for(var n of ia(t))ua.call(t,n)&&ca(e,n,t[n]);return e},pa=(e,t)=>ra(e,aa(t)),ha=(e,t)=>{var n={};for(var s in e)la.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&ia)for(var s of ia(e))t.indexOf(s)<0&&ua.call(e,s)&&(n[s]=e[s]);return n},ma=Es.object({type:Es.literal("reasoning.summary"),summary:Es.string()}),ga=Es.object({type:Es.literal("reasoning.encrypted"),data:Es.string()}),fa=Es.object({type:Es.literal("reasoning.text"),text:Es.string().nullish(),signature:Es.string().nullish()}),ya=Es.union([ma,ga,fa]),ba=Es.union([ya,Es.unknown().transform(()=>null)]),va=Es.array(ba).transform(e=>e.filter(e=>!!e));function wa(e){var t,n,s;const o=null==e?void 0:e.anthropic,r=null==e?void 0:e.openrouter;return null!=(s=null!=(n=null!=(t=null==r?void 0:r.cacheControl)?t:null==r?void 0:r.cache_control)?n:null==o?void 0:o.cacheControl)?s:null==o?void 0:o.cache_control}function _a(e){var t,n,s;const o=[];for(const{role:r,content:a,providerMetadata:i}of e)switch(r){case"system":o.push({role:"system",content:a,cache_control:wa(i)});break;case"user":{if(1===a.length&&"text"===(null==(t=a[0])?void 0:t.type)){o.push({role:"user",content:a[0].text,cache_control:null!=(n=wa(i))?n:wa(a[0].providerMetadata)});break}const e=wa(i),s=a.map(t=>{var n,s,o,r;const a=null!=(n=wa(t.providerMetadata))?n:e;switch(t.type){case"text":return{type:"text",text:t.text,cache_control:a};case"image":return{type:"image_url",image_url:{url:t.image instanceof URL?t.image.toString():`data:${null!=(s=t.mimeType)?s:"image/jpeg"};base64,${st(t.image)}`},cache_control:a};case"file":return{type:"file",file:{filename:String(null==(r=null==(o=t.providerMetadata)?void 0:o.openrouter)?void 0:r.filename),file_data:t.data instanceof Uint8Array?`data:${t.mimeType};base64,${st(t.data)}`:`data:${t.mimeType};base64,${t.data}`},cache_control:a};default:throw new Error(`Unsupported content part type: ${t}`)}});o.push({role:"user",content:s});break}case"assistant":{let e="",t="";const n=[],s=[];for(const o of a)switch(o.type){case"text":e+=o.text;break;case"tool-call":s.push({id:o.toolCallId,type:"function",function:{name:o.toolName,arguments:JSON.stringify(o.args)}});break;case"reasoning":t+=o.text,n.push({type:"reasoning.text",text:o.text,signature:o.signature});break;case"redacted-reasoning":n.push({type:"reasoning.encrypted",data:o.data});break;case"file":break;default:throw new Error(`Unsupported part: ${o}`)}o.push({role:"assistant",content:e,tool_calls:s.length>0?s:void 0,reasoning:t||void 0,reasoning_details:n.length>0?n:void 0,cache_control:wa(i)});break}case"tool":for(const e of a)o.push({role:"tool",tool_call_id:e.toolCallId,content:JSON.stringify(e.result),cache_control:null!=(s=wa(i))?s:wa(e.providerMetadata)});break;default:throw new Error(`Unsupported role: ${r}`)}return o}function xa(e){var t,n;return null!=(n=null==(t=null==e?void 0:e.content)?void 0:t.map(({token:e,logprob:t,top_logprobs:n})=>({token:e,logprob:t,topLogprobs:n?n.map(({token:e,logprob:t})=>({token:e,logprob:t})):[]})))?n:void 0}function ka(e){switch(e){case"stop":return"stop";case"length":return"length";case"content_filter":return"content-filter";case"function_call":case"tool_calls":return"tool-calls";default:return"unknown"}}var Ta=Es.object({error:Es.object({code:Es.union([Es.string(),Es.number()]).nullable(),message:Es.string(),type:Es.string().nullable(),param:Es.any().nullable()})}),Na=Xe({errorSchema:Ta,errorToMessage:e=>e.error.message}),Ia=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="tool",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,prompt:t,maxTokens:n,temperature:s,topP:o,frequencyPenalty:r,presencePenalty:a,seed:i,stopSequences:l,responseFormat:u,topK:c,providerMetadata:d}){var p;const h=e.type,m=null!=(p=null==d?void 0:d.openrouter)?p:{},g=da(da(da({model:this.modelId,models:this.settings.models,logit_bias:this.settings.logitBias,logprobs:!0===this.settings.logprobs||"number"==typeof this.settings.logprobs||void 0,top_logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,user:this.settings.user,parallel_tool_calls:this.settings.parallelToolCalls,max_tokens:n,temperature:s,top_p:o,frequency_penalty:r,presence_penalty:a,seed:i,stop:l,response_format:u,top_k:c,messages:_a(t),include_reasoning:this.settings.includeReasoning,reasoning:this.settings.reasoning,usage:this.settings.usage},this.config.extraBody),this.settings.extraBody),m);switch(h){case"regular":return da(da({},g),function(e){var t;const n=(null==(t=e.tools)?void 0:t.length)?e.tools:void 0;if(null==n)return{tools:void 0,tool_choice:void 0};const s=n.map(e=>function(e){return"parameters"in e}(e)?{type:"function",function:{name:e.name,description:e.description,parameters:e.parameters}}:{type:"function",function:{name:e.name}}),o=e.toolChoice;if(null==o)return{tools:s,tool_choice:void 0};const r=o.type;switch(r){case"auto":case"none":case"required":return{tools:s,tool_choice:r};case"tool":return{tools:s,tool_choice:{type:"function",function:{name:o.toolName}}};default:throw new Error(`Unsupported tool choice type: ${r}`)}}(e));case"object-json":return pa(da({},g),{response_format:{type:"json_object"}});case"object-tool":return pa(da({},g),{tool_choice:{type:"function",function:{name:e.tool.name}},tools:[{type:"function",function:{name:e.tool.name,description:e.tool.description,parameters:e.tool.parameters}}]});default:throw new Ne({functionality:`${h} mode`})}}async doGenerate(e){var t,n,s,o,r,a,i,l,u;const c=this.getArgs(e),{responseHeaders:d,value:p}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:c,failedResponseHandler:Na,successfulResponseHandler:Qe(Sa),abortSignal:e.abortSignal,fetch:this.config.fetch}),h=c,{messages:m}=h,g=ha(h,["messages"]),f=p.choices[0];if(!f)throw new Error("No choice in response");const y=p.usage?{promptTokens:null!=(t=p.usage.prompt_tokens)?t:0,completionTokens:null!=(n=p.usage.completion_tokens)?n:0}:{promptTokens:0,completionTokens:0},b={};p.usage&&(null==(s=this.settings.usage)?void 0:s.include)&&(b.openrouter={usage:{promptTokens:p.usage.prompt_tokens,promptTokensDetails:p.usage.prompt_tokens_details?{cachedTokens:null!=(o=p.usage.prompt_tokens_details.cached_tokens)?o:0}:void 0,completionTokens:p.usage.completion_tokens,completionTokensDetails:p.usage.completion_tokens_details?{reasoningTokens:null!=(r=p.usage.completion_tokens_details.reasoning_tokens)?r:0}:void 0,cost:p.usage.cost,totalTokens:null!=(a=p.usage.total_tokens)?a:0}});const v=Object.keys(b).length>0,w=null!=(i=f.message.reasoning_details)?i:[],_=w.length>0?w.map(e=>{var t;switch(e.type){case"reasoning.text":if(e.text)return{type:"text",text:e.text,signature:null!=(t=e.signature)?t:void 0};break;case"reasoning.summary":if(e.summary)return{type:"text",text:e.summary};break;case"reasoning.encrypted":if(e.data)return{type:"redacted",data:e.data}}return null}).filter(e=>null!==e):f.message.reasoning?[{type:"text",text:f.message.reasoning}]:[];return da({response:{id:p.id,modelId:p.model},text:null!=(l=f.message.content)?l:void 0,reasoning:_,toolCalls:null==(u=f.message.tool_calls)?void 0:u.map(e=>{var t;return{toolCallType:"function",toolCallId:null!=(t=e.id)?t:Me(),toolName:e.function.name,args:e.function.arguments}}),finishReason:ka(f.finish_reason),usage:y,rawCall:{rawPrompt:m,rawSettings:g},rawResponse:{headers:d},warnings:[],logprobs:xa(f.logprobs)},v?{providerMetadata:b}:{})}async doStream(e){var t,n;const s=this.getArgs(e),{responseHeaders:o,value:r}=await Ve({url:this.config.url({path:"/chat/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:pa(da({},s),{stream:!0,stream_options:"strict"===this.config.compatibility?da({include_usage:!0},(null==(t=this.settings.usage)?void 0:t.include)?{include_usage:!0}:{}):void 0}),failedResponseHandler:Na,successfulResponseHandler:Ye(Ea),abortSignal:e.abortSignal,fetch:this.config.fetch}),a=s,{messages:i}=a,l=ha(a,["messages"]),u=[];let c,d="other",p={promptTokens:Number.NaN,completionTokens:Number.NaN};const h={},m=!!(null==(n=this.settings.usage)?void 0:n.include);return{stream:r.pipeThrough(new TransformStream({transform(e,t){var n,s,o,r,a,i,l,m,g,f,y,b,v,w;if(!e.success)return d="error",void t.enqueue({type:"error",error:e.error});const _=e.value;if("error"in _)return d="error",void t.enqueue({type:"error",error:_.error});_.id&&t.enqueue({type:"response-metadata",id:_.id}),_.model&&t.enqueue({type:"response-metadata",modelId:_.model}),null!=_.usage&&(p={promptTokens:_.usage.prompt_tokens,completionTokens:_.usage.completion_tokens},h.promptTokens=_.usage.prompt_tokens,_.usage.prompt_tokens_details&&(h.promptTokensDetails={cachedTokens:null!=(n=_.usage.prompt_tokens_details.cached_tokens)?n:0}),h.completionTokens=_.usage.completion_tokens,_.usage.completion_tokens_details&&(h.completionTokensDetails={reasoningTokens:null!=(s=_.usage.completion_tokens_details.reasoning_tokens)?s:0}),h.cost=_.usage.cost,h.totalTokens=_.usage.total_tokens);const x=_.choices[0];if(null!=(null==x?void 0:x.finish_reason)&&(d=ka(x.finish_reason)),null==(null==x?void 0:x.delta))return;const k=x.delta;if(null!=k.content&&t.enqueue({type:"text-delta",textDelta:k.content}),null!=k.reasoning&&t.enqueue({type:"reasoning",textDelta:k.reasoning}),k.reasoning_details&&k.reasoning_details.length>0)for(const e of k.reasoning_details)switch(e.type){case"reasoning.text":e.text&&t.enqueue({type:"reasoning",textDelta:e.text}),e.signature&&t.enqueue({type:"reasoning-signature",signature:e.signature});break;case"reasoning.encrypted":e.data&&t.enqueue({type:"redacted-reasoning",data:e.data});break;case"reasoning.summary":e.summary&&t.enqueue({type:"reasoning",textDelta:e.summary})}const T=xa(null==x?void 0:x.logprobs);if((null==T?void 0:T.length)&&(void 0===c&&(c=[]),c.push(...T)),null!=k.tool_calls)for(const e of k.tool_calls){const n=e.index;if(null==u[n]){if("function"!==e.type)throw new Z({data:e,message:"Expected 'function' type."});if(null==e.id)throw new Z({data:e,message:"Expected 'id' to be a string."});if(null==(null==(o=e.function)?void 0:o.name))throw new Z({data:e,message:"Expected 'function.name' to be a string."});u[n]={id:e.id,type:"function",function:{name:e.function.name,arguments:null!=(r=e.function.arguments)?r:""},sent:!1};const s=u[n];if(null==s)throw new Error("Tool call is missing");null!=(null==(a=s.function)?void 0:a.name)&&null!=(null==(i=s.function)?void 0:i.arguments)&&He(s.function.arguments)&&(t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:s.id,toolName:s.function.name,argsTextDelta:s.function.arguments}),t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(l=s.id)?l:Me(),toolName:s.function.name,args:s.function.arguments}),s.sent=!0);continue}const s=u[n];if(null==s)throw new Error("Tool call is missing");null!=(null==(m=e.function)?void 0:m.arguments)&&(s.function.arguments+=null!=(f=null==(g=e.function)?void 0:g.arguments)?f:""),t.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:s.id,toolName:s.function.name,argsTextDelta:null!=(y=e.function.arguments)?y:""}),null!=(null==(b=s.function)?void 0:b.name)&&null!=(null==(v=s.function)?void 0:v.arguments)&&He(s.function.arguments)&&(t.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(w=s.id)?w:Me(),toolName:s.function.name,args:s.function.arguments}),s.sent=!0)}},flush(e){var t;if("tool-calls"===d)for(const n of u)n.sent||(e.enqueue({type:"tool-call",toolCallType:"function",toolCallId:null!=(t=n.id)?t:Me(),toolName:n.function.name,args:He(n.function.arguments)?n.function.arguments:"{}"}),n.sent=!0);const n={};!m||void 0===h.totalTokens&&void 0===h.cost&&void 0===h.promptTokensDetails&&void 0===h.completionTokensDetails||(n.openrouter={usage:h});const s=Object.keys(n).length>0&&m;e.enqueue(da({type:"finish",finishReason:d,logprobs:c,usage:p},s?{providerMetadata:n}:{}))}})),rawCall:{rawPrompt:i,rawSettings:l},rawResponse:{headers:o},warnings:[]}}},Ca=Es.object({id:Es.string().optional(),model:Es.string().optional(),usage:Es.object({prompt_tokens:Es.number(),prompt_tokens_details:Es.object({cached_tokens:Es.number()}).nullish(),completion_tokens:Es.number(),completion_tokens_details:Es.object({reasoning_tokens:Es.number()}).nullish(),total_tokens:Es.number(),cost:Es.number().optional()}).nullish()}),Sa=Ca.extend({choices:Es.array(Es.object({message:Es.object({role:Es.literal("assistant"),content:Es.string().nullable().optional(),reasoning:Es.string().nullable().optional(),reasoning_details:va.nullish(),tool_calls:Es.array(Es.object({id:Es.string().optional().nullable(),type:Es.literal("function"),function:Es.object({name:Es.string(),arguments:Es.string()})})).optional()}),index:Es.number(),logprobs:Es.object({content:Es.array(Es.object({token:Es.string(),logprob:Es.number(),top_logprobs:Es.array(Es.object({token:Es.string(),logprob:Es.number()}))})).nullable()}).nullable().optional(),finish_reason:Es.string().optional().nullable()}))}),Ea=Es.union([Ca.extend({choices:Es.array(Es.object({delta:Es.object({role:Es.enum(["assistant"]).optional(),content:Es.string().nullish(),reasoning:Es.string().nullish().optional(),reasoning_details:va.nullish(),tool_calls:Es.array(Es.object({index:Es.number(),id:Es.string().nullish(),type:Es.literal("function").optional(),function:Es.object({name:Es.string().nullish(),arguments:Es.string().nullish()})})).nullish()}).nullish(),logprobs:Es.object({content:Es.array(Es.object({token:Es.string(),logprob:Es.number(),top_logprobs:Es.array(Es.object({token:Es.string(),logprob:Es.number()}))})).nullable()}).nullish(),finish_reason:Es.string().nullable().optional(),index:Es.number()}))}),Ta]);function Aa(e){return null==e?void 0:e.tokens.map((t,n)=>{var s,o;return{token:t,logprob:null!=(s=e.token_logprobs[n])?s:0,topLogprobs:e.top_logprobs?Object.entries(null!=(o=e.top_logprobs[n])?o:{}).map(([e,t])=>({token:e,logprob:t})):[]}})}var Oa=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode=void 0,this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}getArgs({mode:e,inputFormat:t,prompt:n,maxTokens:s,temperature:o,topP:r,frequencyPenalty:a,presencePenalty:i,seed:l,responseFormat:u,topK:c,stopSequences:d,providerMetadata:p}){var h,m;const g=e.type,f=null!=(h=null==p?void 0:p.openrouter)?h:{},{prompt:y}=function({prompt:e,inputFormat:t,user:n="user",assistant:s="assistant"}){if("prompt"===t&&1===e.length&&e[0]&&"user"===e[0].role&&1===e[0].content.length&&e[0].content[0]&&"text"===e[0].content[0].type)return{prompt:e[0].content[0].text};let o="";e[0]&&"system"===e[0].role&&(o+=`${e[0].content}\n\n`,e=e.slice(1));for(const{role:t,content:r}of e)switch(t){case"system":throw new q({message:"Unexpected system message in prompt: ${content}",prompt:e});case"user":o+=`${n}:\n${r.map(e=>{switch(e.type){case"text":return e.text;case"image":throw new Ne({functionality:"images"});case"file":throw new Ne({functionality:"file attachments"});default:throw new Error(`Unsupported content type: ${e}`)}}).join("")}\n\n`;break;case"assistant":o+=`${s}:\n${r.map(e=>{switch(e.type){case"text":return e.text;case"tool-call":throw new Ne({functionality:"tool-call messages"});case"reasoning":throw new Ne({functionality:"reasoning messages"});case"redacted-reasoning":throw new Ne({functionality:"redacted reasoning messages"});case"file":throw new Ne({functionality:"file attachments"});default:throw new Error(`Unsupported content type: ${e}`)}}).join("")}\n\n`;break;case"tool":throw new Ne({functionality:"tool messages"});default:throw new Error(`Unsupported role: ${t}`)}return o+=`${s}:\n`,{prompt:o}}({prompt:n,inputFormat:t}),b=da(da(da({model:this.modelId,models:this.settings.models,logit_bias:this.settings.logitBias,logprobs:"number"==typeof this.settings.logprobs?this.settings.logprobs:"boolean"==typeof this.settings.logprobs&&this.settings.logprobs?0:void 0,suffix:this.settings.suffix,user:this.settings.user,max_tokens:s,temperature:o,top_p:r,frequency_penalty:a,presence_penalty:i,seed:l,stop:d,response_format:u,top_k:c,prompt:y,include_reasoning:this.settings.includeReasoning,reasoning:this.settings.reasoning},this.config.extraBody),this.settings.extraBody),f);switch(g){case"regular":if(null==(m=e.tools)?void 0:m.length)throw new Ne({functionality:"tools"});if(e.toolChoice)throw new Ne({functionality:"toolChoice"});return b;case"object-json":throw new Ne({functionality:"object-json mode"});case"object-tool":throw new Ne({functionality:"object-tool mode"});default:throw new Ne({functionality:`${g} mode`})}}async doGenerate(e){var t,n,s,o,r;const a=this.getArgs(e),{responseHeaders:i,value:l}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:a,failedResponseHandler:Na,successfulResponseHandler:Qe(ja),abortSignal:e.abortSignal,fetch:this.config.fetch}),u=a,{prompt:c}=u,d=ha(u,["prompt"]);if("error"in l)throw new Error(`${l.error.message}`);const p=l.choices[0];if(!p)throw new Error("No choice in OpenRouter completion response");return{response:{id:l.id,modelId:l.model},text:null!=(t=p.text)?t:"",reasoning:p.reasoning||void 0,usage:{promptTokens:null!=(s=null==(n=l.usage)?void 0:n.prompt_tokens)?s:0,completionTokens:null!=(r=null==(o=l.usage)?void 0:o.completion_tokens)?r:0},finishReason:ka(p.finish_reason),logprobs:Aa(p.logprobs),rawCall:{rawPrompt:c,rawSettings:d},rawResponse:{headers:i},warnings:[]}}async doStream(e){const t=this.getArgs(e),{responseHeaders:n,value:s}=await Ve({url:this.config.url({path:"/completions",modelId:this.modelId}),headers:Ae(this.config.headers(),e.headers),body:pa(da({},this.getArgs(e)),{stream:!0,stream_options:"strict"===this.config.compatibility?{include_usage:!0}:void 0}),failedResponseHandler:Na,successfulResponseHandler:Ye(ja),abortSignal:e.abortSignal,fetch:this.config.fetch}),o=t,{prompt:r}=o,a=ha(o,["prompt"]);let i,l="other",u={promptTokens:Number.NaN,completionTokens:Number.NaN};return{stream:s.pipeThrough(new TransformStream({transform(e,t){if(!e.success)return l="error",void t.enqueue({type:"error",error:e.error});const n=e.value;if("error"in n)return l="error",void t.enqueue({type:"error",error:n.error});null!=n.usage&&(u={promptTokens:n.usage.prompt_tokens,completionTokens:n.usage.completion_tokens});const s=n.choices[0];null!=(null==s?void 0:s.finish_reason)&&(l=ka(s.finish_reason)),null!=(null==s?void 0:s.text)&&t.enqueue({type:"text-delta",textDelta:s.text});const o=Aa(null==s?void 0:s.logprobs);(null==o?void 0:o.length)&&(void 0===i&&(i=[]),i.push(...o))},flush(e){e.enqueue({type:"finish",finishReason:l,logprobs:i,usage:u})}})),rawCall:{rawPrompt:r,rawSettings:a},rawResponse:{headers:n},warnings:[]}}},ja=Es.union([Es.object({id:Es.string().optional(),model:Es.string().optional(),choices:Es.array(Es.object({text:Es.string(),reasoning:Es.string().nullish().optional(),reasoning_details:va.nullish(),finish_reason:Es.string().nullish(),index:Es.number(),logprobs:Es.object({tokens:Es.array(Es.string()),token_logprobs:Es.array(Es.number()),top_logprobs:Es.array(Es.record(Es.string(),Es.number())).nullable()}).nullable().optional()})),usage:Es.object({prompt_tokens:Es.number(),completion_tokens:Es.number()}).optional().nullable()}),Ta]);function Ra(e={}){var t,n,s;const o=null!=(n=ot(null!=(t=e.baseURL)?t:e.baseUrl))?n:"https://openrouter.ai/api/v1",r=null!=(s=e.compatibility)?s:"compatible",a=()=>da({Authorization:`Bearer ${Ue({apiKey:e.apiKey,environmentVariableName:"OPENROUTER_API_KEY",description:"OpenRouter"})}`},e.headers),i=(t,n={})=>new Ia(t,n,{provider:"openrouter.chat",url:({path:e})=>`${o}${e}`,headers:a,compatibility:r,fetch:e.fetch,extraBody:e.extraBody}),l=(t,n={})=>new Oa(t,n,{provider:"openrouter.completion",url:({path:e})=>`${o}${e}`,headers:a,compatibility:r,fetch:e.fetch,extraBody:e.extraBody}),u=(e,t)=>{if(new.target)throw new Error("The OpenRouter model function cannot be called with the new keyword.");return"openai/gpt-3.5-turbo-instruct"===e?l(e,t):i(e,t)},c=(e,t)=>u(e,t);return c.languageModel=u,c.chat=i,c.completion=l,c}Ra({compatibility:"strict"});class Ma{constructor(e,t,n,s){this.llms=e,this.names=t||[],this.stream_first_timeout=n||3e4,this.stream_token_timeout=s||18e4,-1==this.names.indexOf("default")&&this.names.push("default")}async call(e){return await this.doGenerate({inputFormat:"messages",mode:{type:"regular",tools:e.tools,toolChoice:e.toolChoice},prompt:e.messages,maxTokens:e.maxTokens,temperature:e.temperature,topP:e.topP,topK:e.topK,stopSequences:e.stopSequences,abortSignal:e.abortSignal})}async doGenerate(e){const t=e.maxTokens,n=e.providerMetadata,s=[...this.names,...this.names];let r;for(let a=0;a<s.length;a++){const i=s[a],l=this.llms[i],u=await this.getLLM(i);if(!u)continue;t||(e.maxTokens=l.config?.maxTokens||16e3),n||(e.providerMetadata={},e.providerMetadata[u.provider]=l.options||{});let c=e;l.handler&&(c=await l.handler(c));try{let e=await u.doGenerate(c);return o.isEnableDebug()&&o.debug(`LLM nonstream body, name: ${i} => `,e.request?.body),e.llm=i,e.llmConfig=l,e}catch(e){if("AbortError"===e?.name)throw e;r=e,o.isEnableInfo()&&o.info(`LLM nonstream request, name: ${i} => `,{tools:c.mode?.tools,messages:c.prompt}),o.error(`LLM error, name: ${i} => `,e)}}return Promise.reject(r||new Error("No LLM available"))}async callStream(e){return await this.doStream({inputFormat:"messages",mode:{type:"regular",tools:e.tools,toolChoice:e.toolChoice},prompt:e.messages,maxTokens:e.maxTokens,temperature:e.temperature,topP:e.topP,topK:e.topK,stopSequences:e.stopSequences,abortSignal:e.abortSignal})}async doStream(e){const t=e.maxTokens,n=e.providerMetadata,s=[...this.names,...this.names];let r;for(let a=0;a<s.length;a++){const l=s[a],u=this.llms[l],c=await this.getLLM(l);if(!c)continue;t||(e.maxTokens=u.config?.maxTokens||16e3),n||(e.providerMetadata={},e.providerMetadata[c.provider]=u.options||{});let d=e;u.handler&&(d=await u.handler(d));try{const e=new AbortController,t=d.abortSignal?AbortSignal.any([d.abortSignal,e.signal]):e.signal,n=await i(async()=>await c.doStream({...d,abortSignal:t}),this.stream_first_timeout,t=>{e.abort()}),s=n.stream.getReader(),{done:r,value:a}=await i(async()=>await s.read(),this.stream_first_timeout,t=>{s.cancel(),s.releaseLock(),e.abort()});if(r){o.warn(`LLM stream done, name: ${l} => `,{done:r,value:a}),s.releaseLock();continue}o.isEnableDebug()&&o.debug(`LLM stream body, name: ${l} => `,n.request?.body);let p=a;if("error"==p.type){o.error(`LLM stream error, name: ${l}`,p),s.releaseLock();continue}return n.llm=l,n.llmConfig=u,n.stream=this.streamWrapper([p],s,e),n}catch(e){if("AbortError"===e?.name)throw e;r=e,o.isEnableInfo()&&o.info(`LLM stream request, name: ${l} => `,{tools:d.mode?.tools,messages:d.prompt}),o.error(`LLM error, name: ${l} => `,e)}}return Promise.reject(r||new Error("No LLM available"))}async getLLM(e){const t=this.llms[e];if(!t)return null;let n,s;if(n="string"==typeof t.apiKey?t.apiKey:await t.apiKey(),t.config?.baseURL&&(s="string"==typeof t.config.baseURL?t.config.baseURL:await t.config.baseURL()),"openai"==t.provider)return wo({apiKey:n,baseURL:s,fetch:t.fetch,organization:t.config?.organization,project:t.config?.project,headers:t.config?.headers,compatibility:t.config?.compatibility}).languageModel(t.model);if("anthropic"==t.provider)return Do({apiKey:n,baseURL:s,fetch:t.fetch,headers:t.config?.headers}).languageModel(t.model);if("google"==t.provider)return sr({apiKey:n,baseURL:s,fetch:t.fetch,headers:t.config?.headers}).languageModel(t.model);if("aws"==t.provider){let e=n.split("=");return sa({accessKeyId:e[0],secretAccessKey:e[1],baseURL:s,region:t.config?.region||"us-west-1",fetch:t.fetch,headers:t.config?.headers,sessionToken:t.config?.sessionToken}).languageModel(t.model)}return"openrouter"==t.provider?Ra({apiKey:n,baseURL:s,fetch:t.fetch,headers:t.config?.headers,compatibility:t.config?.compatibility}).languageModel(t.model):t.provider.languageModel(t.model)}streamWrapper(e,t,n){let s=null;return new ReadableStream({start:t=>{if(null!=e&&e.length>0)for(let n=0;n<e.length;n++)t.enqueue(e[n])},pull:async e=>{s=setTimeout(()=>{n.abort("Streaming request timeout")},this.stream_token_timeout);const{done:o,value:r}=await t.read();if(clearTimeout(s),o)return e.close(),void t.releaseLock();e.enqueue(r)},cancel:e=>{s&&clearTimeout(s),t.cancel(e)}})}get Llms(){return this.llms}get Names(){return this.names}}var Da,$a,Ua={},Pa={},qa={};function La(){if($a)return qa;$a=1;var e=/[A-Z_a-z\xC0-\xD6\xD8-\xF6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,t=new RegExp("[\\-\\.0-9"+e.source.slice(1,-1)+"\\u00B7\\u0300-\\u036F\\u203F-\\u2040]"),n=new RegExp("^"+e.source+t.source+"*(?::"+e.source+t.source+"*)?$");function s(e,t){this.message=e,this.locator=t,Error.captureStackTrace&&Error.captureStackTrace(this,s)}function o(){}function r(e,t){return t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber,t}function a(e,t,n,s,o,r){function a(e,t,s){e in n.attributeNames&&r.fatalError("Attribute "+e+" redefined"),n.addValue(e,t,s)}for(var i,l=++t,u=0;;){var c=e.charAt(l);switch(c){case"=":if(1===u)i=e.slice(t,l),u=3;else{if(2!==u)throw new Error("attribute equal must after attrName");u=3}break;case"'":case'"':if(3===u||1===u){if(1===u&&(r.warning('attribute value must after "="'),i=e.slice(t,l)),t=l+1,!((l=e.indexOf(c,t))>0))throw new Error("attribute value no end '"+c+"' match");a(i,d=e.slice(t,l).replace(/&#?\w+;/g,o),t-1),u=5}else{if(4!=u)throw new Error('attribute value must after "="');a(i,d=e.slice(t,l).replace(/&#?\w+;/g,o),t),r.warning('attribute "'+i+'" missed start quot('+c+")!!"),t=l+1,u=5}break;case"/":switch(u){case 0:n.setTagName(e.slice(t,l));case 5:case 6:case 7:u=7,n.closed=!0;case 4:case 1:case 2:break;default:throw new Error("attribute invalid close char('/')")}break;case"":return r.error("unexpected end of input"),0==u&&n.setTagName(e.slice(t,l)),l;case">":switch(u){case 0:n.setTagName(e.slice(t,l));case 5:case 6:case 7:break;case 4:case 1:"/"===(d=e.slice(t,l)).slice(-1)&&(n.closed=!0,d=d.slice(0,-1));case 2:2===u&&(d=i),4==u?(r.warning('attribute "'+d+'" missed quot(")!'),a(i,d.replace(/&#?\w+;/g,o),t)):("http://www.w3.org/1999/xhtml"===s[""]&&d.match(/^(?:disabled|checked|selected)$/i)||r.warning('attribute "'+d+'" missed value!! "'+d+'" instead!!'),a(d,d,t));break;case 3:throw new Error("attribute value missed!!")}return l;case"":c=" ";default:if(c<=" ")switch(u){case 0:n.setTagName(e.slice(t,l)),u=6;break;case 1:i=e.slice(t,l),u=2;break;case 4:var d=e.slice(t,l).replace(/&#?\w+;/g,o);r.warning('attribute "'+d+'" missed quot(")!!'),a(i,d,t);case 5:u=6}else switch(u){case 2:n.tagName,"http://www.w3.org/1999/xhtml"===s[""]&&i.match(/^(?:disabled|checked|selected)$/i)||r.warning('attribute "'+i+'" missed value!! "'+i+'" instead2!!'),a(i,i,t),t=l,u=1;break;case 5:r.warning('attribute space is required"'+i+'"!!');case 6:u=1,t=l;break;case 3:u=4,t=l;break;case 7:throw new Error("elements closed character '/' and '>' must be connected to")}}l++}}function i(e,t,n){for(var s=e.tagName,o=null,r=e.length;r--;){var a=e[r],i=a.qName,l=a.value;if((h=i.indexOf(":"))>0)var u=a.prefix=i.slice(0,h),d=i.slice(h+1),p="xmlns"===u&&d;else d=i,u=null,p="xmlns"===i&&"";a.localName=d,!1!==p&&(null==o&&(o={},c(n,n={})),n[p]=o[p]=l,a.uri="http://www.w3.org/2000/xmlns/",t.startPrefixMapping(p,l))}for(r=e.length;r--;)(u=(a=e[r]).prefix)&&("xml"===u&&(a.uri="http://www.w3.org/XML/1998/namespace"),"xmlns"!==u&&(a.uri=n[u||""]));var h;(h=s.indexOf(":"))>0?(u=e.prefix=s.slice(0,h),d=e.localName=s.slice(h+1)):(u=null,d=e.localName=s);var m=e.uri=n[u||""];if(t.startElement(m,d,s,e),!e.closed)return e.currentNSMap=n,e.localNSMap=o,!0;if(t.endElement(m,d,s),o)for(u in o)t.endPrefixMapping(u)}function l(e,t,n,s,o){if(/^(?:script|textarea)$/i.test(n)){var r=e.indexOf("</"+n+">",t),a=e.substring(t+1,r);if(/[&<]/.test(a))return/^script$/i.test(n)?(o.characters(a,0,a.length),r):(a=a.replace(/&#?\w+;/g,s),o.characters(a,0,a.length),r)}return t+1}function u(e,t,n,s){var o=s[n];return null==o&&((o=e.lastIndexOf("</"+n+">"))<t&&(o=e.lastIndexOf("</"+n)),s[n]=o),o<t}function c(e,t){for(var n in e)t[n]=e[n]}function d(e,t,n,s){if("-"===e.charAt(t+2))return"-"===e.charAt(t+3)?(o=e.indexOf("--\x3e",t+4))>t?(n.comment(e,t+4,o-t-4),o+3):(s.error("Unclosed comment"),-1):-1;if("CDATA["==e.substr(t+3,6)){var o=e.indexOf("]]>",t+9);return n.startCDATA(),n.characters(e,t+9,o-t-9),n.endCDATA(),o+3}var r=function(e,t){var n,s=[],o=/'[^']+'|"[^"]+"|[^\s<>\/=]+=?|(\/?\s*>|<)/g;for(o.lastIndex=t,o.exec(e);n=o.exec(e);)if(s.push(n),n[1])return s}(e,t),a=r.length;if(a>1&&/!doctype/i.test(r[0][0])){var i=r[1][0],l=!1,u=!1;a>3&&(/^public$/i.test(r[2][0])?(l=r[3][0],u=a>4&&r[4][0]):/^system$/i.test(r[2][0])&&(u=r[3][0]));var c=r[a-1];return n.startDTD(i,l,u),n.endDTD(),c.index+c[0].length}return-1}function p(e,t,n){var s=e.indexOf("?>",t);if(s){var o=e.substring(t,s).match(/^<\?(\S*)\s*([\s\S]*?)\s*$/);return o?(o[0].length,n.processingInstruction(o[1],o[2]),s+2):-1}return-1}function h(){this.attributeNames={}}return s.prototype=new Error,s.prototype.name=s.name,o.prototype={parse:function(e,t,n){var o=this.domBuilder;o.startDocument(),c(t,t={}),function(e,t,n,o,c){function m(e){var t=e.slice(1,-1);return t in n?n[t]:"#"===t.charAt(0)?function(e){if(e>65535){var t=55296+((e-=65536)>>10),n=56320+(1023&e);return String.fromCharCode(t,n)}return String.fromCharCode(e)}(parseInt(t.substr(1).replace("x","0x"))):(c.error("entity not found:"+e),e)}function g(t){if(t>k){var n=e.substring(k,t).replace(/&#?\w+;/g,m);w&&f(k),o.characters(n,0,t-k),k=t}}function f(t,n){for(;t>=b&&(n=v.exec(e));)y=n.index,b=y+n[0].length,w.lineNumber++;w.columnNumber=t-y+1}for(var y=0,b=0,v=/.*(?:\r\n?|\n)|.*$/g,w=o.locator,_=[{currentNSMap:t}],x={},k=0;;){try{var T=e.indexOf("<",k);if(T<0){if(!e.substr(k).match(/^\s*$/)){var N=o.doc,I=N.createTextNode(e.substr(k));N.appendChild(I),o.currentElement=I}return}switch(T>k&&g(T),e.charAt(T+1)){case"/":var C=e.indexOf(">",T+3),S=e.substring(T+2,C),E=_.pop();C<0?(S=e.substring(T+2).replace(/[\s<].*/,""),c.error("end tag name: "+S+" is not complete:"+E.tagName),C=T+1+S.length):S.match(/\s</)&&(S=S.replace(/[\s<].*/,""),c.error("end tag name: "+S+" maybe not complete"),C=T+1+S.length);var A=E.localNSMap,O=E.tagName==S;if(O||E.tagName&&E.tagName.toLowerCase()==S.toLowerCase()){if(o.endElement(E.uri,E.localName,S),A)for(var j in A)o.endPrefixMapping(j);O||c.fatalError("end tag name: "+S+" is not match the current start tagName:"+E.tagName)}else _.push(E);C++;break;case"?":w&&f(T),C=p(e,T,o);break;case"!":w&&f(T),C=d(e,T,o,c);break;default:w&&f(T);var R=new h,M=_[_.length-1].currentNSMap,D=(C=a(e,T,R,M,m,c),R.length);if(!R.closed&&u(e,C,R.tagName,x)&&(R.closed=!0,n.nbsp||c.warning("unclosed xml attribute")),w&&D){for(var $=r(w,{}),U=0;U<D;U++){var P=R[U];f(P.offset),P.locator=r(w,{})}o.locator=$,i(R,o,M)&&_.push(R),o.locator=w}else i(R,o,M)&&_.push(R);"http://www.w3.org/1999/xhtml"!==R.uri||R.closed?C++:C=l(e,C,R.tagName,m,o)}}catch(e){if(e instanceof s)throw e;c.error("element parse error: "+e),C=-1}C>k?k=C:g(Math.max(T,k)+1)}}(e,t,n,o,this.errorHandler),o.endDocument()}},h.prototype={setTagName:function(e){if(!n.test(e))throw new Error("invalid tagName:"+e);this.tagName=e},addValue:function(e,t,s){if(!n.test(e))throw new Error("invalid attribute:"+e);this.attributeNames[e]=this.length,this[this.length++]={qName:e,value:t,offset:s}},length:0,getLocalName:function(e){return this[e].localName},getLocator:function(e){return this[e].locator},getQName:function(e){return this[e].qName},getURI:function(e){return this[e].uri},getValue:function(e){return this[e].value}},qa.XMLReader=o,qa.ParseError=s,qa}var Fa,Ba,Ha={};function Za(){if(Fa)return Ha;function e(e,t){for(var n in e)t[n]=e[n]}function t(t,n){var s=t.prototype;if(!(s instanceof n)){function o(){}o.prototype=n.prototype,e(s,o=new o),t.prototype=s=o}s.constructor!=t&&("function"!=typeof t&&console.error("unknow Class:"+t),s.constructor=t)}Fa=1;var n={},s=n.ELEMENT_NODE=1,o=n.ATTRIBUTE_NODE=2,r=n.TEXT_NODE=3,a=n.CDATA_SECTION_NODE=4,i=n.ENTITY_REFERENCE_NODE=5,l=n.ENTITY_NODE=6,u=n.PROCESSING_INSTRUCTION_NODE=7,c=n.COMMENT_NODE=8,d=n.DOCUMENT_NODE=9,p=n.DOCUMENT_TYPE_NODE=10,h=n.DOCUMENT_FRAGMENT_NODE=11,m=n.NOTATION_NODE=12,g={},f={};g.INDEX_SIZE_ERR=(f[1]="Index size error",1),g.DOMSTRING_SIZE_ERR=(f[2]="DOMString size error",2);var y=g.HIERARCHY_REQUEST_ERR=(f[3]="Hierarchy request error",3);g.WRONG_DOCUMENT_ERR=(f[4]="Wrong document",4),g.INVALID_CHARACTER_ERR=(f[5]="Invalid character",5),g.NO_DATA_ALLOWED_ERR=(f[6]="No data allowed",6),g.NO_MODIFICATION_ALLOWED_ERR=(f[7]="No modification allowed",7);var b=g.NOT_FOUND_ERR=(f[8]="Not found",8);g.NOT_SUPPORTED_ERR=(f[9]="Not supported",9);var v=g.INUSE_ATTRIBUTE_ERR=(f[10]="Attribute in use",10);function w(e,t){if(t instanceof Error)var n=t;else n=this,Error.call(this,f[e]),this.message=f[e],Error.captureStackTrace&&Error.captureStackTrace(this,w);return n.code=e,t&&(this.message=this.message+": "+t),n}function _(){}function x(e,t){this._node=e,this._refresh=t,k(this)}function k(t){var n=t._node._inc||t._node.ownerDocument._inc;if(t._inc!=n){var s=t._refresh(t._node);te(t,"length",s.length),e(s,t),t._inc=n}}function T(){}function N(e,t){for(var n=e.length;n--;)if(e[n]===t)return n}function I(e,t,n,s){if(s?t[N(t,s)]=n:t[t.length++]=n,e){n.ownerElement=e;var o=e.ownerDocument;o&&(s&&R(o,e,s),function(e,t,n){e&&e._inc++,"http://www.w3.org/2000/xmlns/"==n.namespaceURI&&(t._nsMap[n.prefix?n.localName:""]=n.value)}(o,e,n))}}function C(e,t,n){var s=N(t,n);if(!(s>=0))throw w(b,new Error(e.tagName+"@"+n));for(var o=t.length-1;s<o;)t[s]=t[++s];if(t.length=o,e){var r=e.ownerDocument;r&&(R(r,e,n),n.ownerElement=null)}}function S(e){if(this._features={},e)for(var t in e)this._features=e[t]}function E(){}function A(e){return("<"==e?"&lt;":">"==e&&"&gt;")||"&"==e&&"&amp;"||'"'==e&&"&quot;"||"&#"+e.charCodeAt()+";"}function O(e,t){if(t(e))return!0;if(e=e.firstChild)do{if(O(e,t))return!0}while(e=e.nextSibling)}function j(){}function R(e,t,n,s){e&&e._inc++,"http://www.w3.org/2000/xmlns/"==n.namespaceURI&&delete t._nsMap[n.prefix?n.localName:""]}function M(e,t,n){if(e&&e._inc){e._inc++;var s=t.childNodes;if(n)s[s.length++]=n;else{for(var o=t.firstChild,r=0;o;)s[r++]=o,o=o.nextSibling;s.length=r}}}function D(e,t){var n=t.previousSibling,s=t.nextSibling;return n?n.nextSibling=s:e.firstChild=s,s?s.previousSibling=n:e.lastChild=n,M(e.ownerDocument,e),t}function $(e,t,n){var s=t.parentNode;if(s&&s.removeChild(t),t.nodeType===h){var o=t.firstChild;if(null==o)return t;var r=t.lastChild}else o=r=t;var a=n?n.previousSibling:e.lastChild;o.previousSibling=a,r.nextSibling=n,a?a.nextSibling=o:e.firstChild=o,null==n?e.lastChild=r:n.previousSibling=r;do{o.parentNode=e}while(o!==r&&(o=o.nextSibling));return M(e.ownerDocument||e,e),t.nodeType==h&&(t.firstChild=t.lastChild=null),t}function U(){this._nsMap={}}function P(){}function q(){}function L(){}function F(){}function B(){}function H(){}function Z(){}function W(){}function V(){}function z(){}function K(){}function G(){}function J(e,t){var n=[],s=9==this.nodeType&&this.documentElement||this,o=s.prefix,r=s.namespaceURI;if(r&&null==o&&null==(o=s.lookupPrefix(r)))var a=[{namespace:r,prefix:null}];return Y(this,n,e,t,a),n.join("")}function X(e,t,n){var s=e.prefix||"",o=e.namespaceURI;if(!s&&!o)return!1;if("xml"===s&&"http://www.w3.org/XML/1998/namespace"===o||"http://www.w3.org/2000/xmlns/"==o)return!1;for(var r=n.length;r--;){var a=n[r];if(a.prefix==s)return a.namespace!=o}return!0}function Y(e,t,n,l,m){if(l){if(!(e=l(e)))return;if("string"==typeof e)return void t.push(e)}switch(e.nodeType){case s:m||(m=[]),m.length;var g=e.attributes,f=g.length,y=e.firstChild,b=e.tagName;n="http://www.w3.org/1999/xhtml"===e.namespaceURI||n,t.push("<",b);for(var v=0;v<f;v++)"xmlns"==(w=g.item(v)).prefix?m.push({prefix:w.localName,namespace:w.value}):"xmlns"==w.nodeName&&m.push({prefix:"",namespace:w.value});for(v=0;v<f;v++){var w;if(X(w=g.item(v),0,m)){var _=w.prefix||"",x=w.namespaceURI,k=_?" xmlns:"+_:" xmlns";t.push(k,'="',x,'"'),m.push({prefix:_,namespace:x})}Y(w,t,n,l,m)}if(X(e,0,m)&&(_=e.prefix||"",(x=e.namespaceURI)&&(k=_?" xmlns:"+_:" xmlns",t.push(k,'="',x,'"'),m.push({prefix:_,namespace:x}))),y||n&&!/^(?:meta|link|img|br|hr|input)$/i.test(b)){if(t.push(">"),n&&/^script$/i.test(b))for(;y;)y.data?t.push(y.data):Y(y,t,n,l,m),y=y.nextSibling;else for(;y;)Y(y,t,n,l,m),y=y.nextSibling;t.push("</",b,">")}else t.push("/>");return;case d:case h:for(y=e.firstChild;y;)Y(y,t,n,l,m),y=y.nextSibling;return;case o:return t.push(" ",e.name,'="',e.value.replace(/[<&"]/g,A),'"');case r:return t.push(e.data.replace(/[<&]/g,A).replace(/]]>/g,"]]&gt;"));case a:return t.push("<![CDATA[",e.data,"]]>");case c:return t.push("\x3c!--",e.data,"--\x3e");case p:var T=e.publicId,N=e.systemId;if(t.push("<!DOCTYPE ",e.name),T)t.push(" PUBLIC ",T),N&&"."!=N&&t.push(" ",N),t.push(">");else if(N&&"."!=N)t.push(" SYSTEM ",N,">");else{var I=e.internalSubset;I&&t.push(" [",I,"]"),t.push(">")}return;case u:return t.push("<?",e.target," ",e.data,"?>");case i:return t.push("&",e.nodeName,";");default:t.push("??",e.nodeName)}}function Q(e,t,n){var r;switch(t.nodeType){case s:(r=t.cloneNode(!1)).ownerDocument=e;case h:break;case o:n=!0}if(r||(r=t.cloneNode(!1)),r.ownerDocument=e,r.parentNode=null,n)for(var a=t.firstChild;a;)r.appendChild(Q(e,a,n)),a=a.nextSibling;return r}function ee(e,t,n){var r=new t.constructor;for(var a in t){var i=t[a];"object"!=typeof i&&i!=r[a]&&(r[a]=i)}switch(t.childNodes&&(r.childNodes=new _),r.ownerDocument=e,r.nodeType){case s:var l=t.attributes,u=r.attributes=new T,c=l.length;u._ownerElement=r;for(var d=0;d<c;d++)r.setAttributeNode(ee(e,l.item(d),!0));break;case o:n=!0}if(n)for(var p=t.firstChild;p;)r.appendChild(ee(e,p,n)),p=p.nextSibling;return r}function te(e,t,n){e[t]=n}g.INVALID_STATE_ERR=(f[11]="Invalid state",11),g.SYNTAX_ERR=(f[12]="Syntax error",12),g.INVALID_MODIFICATION_ERR=(f[13]="Invalid modification",13),g.NAMESPACE_ERR=(f[14]="Invalid namespace",14),g.INVALID_ACCESS_ERR=(f[15]="Invalid access",15),w.prototype=Error.prototype,e(g,w),_.prototype={length:0,item:function(e){return this[e]||null},toString:function(e,t){for(var n=[],s=0;s<this.length;s++)Y(this[s],n,e,t);return n.join("")}},x.prototype.item=function(e){return k(this),this[e]},t(x,_),T.prototype={length:0,item:_.prototype.item,getNamedItem:function(e){for(var t=this.length;t--;){var n=this[t];if(n.nodeName==e)return n}},setNamedItem:function(e){var t=e.ownerElement;if(t&&t!=this._ownerElement)throw new w(v);var n=this.getNamedItem(e.nodeName);return I(this._ownerElement,this,e,n),n},setNamedItemNS:function(e){var t,n=e.ownerElement;if(n&&n!=this._ownerElement)throw new w(v);return t=this.getNamedItemNS(e.namespaceURI,e.localName),I(this._ownerElement,this,e,t),t},removeNamedItem:function(e){var t=this.getNamedItem(e);return C(this._ownerElement,this,t),t},removeNamedItemNS:function(e,t){var n=this.getNamedItemNS(e,t);return C(this._ownerElement,this,n),n},getNamedItemNS:function(e,t){for(var n=this.length;n--;){var s=this[n];if(s.localName==t&&s.namespaceURI==e)return s}return null}},S.prototype={hasFeature:function(e,t){var n=this._features[e.toLowerCase()];return!(!n||t&&!(t in n))},createDocument:function(e,t,n){var s=new j;if(s.implementation=this,s.childNodes=new _,s.doctype=n,n&&s.appendChild(n),t){var o=s.createElementNS(e,t);s.appendChild(o)}return s},createDocumentType:function(e,t,n){var s=new H;return s.name=e,s.nodeName=e,s.publicId=t,s.systemId=n,s}},E.prototype={firstChild:null,lastChild:null,previousSibling:null,nextSibling:null,attributes:null,parentNode:null,childNodes:null,ownerDocument:null,nodeValue:null,namespaceURI:null,prefix:null,localName:null,insertBefore:function(e,t){return $(this,e,t)},replaceChild:function(e,t){this.insertBefore(e,t),t&&this.removeChild(t)},removeChild:function(e){return D(this,e)},appendChild:function(e){return this.insertBefore(e,null)},hasChildNodes:function(){return null!=this.firstChild},cloneNode:function(e){return ee(this.ownerDocument||this,this,e)},normalize:function(){for(var e=this.firstChild;e;){var t=e.nextSibling;t&&t.nodeType==r&&e.nodeType==r?(this.removeChild(t),e.appendData(t.data)):(e.normalize(),e=t)}},isSupported:function(e,t){return this.ownerDocument.implementation.hasFeature(e,t)},hasAttributes:function(){return this.attributes.length>0},lookupPrefix:function(e){for(var t=this;t;){var n=t._nsMap;if(n)for(var s in n)if(n[s]==e)return s;t=t.nodeType==o?t.ownerDocument:t.parentNode}return null},lookupNamespaceURI:function(e){for(var t=this;t;){var n=t._nsMap;if(n&&e in n)return n[e];t=t.nodeType==o?t.ownerDocument:t.parentNode}return null},isDefaultNamespace:function(e){return null==this.lookupPrefix(e)}},e(n,E),e(n,E.prototype),j.prototype={nodeName:"#document",nodeType:d,doctype:null,documentElement:null,_inc:1,insertBefore:function(e,t){if(e.nodeType==h){for(var n=e.firstChild;n;){var o=n.nextSibling;this.insertBefore(n,t),n=o}return e}return null==this.documentElement&&e.nodeType==s&&(this.documentElement=e),$(this,e,t),e.ownerDocument=this,e},removeChild:function(e){return this.documentElement==e&&(this.documentElement=null),D(this,e)},importNode:function(e,t){return Q(this,e,t)},getElementById:function(e){var t=null;return O(this.documentElement,function(n){if(n.nodeType==s&&n.getAttribute("id")==e)return t=n,!0}),t},getElementsByClassName:function(e){var t=new RegExp("(^|\\s)"+e+"(\\s|$)");return new x(this,function(e){var n=[];return O(e.documentElement,function(o){o!==e&&o.nodeType==s&&t.test(o.getAttribute("class"))&&n.push(o)}),n})},createElement:function(e){var t=new U;return t.ownerDocument=this,t.nodeName=e,t.tagName=e,t.childNodes=new _,(t.attributes=new T)._ownerElement=t,t},createDocumentFragment:function(){var e=new z;return e.ownerDocument=this,e.childNodes=new _,e},createTextNode:function(e){var t=new L;return t.ownerDocument=this,t.appendData(e),t},createComment:function(e){var t=new F;return t.ownerDocument=this,t.appendData(e),t},createCDATASection:function(e){var t=new B;return t.ownerDocument=this,t.appendData(e),t},createProcessingInstruction:function(e,t){var n=new K;return n.ownerDocument=this,n.tagName=n.target=e,n.nodeValue=n.data=t,n},createAttribute:function(e){var t=new P;return t.ownerDocument=this,t.name=e,t.nodeName=e,t.localName=e,t.specified=!0,t},createEntityReference:function(e){var t=new V;return t.ownerDocument=this,t.nodeName=e,t},createElementNS:function(e,t){var n=new U,s=t.split(":"),o=n.attributes=new T;return n.childNodes=new _,n.ownerDocument=this,n.nodeName=t,n.tagName=t,n.namespaceURI=e,2==s.length?(n.prefix=s[0],n.localName=s[1]):n.localName=t,o._ownerElement=n,n},createAttributeNS:function(e,t){var n=new P,s=t.split(":");return n.ownerDocument=this,n.nodeName=t,n.name=t,n.namespaceURI=e,n.specified=!0,2==s.length?(n.prefix=s[0],n.localName=s[1]):n.localName=t,n}},t(j,E),U.prototype={nodeType:s,hasAttribute:function(e){return null!=this.getAttributeNode(e)},getAttribute:function(e){var t=this.getAttributeNode(e);return t&&t.value||""},getAttributeNode:function(e){return this.attributes.getNamedItem(e)},setAttribute:function(e,t){var n=this.ownerDocument.createAttribute(e);n.value=n.nodeValue=""+t,this.setAttributeNode(n)},removeAttribute:function(e){var t=this.getAttributeNode(e);t&&this.removeAttributeNode(t)},appendChild:function(e){return e.nodeType===h?this.insertBefore(e,null):function(e,t){var n=t.parentNode;if(n){var s=e.lastChild;n.removeChild(t),s=e.lastChild}return s=e.lastChild,t.parentNode=e,t.previousSibling=s,t.nextSibling=null,s?s.nextSibling=t:e.firstChild=t,e.lastChild=t,M(e.ownerDocument,e,t),t}(this,e)},setAttributeNode:function(e){return this.attributes.setNamedItem(e)},setAttributeNodeNS:function(e){return this.attributes.setNamedItemNS(e)},removeAttributeNode:function(e){return this.attributes.removeNamedItem(e.nodeName)},removeAttributeNS:function(e,t){var n=this.getAttributeNodeNS(e,t);n&&this.removeAttributeNode(n)},hasAttributeNS:function(e,t){return null!=this.getAttributeNodeNS(e,t)},getAttributeNS:function(e,t){var n=this.getAttributeNodeNS(e,t);return n&&n.value||""},setAttributeNS:function(e,t,n){var s=this.ownerDocument.createAttributeNS(e,t);s.value=s.nodeValue=""+n,this.setAttributeNode(s)},getAttributeNodeNS:function(e,t){return this.attributes.getNamedItemNS(e,t)},getElementsByTagName:function(e){return new x(this,function(t){var n=[];return O(t,function(o){o===t||o.nodeType!=s||"*"!==e&&o.tagName!=e||n.push(o)}),n})},getElementsByTagNameNS:function(e,t){return new x(this,function(n){var o=[];return O(n,function(r){r===n||r.nodeType!==s||"*"!==e&&r.namespaceURI!==e||"*"!==t&&r.localName!=t||o.push(r)}),o})}},j.prototype.getElementsByTagName=U.prototype.getElementsByTagName,j.prototype.getElementsByTagNameNS=U.prototype.getElementsByTagNameNS,t(U,E),P.prototype.nodeType=o,t(P,E),q.prototype={data:"",substringData:function(e,t){return this.data.substring(e,e+t)},appendData:function(e){e=this.data+e,this.nodeValue=this.data=e,this.length=e.length},insertData:function(e,t){this.replaceData(e,0,t)},appendChild:function(e){throw new Error(f[y])},deleteData:function(e,t){this.replaceData(e,t,"")},replaceData:function(e,t,n){n=this.data.substring(0,e)+n+this.data.substring(e+t),this.nodeValue=this.data=n,this.length=n.length}},t(q,E),L.prototype={nodeName:"#text",nodeType:r,splitText:function(e){var t=this.data,n=t.substring(e);t=t.substring(0,e),this.data=this.nodeValue=t,this.length=t.length;var s=this.ownerDocument.createTextNode(n);return this.parentNode&&this.parentNode.insertBefore(s,this.nextSibling),s}},t(L,q),F.prototype={nodeName:"#comment",nodeType:c},t(F,q),B.prototype={nodeName:"#cdata-section",nodeType:a},t(B,q),H.prototype.nodeType=p,t(H,E),Z.prototype.nodeType=m,t(Z,E),W.prototype.nodeType=l,t(W,E),V.prototype.nodeType=i,t(V,E),z.prototype.nodeName="#document-fragment",z.prototype.nodeType=h,t(z,E),K.prototype.nodeType=u,t(K,E),G.prototype.serializeToString=function(e,t,n){return J.call(e,t,n)},E.prototype.toString=J;try{if(Object.defineProperty){function ne(e){switch(e.nodeType){case s:case h:var t=[];for(e=e.firstChild;e;)7!==e.nodeType&&8!==e.nodeType&&t.push(ne(e)),e=e.nextSibling;return t.join("");default:return e.nodeValue}}Object.defineProperty(x.prototype,"length",{get:function(){return k(this),this.$$length}}),Object.defineProperty(E.prototype,"textContent",{get:function(){return ne(this)},set:function(e){switch(this.nodeType){case s:case h:for(;this.firstChild;)this.removeChild(this.firstChild);(e||String(e))&&this.appendChild(this.ownerDocument.createTextNode(e));break;default:this.data=e,this.value=e,this.nodeValue=e}}}),te=function(e,t,n){e["$$"+t]=n}}}catch(se){}return Ha.Node=E,Ha.DOMException=w,Ha.DOMImplementation=S,Ha.XMLSerializer=G,Ha}var Wa=function(){if(Ba)return Ua;function e(e){this.options=e||{locator:{}}}function t(){this.cdata=!1}function n(e,t){t.lineNumber=e.lineNumber,t.columnNumber=e.columnNumber}function s(e){if(e)return"\n@"+(e.systemId||"")+"#[line:"+e.lineNumber+",col:"+e.columnNumber+"]"}function o(e,t,n){return"string"==typeof e?e.substr(t,n):e.length>=t+n||t?new java.lang.String(e,t,n)+"":e}function r(e,t){e.currentElement?e.currentElement.appendChild(t):e.doc.appendChild(t)}Ba=1,e.prototype.parseFromString=function(e,n){var o=this.options,r=new l,i=o.domBuilder||new t,u=o.errorHandler,c=o.locator,d=o.xmlns||{},p=/\/x?html?$/.test(n),h=p?a.entityMap:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"};return c&&i.setDocumentLocator(c),r.errorHandler=function(e,n,o){if(!e){if(n instanceof t)return n;e=n}var r={},a=e instanceof Function;function i(t){var n=e[t];!n&&a&&(n=2==e.length?function(n){e(t,n)}:e),r[t]=n&&function(e){n("[xmldom "+t+"]\t"+e+s(o))}||function(){}}return o=o||{},i("warning"),i("error"),i("fatalError"),r}(u,i,c),r.domBuilder=o.domBuilder||i,p&&(d[""]="http://www.w3.org/1999/xhtml"),d.xml=d.xml||"http://www.w3.org/XML/1998/namespace",e&&"string"==typeof e?r.parse(e,d,h):r.errorHandler.error("invalid doc source"),i.doc},t.prototype={startDocument:function(){this.doc=(new c).createDocument(null,null,null),this.locator&&(this.doc.documentURI=this.locator.systemId)},startElement:function(e,t,s,o){var a=this.doc,i=a.createElementNS(e,s||t),l=o.length;r(this,i),this.currentElement=i,this.locator&&n(this.locator,i);for(var u=0;u<l;u++){e=o.getURI(u);var c=o.getValue(u),d=(s=o.getQName(u),a.createAttributeNS(e,s));this.locator&&n(o.getLocator(u),d),d.value=d.nodeValue=c,i.setAttributeNode(d)}},endElement:function(e,t,n){var s=this.currentElement;s.tagName,this.currentElement=s.parentNode},startPrefixMapping:function(e,t){},endPrefixMapping:function(e){},processingInstruction:function(e,t){var s=this.doc.createProcessingInstruction(e,t);this.locator&&n(this.locator,s),r(this,s)},ignorableWhitespace:function(e,t,n){},characters:function(e,t,s){if(e=o.apply(this,arguments)){if(this.cdata)var r=this.doc.createCDATASection(e);else r=this.doc.createTextNode(e);this.currentElement?this.currentElement.appendChild(r):/^\s*$/.test(e)&&this.doc.appendChild(r),this.locator&&n(this.locator,r)}},skippedEntity:function(e){},endDocument:function(){this.doc.normalize()},setDocumentLocator:function(e){(this.locator=e)&&(e.lineNumber=0)},comment:function(e,t,s){e=o.apply(this,arguments);var a=this.doc.createComment(e);this.locator&&n(this.locator,a),r(this,a)},startCDATA:function(){this.cdata=!0},endCDATA:function(){this.cdata=!1},startDTD:function(e,t,s){var o=this.doc.implementation;if(o&&o.createDocumentType){var a=o.createDocumentType(e,t,s);this.locator&&n(this.locator,a),r(this,a)}},warning:function(e){console.warn("[xmldom warning]\t"+e,s(this.locator))},error:function(e){console.error("[xmldom error]\t"+e,s(this.locator))},fatalError:function(e){throw new u(e,this.locator)}},"endDTD,startEntity,endEntity,attributeDecl,elementDecl,externalEntityDecl,internalEntityDecl,resolveEntity,getExternalSubset,notationDecl,unparsedEntityDecl".replace(/\w+/g,function(e){t.prototype[e]=function(){return null}});var a=(Da||(Da=1,Pa.entityMap={lt:"<",gt:">",amp:"&",quot:'"',apos:"'",Agrave:"À",Aacute:"Á",Acirc:"Â",Atilde:"Ã",Auml:"Ä",Aring:"Å",AElig:"Æ",Ccedil:"Ç",Egrave:"È",Eacute:"É",Ecirc:"Ê",Euml:"Ë",Igrave:"Ì",Iacute:"Í",Icirc:"Î",Iuml:"Ï",ETH:"Ð",Ntilde:"Ñ",Ograve:"Ò",Oacute:"Ó",Ocirc:"Ô",Otilde:"Õ",Ouml:"Ö",Oslash:"Ø",Ugrave:"Ù",Uacute:"Ú",Ucirc:"Û",Uuml:"Ü",Yacute:"Ý",THORN:"Þ",szlig:"ß",agrave:"à",aacute:"á",acirc:"â",atilde:"ã",auml:"ä",aring:"å",aelig:"æ",ccedil:"ç",egrave:"è",eacute:"é",ecirc:"ê",euml:"ë",igrave:"ì",iacute:"í",icirc:"î",iuml:"ï",eth:"ð",ntilde:"ñ",ograve:"ò",oacute:"ó",ocirc:"ô",otilde:"õ",ouml:"ö",oslash:"ø",ugrave:"ù",uacute:"ú",ucirc:"û",uuml:"ü",yacute:"ý",thorn:"þ",yuml:"ÿ",nbsp:" ",iexcl:"¡",cent:"¢",pound:"£",curren:"¤",yen:"¥",brvbar:"¦",sect:"§",uml:"¨",copy:"©",ordf:"ª",laquo:"«",not:"¬",shy:"­­",reg:"®",macr:"¯",deg:"°",plusmn:"±",sup2:"²",sup3:"³",acute:"´",micro:"µ",para:"¶",middot:"·",cedil:"¸",sup1:"¹",ordm:"º",raquo:"»",frac14:"¼",frac12:"½",frac34:"¾",iquest:"¿",times:"×",divide:"÷",forall:"∀",part:"∂",exist:"∃",empty:"∅",nabla:"∇",isin:"∈",notin:"∉",ni:"∋",prod:"∏",sum:"∑",minus:"−",lowast:"∗",radic:"√",prop:"∝",infin:"∞",ang:"∠",and:"∧",or:"∨",cap:"∩",cup:"∪",int:"∫",there4:"∴",sim:"∼",cong:"≅",asymp:"≈",ne:"≠",equiv:"≡",le:"≤",ge:"≥",sub:"⊂",sup:"⊃",nsub:"⊄",sube:"⊆",supe:"⊇",oplus:"⊕",otimes:"⊗",perp:"⊥",sdot:"⋅",Alpha:"Α",Beta:"Β",Gamma:"Γ",Delta:"Δ",Epsilon:"Ε",Zeta:"Ζ",Eta:"Η",Theta:"Θ",Iota:"Ι",Kappa:"Κ",Lambda:"Λ",Mu:"Μ",Nu:"Ν",Xi:"Ξ",Omicron:"Ο",Pi:"Π",Rho:"Ρ",Sigma:"Σ",Tau:"Τ",Upsilon:"Υ",Phi:"Φ",Chi:"Χ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ε",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",omicron:"ο",pi:"π",rho:"ρ",sigmaf:"ς",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",thetasym:"ϑ",upsih:"ϒ",piv:"ϖ",OElig:"Œ",oelig:"œ",Scaron:"Š",scaron:"š",Yuml:"Ÿ",fnof:"ƒ",circ:"ˆ",tilde:"˜",ensp:" ",emsp:" ",thinsp:" ",zwnj:"‌",zwj:"‍",lrm:"‎",rlm:"‏",ndash:"–",mdash:"—",lsquo:"‘",rsquo:"’",sbquo:"‚",ldquo:"“",rdquo:"”",bdquo:"„",dagger:"†",Dagger:"‡",bull:"•",hellip:"…",permil:"‰",prime:"′",Prime:"″",lsaquo:"‹",rsaquo:"›",oline:"‾",euro:"€",trade:"™",larr:"←",uarr:"↑",rarr:"→",darr:"↓",harr:"↔",crarr:"↵",lceil:"⌈",rceil:"⌉",lfloor:"⌊",rfloor:"⌋",loz:"◊",spades:"♠",clubs:"♣",hearts:"♥",diams:"♦"}),Pa),i=La(),l=i.XMLReader,u=i.ParseError,c=Ua.DOMImplementation=Za().DOMImplementation;return Ua.XMLSerializer=Za().XMLSerializer,Ua.DOMParser=e,Ua.__DOMHandler=t,Ua}();function Va(e){const t=function(e){const t=new Map,n=new Map,s=new Map;for(const o of e)t.set(o.id,o),n.set(o.id,0),s.set(o.id,[]);for(const o of e)for(const e of o.dependsOn)t.has(e)&&(s.get(e).push(o.id),n.set(o.id,n.get(o.id)+1));const o=[],r=new Map;for(const[e,t]of n.entries())0===t&&o.push(e),r.set(e,0);let a=0;for(;o.length>0;){const e=o.shift();a++;for(const t of s.get(e)){const e=n.get(t)-1;n.set(t,e),0===e&&o.push(t)}}if(a<e.length){console.warn("Detected a circular dependency, automatically disconnecting the circular link...");const s=new Set;for(const[e,t]of n.entries())t>0&&s.add(e);const o=[];for(const n of e)if(s.has(n.id)){const e=n.dependsOn.filter(e=>!s.has(e)||!t.has(e));if(0===e.length&&n.dependsOn.length>0){const o=n.dependsOn.find(e=>t.has(e));o&&!s.has(o)&&e.push(o)}n.dependsOn=e,o.push(n),e.length!==n.dependsOn.length&&console.warn(`The partial cyclic dependency of agent ${n.id} has been disconnected.`)}else{const e=n.dependsOn.filter(e=>t.has(e));n.dependsOn=e,o.push(n)}return o}return e.map(e=>(e.dependsOn=e.dependsOn.filter(e=>t.has(e)),e))}(e);if(0===t.length)throw new Error("No executable agent");const n=new Map,s=new Map;for(const e of t)n.set(e.id,e),s.set(e.id,[]);for(const e of t)for(const t of e.dependsOn)s.has(t)&&s.get(t).push(e);let o=t.filter(e=>0===e.dependsOn.length);0===o.length&&(o=t.filter(e=>1==e.dependsOn.length&&e.dependsOn[0].endsWith("00")));const r=new Set,a=function e(t){if(0===t.length)return;for(const e of t)r.add(e.id);const n=[],o=new Set;for(const e of t){const t=s.get(e.id)||[];for(const e of t)e.dependsOn.every(e=>r.has(e))&&!o.has(e.id)&&(n.push(e),o.add(e.id))}const a=e(n);return 1===t.length?{type:"normal",agent:t[0],nextAgent:a}:{type:"parallel",agents:t.map(e=>({type:"normal",agent:e,nextAgent:void 0})),nextAgent:a}}(o);if(!a)throw new Error("Unable to build execution tree");return a}function za(e,t,n,s){let o=null;try{s&&(o={taskId:e,name:"",thought:s,agents:[],xml:t});let r=t.indexOf("<root>");if(-1==r)return o;let a=(t=t.substring(r)).indexOf("</root>");a>-1&&(t=t.substring(0,a+7)),n||(t=function(e){e.indexOf("&")>-1&&(e=e.replace(/&(?![a-zA-Z0-9#]+;)/g,"&amp;"));let t=e.lastIndexOf(" "),n=t>-1?e.substring(t+1):"";if(e.endsWith("="))e+='""';else if("name"==n||"id"==n||"dependsOn"==n||"input"==n||"output"==n||"items"==n||"event"==n||"loop"==n){let t=e.lastIndexOf(">"),n=e.lastIndexOf("<");t<n&&e.lastIndexOf(" ")>n&&(e+='=""')}e=function(e){const t=[];for(let n=0;n<e.length;n++){let s=e[n];"<"===s?t.push(">"):">"===s?t.pop():'"'===s&&('"'===t[t.length-1]?t.pop():t.push('"'))}const n=[];for(;t.length>0;)n.push(t.pop());return e+n.join("")}(e);const s=[];function o(e){return e.endsWith("/>")}for(let t=0;t<e.length;t++)if("<"===e[t]){const n="/"===e[t+1];let r=e.indexOf(">",t),a=e.slice(t,r+1);if(o(a)||(n?s.pop():s.push(a)),-1==r)break;t=r}const r=[];for(;s.length>0;){const e=s.pop();if(e.startsWith("<")){let t=e.match(/<(\w+)/);if(t){const e=t[1];r.push(`</${e}>`)}}else r.push(e)}return e+r.join("")}(t));let i=(new Wa.DOMParser).parseFromString(t,"text/xml").documentElement;if("root"!==i.tagName)return o;const l=[],u=i.getElementsByTagName("thought")[0]?.textContent||"",c={taskId:e,name:i.getElementsByTagName("name")[0]?.textContent||"",thought:s?s+"\n"+u:u,agents:l,xml:t};let d=i.getElementsByTagName("agents"),p=d.length>0?d[0].getElementsByTagName("agent"):[];for(let t=0;t<p.length;t++){let n=p[t],s=n.getAttribute("name");if(!s)break;let o=n.getAttribute("id")||t,r=n.getAttribute("dependsOn")||"",a=[],i={name:s,id:Ka(e,o),dependsOn:r.split(",").filter(e=>""!=e.trim()).map(t=>Ka(e,t)),task:n.getElementsByTagName("task")[0]?.textContent||"",nodes:a,status:"init",parallel:void 0,xml:n.toString()},u=n.getElementsByTagName("nodes");u.length>0&&Ga(a,u[0].childNodes),l.push(i)}if(n){let e=Va(c.agents);for(;;){if("normal"===e.type)e.agent.parallel=!1;else{const t=e.agents;for(let e=0;e<t.length;e++)t[e].agent.parallel=!0}if(!e.nextAgent)break;e=e.nextAgent}}return c}catch(e){if(n)throw e;return o}}function Ka(e,t){return e+"-"+(+t<10?"0"+t:t)}function Ga(e,t){for(let n=0;n<t.length;n++){if(1!==t[n].nodeType)continue;let s=t[n];switch(s.tagName){case"node":{let t={type:"normal",text:s.textContent||"",input:s.getAttribute("input"),output:s.getAttribute("output")};e.push(t);break}case"forEach":{let t=[],n={type:"forEach",items:s.getAttribute("items")||"list",nodes:t},o=s.getElementsByTagName("node");o.length>0&&Ga(t,o),e.push(n);break}case"watch":{let t=[],n={type:"watch",event:s.getAttribute("event")||"",loop:"true"==s.getAttribute("loop"),description:s.getElementsByTagName("description")[0]?.textContent||"",triggerNodes:t},o=s.getElementsByTagName("trigger");o.length>0&&Ga(t,o[0].childNodes),e.push(n);break}}}}function Ja(e,t,n){const s=(new Wa.DOMParser).parseFromString(e,"text/xml");let o=s.getElementsByTagName("agent"),r=s.getElementsByTagName("nodes");if(r.length>0){let e=r[0].childNodes,t=0;for(let s=0;s<e.length;s++){let o=e[s];1==o.nodeType&&(o.setAttribute("id",t+""),n&&n(t,o),t++)}}let a=function(e){let t="";const n=new Wa.XMLSerializer;for(let s=0;s<e.childNodes.length;s++)t+=n.serializeToString(e.childNodes[s]);return t}(o[0]),i=a.substring(0,a.indexOf("<task>"));return a=a.replace("<task>","<currentTask>").replace("</task>","</currentTask>"),`<root>${i}<mainTask>${t}</mainTask>${a}</root>`.replace(/      /g,"  ").replace("    </root>","</root>")}function Xa(e,t){let n=(new Wa.DOMParser).parseFromString(e,"text/xml").getElementsByTagName("nodes");if(n.length>0){let e=n[0].childNodes,s=0;for(let n=0;n<e.length;n++){let o=e[n];if(1==o.nodeType&&(null!=o.getAttribute("id")&&""!=o.getAttribute("id")||o.setAttribute("id",s+""),s++,o.getAttribute("id")==t+""))return o}}return null}class Ya{constructor(){this.name="task_snapshot",this.description="Task snapshot archive, recording key information of the current task, updating task node status, facilitating subsequent continuation of operation.",this.parameters={type:"object",properties:{doneIds:{type:"array",description:"Update task node completion status, list of completed node IDs.",items:{type:"number"}},taskSnapshot:{type:"string",description:"Current task important information, as detailed as possible, ensure that the task progress can be restored through this information later, output records of completed task information, contextual information, variables used, pending tasks information, etc."}},required:["doneIds","taskSnapshot"]}}async execute(e,t){let n=e.doneIds,s=e.taskSnapshot,o=t.agentChain.agent,r=t.context.chain.taskPrompt,a=Ja(o.xml,r,(e,t)=>{let s=n.indexOf(e)>-1;t.setAttribute("status",s?"done":"todo")});return{content:[{type:"text",text:"The current task has been interrupted. Below is a snapshot of the task execution history.\n# Task Snapshot\n"+s.trim()+"\n\n# Task\n"+a}]}}}async function Qa(e,t,n,s,i,l,u=0,c,d){await e.context.checkAborted(),n.length>=80&&!i&&await ti(e,t,n,s),l||function(e,t){const n=e.context.conversation.splice(0,e.context.conversation.length).filter(e=>!!e);if(n.length>0){const e="The user is intervening in the current task, please replan and execute according to the following instructions:\n"+n.map(e=>`- ${e.trim()}`).join("\n");t.push({role:"user",content:[{type:"text",text:e}]})}}(e,n);let p=e.context,h=e.agentChain,m=h.agent,g=c||p.config.callback||{onMessage:async()=>{}};const f=new AbortController;let y,b={tools:s,toolChoice:l,messages:n,abortSignal:AbortSignal.any([p.controller.signal,f.signal])};d&&d(b),h.agentRequest=b;try{p.currentStepControllers.add(f),y=await t.callStream(b)}catch(o){if(p.currentStepControllers.delete(f),await p.checkAborted(),!i&&n.length>=5&&((o+"").indexOf("tokens")>-1||(o+"").indexOf("too long")>-1)&&await ti(e,t,n,s),u<3)return await r(200*(u+1)*(u+1)),Qa(e,t,n,s,i,l,++u,g);throw o}let v="",w="",_="",x=a(),k=!1,T=[];const N=y.stream.getReader();try{let r=null;for(;;){await p.checkAborted();const{done:a,value:c}=await N.read();if(a)break;let d=c;switch(d.type){case"text-delta":if(r&&!d.textDelta)continue;v+=d.textDelta||"",await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"text",streamId:x,streamDone:!1,text:v},e),r&&(await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_use",toolId:r.toolCallId,toolName:r.toolName,params:r.args||{}},e),r=null);break;case"reasoning":w+=d.textDelta||"",await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"thinking",streamId:x,streamDone:!1,text:w},e);break;case"tool-call-delta":k||(k=!0,await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"text",streamId:x,streamDone:!0,text:v},e)),_+=d.argsTextDelta||"",await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_streaming",toolId:d.toolCallId,toolName:d.toolName,paramsText:_},e),null==r&&(r={type:"tool-call",toolCallId:d.toolCallId,toolName:d.toolName,args:{}},T.push(r));break;case"tool-call":{_="";let t=d.args?JSON.parse(d.args):{},n={taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_use",toolId:d.toolCallId,toolName:d.toolName,params:t};await g.onMessage(n,e),null==r?T.push({type:"tool-call",toolCallId:d.toolCallId,toolName:d.toolName,args:n.params||t}):(r.args=n.params||t,r=null);break}case"file":await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"file",mimeType:d.mimeType,data:d.data},e);break;case"error":throw o.error(`${m.name} agent error: `,d),await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"error",error:d.error},e),new Error("LLM Error: "+d.error);case"finish":if(k||(k=!0,await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"text",streamId:x,streamDone:!0,text:v},e)),r&&(await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"tool_use",toolId:r.toolCallId,toolName:r.toolName,params:r.args||{}},e),r=null),await g.onMessage({taskId:p.taskId,agentName:m.name,nodeId:m.id,type:"finish",finishReason:d.finishReason,usage:d.usage},e),"length"===d.finishReason&&n.length>=5&&!i&&u<3)return await ti(e,t,n,s),Qa(e,t,n,s,i,l,++u,g)}}}catch(o){if(await p.checkAborted(),u<3)return await r(200*(u+1)*(u+1)),Qa(e,t,n,s,i,l,++u,g);throw o}finally{N.releaseLock(),p.currentStepControllers.delete(f)}return h.agentResult=v,v?[{type:"text",text:v},...T]:T}function ei(e,t){let n=[],s=[];for(let o=0;o<e.length;o++){let r=e[o];if("tool"==r.role)for(let e=0;e<r.content.length;e++){let o=r.content[e].toolName;if(s.indexOf(o)>-1)continue;s.push(o);let a=t.filter(e=>e.name===o)[0];a&&n.push(a)}}return n}async function ti(e,t,n,s){if(!(n.length<5))try{!async function(e,t,n,s){let o=ei(n,s),r=new Ya,a=u(o,[{type:"function",name:r.name,description:r.description,parameters:r.parameters}]),i=n.length-1,l=n;for(let e=l.length-1;e>3;e--)if("tool"==l[e].role){l=l.slice(0,e+1),i=e;break}l.push({role:"user",content:[{type:"text",text:"Please create a snapshot backup of the current task, keeping only key important information and node completion status."}]});let c=(await Qa(e,t,l,a,!0,{type:"tool",toolName:r.name})).filter(e=>"tool-call"==e.type)[0],d="string"==typeof c.args?JSON.parse(c.args||"{}"):c.args||{},p=await r.execute(d,e),h=e.context.config.callback;h&&await h.onMessage({taskId:e.context.taskId,agentName:e.agent.Name,nodeId:e.agentChain.agent.id,type:"tool_result",toolId:c.toolCallId,toolName:c.toolName,params:d,toolResult:p},e);let m=3;for(let e=0;e<n.length;e++)if("tool"==n[0].role){m=e;break}n.splice(m+1,i-m-2,{role:"user",content:p.content.filter(e=>"text"==e.type)})}(e,t,n,s)}catch(e){o.error("Error compressing agent messages:",e)}}class ni{constructor(e,t){var n;this.tool="function"in(n=e)?{type:"function",name:n.function.name,description:n.function.description,parameters:n.function.parameters}:"input_schema"in n?{type:"function",name:n.name,description:n.description,parameters:n.input_schema}:"inputSchema"in n?{type:"function",name:n.name,description:n.description,parameters:n.inputSchema}:{type:"function",name:n.name,description:n.description,parameters:n.parameters},this.execute=t}get name(){return this.tool.name}getTool(){return this.tool}async callTool(e,t,n){return await this.execute.execute(e,t,n)}}class si{constructor(e,t){this.toolName=e.toolName,this.toolCallId=e.toolCallId,this.request=JSON.parse(JSON.stringify(t))}updateParams(e){this.params=e,this.onUpdate&&this.onUpdate()}updateToolResult(e){this.toolResult=e,this.onUpdate&&this.onUpdate()}}class oi{constructor(e){this.tools=[],this.agent=e}push(e){e.onUpdate=()=>{this.onUpdate&&this.onUpdate({type:"update",target:e})},this.tools.push(e),this.onUpdate&&this.onUpdate({type:"update",target:this})}}class ri{constructor(e){this.agents=[],this.listeners=[],this.taskPrompt=e}push(e){e.onUpdate=e=>{this.pub(e)},this.agents.push(e),this.pub({type:"update",target:e})}pub(e){this.listeners.forEach(t=>t(this,e))}addListener(e){this.listeners.push(e)}removeListener(e){this.listeners=this.listeners.filter(t=>t!==e)}}const ai="foreach_task";class ii{constructor(){this.name=ai,this.description="When executing the `forEach` node, please use the current tool for counting to ensure tasks are executed sequentially, the tool needs to be called with each loop iteration.",this.parameters={type:"object",properties:{nodeId:{type:"number",description:"forEach node ID."},progress:{type:"string",description:"Current execution progress."},next_step:{type:"string",description:"Next task description."}},required:["nodeId","progress","next_step"]}}async execute(e,t){let n=e.nodeId,s=Xa(t.agentChain.agent.xml,n);if(null==s)throw new Error("Node ID does not exist: "+n);if("forEach"!==s.tagName)throw new Error("Node ID is not a forEach node: "+n);let o=s.getAttribute("items"),r=null,a="Recorded";if(o&&"list"!=o&&(r=t.context.variables.get(o.trim()),r)){let e="foreach_"+n,s=t.variables.get(e)||0;s%5==0&&(a=`Variable information associated with the current loop task.\nvariable_name: ${o.trim()}\nvariable_value: ${r}`),t.variables.set(e,++s)}return{content:[{type:"text",text:a}]}}}const li="human_interact",ui="variable_storage";class ci{constructor(){this.name=ui,this.description="Used for storing, reading, and retrieving variable data, and maintaining input/output variables in task nodes.",this.parameters={type:"object",properties:{operation:{type:"string",description:"variable storage operation type.",enum:["read_variable","write_variable","list_all_variable"]},name:{type:"string",description:"variable name, required when reading and writing variables, If reading variables, it supports reading multiple variables separated by commas."},value:{type:"string",description:"variable value, required when writing variables"}},required:["operation"]}}async execute(e,t){let n="";switch(e.operation){case"read_variable":if(e.name){let s={},o=e.name.split(",");for(let e=0;e<o.length;e++){let n=o[e].trim(),r=t.context.variables.get(n);s[n]=r}n=JSON.stringify(s)}else n="Error: name is required";break;case"write_variable":{if(!e.name){n="Error: name is required";break}if(null==e.value){n="Error: value is required";break}let s=e.name;t.context.variables.set(s.trim(),e.value),n="success";break}case"list_all_variable":n=JSON.stringify(Object.keys(t.context.variables))}return{content:[{type:"text",text:n||""}]}}}const di="watch_trigger";class pi{constructor(){this.name=di,this.description="When executing the `watch` node, please use it to monitor DOM element changes, it will block the listener until the element changes or times out.",this.parameters={type:"object",properties:{nodeId:{type:"number",description:"watch node ID."},watch_area:{type:"array",description:"Element changes in monitoring area, eg: [x, y, width, height].",items:{type:"number"}},watch_index:{type:"array",description:"The index of elements to be monitoring multiple elements simultaneously.",items:{type:"number"}},frequency:{type:"number",description:"Check frequency, how many seconds between each check, default 1 seconds.",default:1,minimum:.5,maximum:30},timeout:{type:"number",description:"Timeout in minute, default 5 minutes.",default:5,minimum:1,maximum:30}},required:["nodeId"]}}async execute(e,t){let n=e.nodeId,s=Xa(t.agentChain.agent.xml,n);if(null==s)throw new Error("Node ID does not exist: "+n);if("watch"!==s.tagName)throw new Error("Node ID is not a watch node: "+n);let o=s.getElementsByTagName("description")[0]?.textContent||"";if(!o)return{content:[{type:"text",text:"The watch node does not have a description, skip."}]};await this.init_eko_observer(t);const r=await this.get_screenshot(t),a=(new Date).getTime(),i=6e4*(e.timeout||5),l=Math.max(500,1e3*(e.frequency||1));let u=new Ma(t.context.config.llms,t.agent.Llms);for(;(new Date).getTime()-a<i;){if(await t.context.checkAborted(),await new Promise(e=>setTimeout(e,l)),"false"==await this.has_eko_changed(t))continue;await this.init_eko_observer(t);const e=await this.get_screenshot(t),n=await this.is_dom_change(t,u,r,e,o);if(n.changed)return{content:[{type:"text",text:n.changeInfo||"DOM change detected."}]}}return{content:[{type:"text",text:"Timeout reached, no DOM changes detected."}]}}async get_screenshot(e){const t=e.agent.screenshot,n=await t.call(e.agent,e);return{image:l(n.imageBase64),imageType:n.imageType}}async init_eko_observer(e){try{const t=e.agent.execute_script;await t.call(e.agent,e,()=>{let e=window;e.has_eko_changed=!1,e.eko_observer&&e.eko_observer.disconnect();let t=new MutationObserver(function(t){e.has_eko_changed=!0});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0}),e.eko_observer=t},[])}catch(e){console.error("Error initializing Eko observer:",e)}}async has_eko_changed(e){try{const t=e.agent.execute_script;return await t.call(e.agent,e,()=>window.has_eko_changed+"",[])}catch(e){return console.error("Error checking Eko change:",e),"undefined"}}async is_dom_change(e,t,n,s,r){try{let o={messages:[{role:"system",content:'You are a tool for detecting element changes. Given a task description, compare two images to determine whether the changes described in the task have occurred.\nIf the changes have occurred, return an json with `changed` set to true and `changeInfo` containing a description of the changes. If no changes have occurred, return an object with `changed` set to false.\n\n## Example\nUser: Monitor new messages in group chat\n### No changes detected\nOutput:\n{\n  "changed": false\n}\n### Change detected\nOutput:\n{\n  "changed": true,\n  "changeInfo": "New message received in the group chat. The message content is: \'Hello, how are you?\'"\n}'},{role:"user",content:[{type:"image",image:n.image,mimeType:n.imageType},{type:"image",image:s.image,mimeType:s.imageType},{type:"text",text:r}]}],abortSignal:e.context.controller.signal},a=(await t.call(o)).text||"{}";return a=a.substring(a.indexOf("{"),a.lastIndexOf("}")+1),JSON.parse(a)}catch(e){o.error("Error in is_dom_change:",e)}return{changed:!1}}}class hi{constructor(e){this.toolWrapper=e,this.name=e.name,this.description=e.getTool().description,this.parameters=e.getTool().parameters}async execute(e,t,n){return this.toolWrapper.callTool(e,t,n)}}const mi=`\n* HUMAN INTERACT\nDuring the task execution process, you can use the \`${li}\` tool to interact with humans, please call it in the following situations:\n- When performing dangerous operations such as deleting files, confirmation from humans is required.\n- When encountering obstacles while accessing websites, such as requiring user login, captcha verification, QR code scanning, or human verification, you need to request manual assistance.\n- Please do not use the \`${li}\` tool frequently.\n`,gi=`\n* VARIABLE STORAGE\nWhen a step node has input/output variable attributes, use the \`${ui}\` tool to read from and write to these variables, these variables enable context sharing and coordination between multiple agents.\n`,fi=`\n* forEach node\nrepetitive tasks, when executing to the forEach node, require the use of the \`${ai}\` tool.\n`,yi=`\n* watch node\nmonitor changes in webpage DOM elements, when executing to the watch node, require the use of the \`${di}\` tool.\n`;function bi(e,t,n,s){let o=(s||e.Tools).filter(e=>"task_node_status"==e.name).length>0;return Ja(t.xml,n.chain.taskPrompt,(e,t)=>{o&&t.setAttribute("status","todo")})}class vi{constructor(e){this.tools=[],this.name=e.name,this.description=e.description,this.tools=e.tools,this.llms=e.llms,this.mcpClient=e.mcpClient,this.planDescription=e.planDescription,this.requestHandler=e.requestHandler}async run(e,t){let n=this.mcpClient||e.config.defaultMcpClient,s=new h(e,this,t);try{return this.agentContext=s,n&&!n.isConnected()&&await n.connect(),this.runWithContext(s,n,500)}finally{n&&await n.close()}}async runWithContext(e,t,n=100,s=[]){let o=0;this.agentContext=e;let r=e.context,a=e.agentChain.agent;const i=[...this.tools,...this.system_auto_tools(a)],l=[{role:"system",content:await this.buildSystemPrompt(e,i)},...s,{role:"user",content:await this.buildUserPrompt(e,i)}];e.messages=l;let c=new Ma(r.config.llms,this.llms),d=i;for(;o<n;){if(await r.checkAborted(),t){let n=await this.controlMcpTools(e,l,o);if(n.mcpTools){let e=await this.listTools(r,t,a,n.mcpParams),s=u(i,ei(l,d));d=u(s,e)}}await this.handleMessages(e,l,i);let n=await Qa(e,c,l,this.convertTools(d),!1,void 0,0,this.callback,this.requestHandler),s=await this.handleCallResult(e,l,d,n);if(s)return s;o++}return"Unfinished"}async handleCallResult(e,t,n,s){const r=e.variables.get("forceStop");if(r)return r;let a=null,i=e.context,l=[],u=[];if(0==(s=function(e){if(e.length<=1||e.filter(e=>"tool-call"==e.type).length<=1)return e;let t=[],n=[];for(let s=0;s<e.length;s++)if("tool-call"===e[s].type){let o=e[s],r=o.toolName+o.args;-1==n.indexOf(r)&&(t.push(e[s]),n.push(r))}else t.push(e[s]);return t}(s)).length)return null;for(let t=0;t<s.length;t++){let r,c=s[t];if("text"==c.type){a=c.text;continue}let d=new si(c,e.agentChain.agentRequest);e.agentChain.push(d);try{let t="string"==typeof c.args?JSON.parse(c.args||"{}"):c.args||{};d.params=t;let s=this.getTool(n,c.toolName);if(!s)throw new Error(c.toolName+" tool does not exist");r=await s.execute(t,e,c),d.updateToolResult(r),e.consecutiveErrorNum=0}catch(t){if(o.error("tool call error: ",c.toolName,c.args,t),r={content:[{type:"text",text:t+""}],isError:!0},d.updateToolResult(r),++e.consecutiveErrorNum>=10)throw t}const p=this.callback||i.config.callback;p&&await p.onMessage({taskId:i.taskId,agentName:e.agent.Name,nodeId:e.agentChain.agent.id,type:"tool_result",toolId:c.toolCallId,toolName:c.toolName,params:c.args||{},toolResult:r},e);let h=this.convertToolResult(c,r,l);u.push(h)}return t.push({role:"assistant",content:s}),u.length>0?(t.push({role:"tool",content:u}),l.forEach(e=>t.push(e)),null):a}system_auto_tools(e){let t=[],n=e.xml;(n.indexOf("input=")>-1||n.indexOf("output=")>-1)&&t.push(new ci),n.indexOf("</forEach>")>-1&&t.push(new ii),n.indexOf("</watch>")>-1&&t.push(new pi);let s=this.tools.map(e=>e.name);return t.filter(e=>-1==s.indexOf(e.name))}async buildSystemPrompt(e,t){return function(e,t,n,s,o){let r="",a="";s=s||e.Tools;let i=t.xml,l=i.indexOf("</watch>")>-1,u=i.indexOf("</forEach>")>-1,c=s.filter(e=>e.name==li).length>0,p=i.indexOf("input=")>-1||i.indexOf("output=")>-1||s.filter(e=>e.name==ui).length>0;if(c&&(r+=mi),p&&(r+=gi),u&&(s.filter(e=>e.name==ai).length>0&&(r+=fi),a+='\n    \x3c!-- duplicate task node, items support list and variable --\x3e\n    <forEach items="list or variable name">\n      <node>forEach item step node</node>\n    </forEach>'),l&&(s.filter(e=>e.name==di).length>0&&(r+=yi),a+='\n    \x3c!-- monitor task node, the loop attribute specifies whether to listen in a loop or listen once --\x3e\n    <watch event="dom" loop="true">\n      <description>Monitor task description</description>\n      <trigger>\n        <node>Trigger step node</node>\n        <node>...</node>\n      </trigger>\n    </watch>'),o&&o.trim()&&(r+="\n"+o.trim()+"\n"),r+="\nCurrent datetime: {datetime}",n.chain.agents.length>1){r+="\n Main task: "+n.chain.taskPrompt,r+="\n\n# Pre-task execution results";for(let e=0;e<n.chain.agents.length;e++){let t=n.chain.agents[e];t.agentResult&&(r+=`\n## ${t.agent.task||t.agent.name}\n${d(t.agentResult,500,!0)}`)}}return'\nYou are {name}, an autonomous AI agent for {agent} agent.\n\n# Agent Description\n{description}\n{prompt}\n\n# User input task instructions\n<root>\n  \x3c!-- Main task, completed through the collaboration of multiple Agents --\x3e\n  <mainTask>main task</mainTask>\n  \x3c!-- The tasks that the current agent needs to complete, the current agent only needs to complete the currentTask --\x3e\n  <currentTask>specific task</currentTask>\n  \x3c!-- Complete the corresponding step nodes of the task, Only for reference --\x3e\n  <nodes>\n    \x3c!-- node supports input/output variables to pass dependencies --\x3e\n    <node input="variable name" output="variable name" status="todo / done">task step node</node>{nodePrompt}\n  </nodes>\n</root>\n\nThe output language should follow the language corresponding to the user\'s task.\n'.replace("{name}","Eko").replace("{agent}",e.Name).replace("{description}",e.Description).replace("{prompt}","\n"+r.trim()).replace("{nodePrompt}",a).replace("{datetime}",(new Date).toLocaleString()).trim()}(this,e.agentChain.agent,e.context,t,await this.extSysPrompt(e,t))}async buildUserPrompt(e,t){return[{type:"text",text:bi(this,e.agentChain.agent,e.context,t)}]}async extSysPrompt(e,t){return""}async listTools(t,n,s,r){try{n.isConnected()||await n.connect();let o=await n.listTools({taskId:t.taskId,nodeId:s?.id,environment:e,agent_name:s?.name||this.name,params:{},prompt:s?.task||t.chain.taskPrompt,...r||{}}),a=[];for(let e=0;e<o.length;e++){let t=o[e],s=this.toolExecuter(n,t.name),r=new ni(t,s);a.push(new hi(r))}return a}catch(e){return o.error("Mcp listTools error",e),[]}}async controlMcpTools(e,t,n){return{mcpTools:0==n}}toolExecuter(t,n){return{execute:async function(s,o){return await t.callTool({name:n,arguments:s,extInfo:{taskId:o.context.taskId,nodeId:o.agentChain.agent.id,environment:e,agent_name:o.agent.Name}})}}}convertTools(e){return e.map(e=>({type:"function",name:e.name,description:e.description,parameters:e.parameters}))}getTool(e,t){for(let n=0;n<e.length;n++)if(e[n].name==t)return e[n];return null}convertToolResult(e,t,n){let s="";for(let o=0;o<t.content.length;o++){let r=t.content[o];"text"==r.type?s+=(s.length>0?"\n":"")+r.text:n.push({role:"user",content:[{type:"image",image:l(r.data),mimeType:r.mimeType},{type:"text",text:`call \`${e.toolName}\` tool result`}]})}let o=1==t.isError;o&&!s.startsWith("Error")?s="Error: "+s:o||0!=s.length||(s="Successful");let r={type:"text",text:s},a=s;if(s&&(s.startsWith("{")&&s.endsWith("}")||s.startsWith("[")&&s.endsWith("]")))try{a=JSON.parse(s),r=null}catch(e){}return{type:"tool-result",toolCallId:e.toolCallId,toolName:e.toolName,result:a,content:r?[r]:void 0,isError:o}}async handleMessages(e,t,n){!function(e){let t=0,n=0,s={};for(let o=e.length-1;o>=0;o--){let r=e[o];if("user"==r.role)for(let e=0;e<r.content.length;e++){let s=r.content[e];if("image"==s.type){if(++t<=1)break;s={type:"text",text:"[image]"},r.content[e]=s}else if("file"==s.type){if(++n<=1)break;s={type:"text",text:"[file]"},r.content[e]=s}}else if("tool"==r.role)for(let e=0;e<r.content.length;e++){let n=r.content[e],o=n.content;if(o&&0!=o.length){for(let e=0;e<o.length;e++){let n=o[e];if("image"==n.type){if(++t<=1)break;n={type:"text",text:"[image]"},o[e]=n}}for(let e=0;e<o.length;e++){let t=o[e];if("text"==t.type&&t.text?.length>5e3){if(!s[n.toolName]){s[n.toolName]=1;break}s[n.toolName]++,t={type:"text",text:t.text.substring(0,5e3)+"..."},o[e]=t}}}}}}(t)}async callInnerTool(e){let t=await e();return{content:[{type:"text",text:t?"string"==typeof t?t:JSON.stringify(t):"Successful"}]}}async loadTools(e){if(this.mcpClient){let t=await this.listTools(e,this.mcpClient);if(t&&t.length>0)return u(this.tools,t)}return this.tools}addTool(e){this.tools.push(e)}async onTaskStatus(e,t){"abort"==e&&this.agentContext&&this.agentContext?.variables.clear()}get Llms(){return this.llms}get Name(){return this.name}get Description(){return this.description}get Tools(){return this.tools}get PlanDescription(){return this.planDescription}get McpClient(){return this.mcpClient}get AgentContext(){return this.agentContext}}const wi=['User: Open Boss Zhipin, find 10 operation positions in Chengdu, and send a personal introduction to the recruiters based on the page information.\nOutput result:\n<root>\n  <name>Submit resume</name>\n  <thought>OK, now the user requests me to create a workflow that involves opening the Boss Zhipin website, finding 10 operation positions in Chengdu, and sending personal resumes to the recruiters based on the job information.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Open Boss Zhipin, find 10 operation positions in Chengdu, and send a personal introduction to the recruiters based on the page information.</task>\n      <nodes>\n        <node>Open Boss Zhipin, enter the job search page</node>\n        <node>Set the regional filter to Chengdu and search for operational positions.</node>\n        <node>Brows the job list and filter out 10 suitable operation positions.</node>\n        <forEach items="list">\n          <node>Analyze job requirements</node>\n          <node>Send a self-introduction to the recruiter</node>\n        </forEach>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Help me collect the latest AI news, summarize it, and send it to the "AI news information" group chat on WeChat.\nOutput result:\n<root>\n  <name>Latest AI News</name>\n  <thought>OK, users need to collect the latest AI news, summarize it, and send it to a WeChat group named "AI news information" This requires automation, including the steps of data collection, processing, and distribution.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Search for the latest updates on AI</task>\n      <nodes>\n        <node>Open Google</node>\n        <node>Search for the latest updates on AI</node>\n        <forEach items="list">\n          <node>View Details</node>\n        </forEach>\n        <node output="summaryInfo">Summarize search information</node>\n      </nodes>\n    </agent>\n    <agent name="Computer" id="1" dependsOn="0">\n      <task>Send a message to the WeChat group chat "AI news information"</task>\n      <nodes>\n        <node>Open WeChat</node>\n        <node>Search for the "AI news information" chat group</node>\n        <node input="summaryInfo">Send summary message</node>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Access the Google team\'s organization page on GitHub, extract all developer accounts from the team, and compile statistics on the countries and regions where these developers are located.\nOutput result:\n<root>\n  <name>Statistics of Google Team Developers\' Geographic Distribution</name>\n  <thought>Okay, I need to first visit GitHub, then find Google\'s organization page on GitHub, extract the team member list, and individually visit each developer\'s homepage to obtain location information for each developer. This requires using a browser to complete all operations.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Visit Google GitHub Organization Page and Analyze Developer Geographic Distribution</task>\n      <nodes>\n        <node>Visit https://github.com/google</node>\n        <node>Click "People" tab to view team members</node>\n        <node>Scroll the page to load all developer information</node>\n        <node output="developers">Extract all developer account information</node>\n        <forEach items="developers">\n          <node>Visit developer\'s homepage</node>\n          <node>Extract developer\'s location information</node>\n        </forEach>\n        <node>Compile and analyze the geographic distribution data of all developers</node>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Open Discord to monitor messages in Group A, and automatically reply when new messages are received.\nOutput result:\n<root>\n  <name>Automatic reply to Discord messages</name>\n  <thought>OK, monitor the chat messages in Discord group A and automatically reply.</thought>\n  <agents>\n    <agent name="Browser" id="0" dependsOn="">\n      <task>Open Group A in Discord</task>\n      <nodes>\n        <node>Open Discord page</node>\n        <node>Find and open Group A</node>\n        <watch event="dom" loop="true">\n          <description>Monitor new messages in group chat</description>\n          <trigger>\n            <node>Analyze message content</node>\n            <node>Automatic reply to new messages</node>\n          </trigger>\n        </watch>\n      </nodes>\n    </agent>\n  </agents>\n</root>','User: Search for information about "fellou," compile the results into a summary profile, then share it across social media platforms including Twitter, Facebook, and Reddit. Finally, export the platform sharing operation results to an Excel file.\nOutput result:\n<root>\n<name>Fellou Research and Social Media Campaign</name>\n<thought>The user wants me to research information about \'Fellou\', create a summary profile, share it on multiple social media platforms (Twitter, Facebook, Reddit), and then compile the results into an Excel file. This requires multiple agents working together: Browser for research, Browser for social media posting (Twitter, Facebook, and Reddit in parallel), and File for creating the Excel export. I need to break this down into sequential steps with proper variable passing between agents.</thought>\n<agents>\n  <agent name="Browser" id="0" dependsOn="">\n      <task>Research comprehensive information about \'Fellou\'</task>\n      <nodes>\n        <node>Search for the latest information about \'Fellou\' - its identity, purpose, and core features</node>\n        <node>Search for Fellou\'s functionalities, capabilities, and technical specifications</node>\n        <node>Search for recent news, updates, announcements, and developments related to Fellou</node>\n        <node>Search for user reviews, feedback, and community discussions about Fellou</node>\n        <node>Search for Fellou\'s market position, competitors, and industry context</node>\n        <node output="researchData">Compile all research findings into a comprehensive summary profile</node>\n      </nodes>\n    </agent>\n    <agent name="Browser" id="1" dependsOn="0">\n      <task>Share Fellou\'s summary and collected interaction data on Twitter/X</task>\n      <nodes>\n        <node>Navigate to Twitter/X platform</node>\n        <node input="researchData">Create and post Twitter-optimized content about Fellou (within character limits, using hashtags)</node>\n        <node output="twitterResults">Capture Twitter post URL and initial engagement metrics</node>\n      </nodes>\n    </agent>\n    <agent name="Browser" id="2" dependsOn="0">\n      <task>Share Fellou\'s summary and collected interaction data on Facebook</task>\n      <nodes>\n        <node>Navigate to Facebook platform</node>\n        <node input="researchData">Create and post Facebook-optimized content about Fellou (longer format, engaging description)</node>\n        <node output="facebookResults">Capture Facebook post URL and initial engagement metrics</node>\n      </nodes>\n    </agent>\n    <agent name="Browser" id="3" dependsOn="0">\n      <task>Share Fellou\'s summary and collected interaction data on Reddit</task>\n      <nodes>\n        <node>Navigate to Reddit platform</node>\n        <node input="researchData">Find appropriate subreddit and create Reddit-optimized post about Fellou (community-focused, informative)</node>\n        <node output="redditResults">Capture Reddit post URL and initial engagement metrics</node>\n      </nodes>\n    </agent>\n    <agent name="File" id="4" dependsOn="1,2,3">\n      <task>Compile social media results into Excel file</task>\n      <nodes>\n        <node input="twitterResults,facebookResults,redditResults">Create Excel file with social media campaign results</node>\n        <node>Include columns for Platform, Post URL, Content Summary, Timestamp, Initial Likes/Shares/Comments</node>\n        <node>Format the Excel file with proper headers and styling</node>\n        <node>Save the file as \'Fellou_Social_Media_Campaign_Results.xlsx\'</node>\n      </nodes>\n    </agent>\n  </agents>\n</agents>\n</root>'];async function _i(e){let t="",n=e.agents;for(let s=0;s<n.length;s++){let o=n[s],r=await o.loadTools(e);t+=`<agent name="${o.Name}">\nDescription: ${o.PlanDescription||o.Description}\nTools:\n`+r.filter(e=>!e.noPlan).map(e=>`  - ${e.name}: ${e.planDescription||e.description||""}`).join("\n")+"\n</agent>\n\n"}let s=e.variables.get("plan_example_list")||wi,o="";const r=e.agents.filter(e=>"Chat"==e.Name).length>0?['User: hello.\nOutput result:\n<root>\n  <name>Chat</name>\n  <thought>Alright, the user wrote "hello". That\'s pretty straightforward. I need to respond in a friendly and welcoming manner.</thought>\n  <agents>\n    \x3c!-- Chat agents can exist without the <task> and <nodes> nodes. --\x3e\n    <agent name="Chat" id="0" dependsOn=""></agent>\n  </agents>\n</root>',...s]:[...s];for(let e=0;e<r.length;e++)o+=`## Example ${e+1}\n${r[e]}\n\n`;return'\nYou are {name}, an autonomous AI Agent Planner.\n\n## Task Description\nYour task is to understand the user\'s requirements, dynamically plan the user\'s tasks based on the Agent list, and please follow the steps below:\n1. Understand the user\'s requirements.\n2. Analyze the Agents that need to be used based on the user\'s requirements.\n3. Generate the Agent calling plan based on the analysis results.\n4. About agent name, please do not arbitrarily fabricate non-existent agent names.\n5. You only need to provide the steps to complete the user\'s task, key steps only, no need to be too detailed.\n6. Please strictly follow the output format and example output.\n7. The output language should follow the language corresponding to the user\'s task.\n\n## Agent list\n{agents}\n\n## Output Rules and Format\n<root>\n  \x3c!-- Task Name (Short) --\x3e\n  <name>Task Name</name>\n  \x3c!-- Need to break down the task into multi-agent collaboration. Please think step by step and output a detailed thought process. --\x3e\n  <thought>Your thought process on user demand planning</thought>\n  \x3c!-- Multiple Agents work together to complete the task --\x3e\n  <agents>\n    \x3c!--\n    Multi-Agent supports parallelism, coordinating parallel tasks through dependencies, and passing dependent context information through node variables.\n    name: The name of the Agent, where the name can only be an available name in the Agent list.\n    id: Use subscript order as ID for dependency relationships between multiple agents.\n    dependsOn: The IDs of agents that the current agent depends on, separated by commas when there are multiple dependencies.\n    --\x3e\n    <agent name="Agent name" id="0" dependsOn="">\n      \x3c!-- The current Agent needs to complete the task --\x3e\n      <task>current agent task</task>\n      <nodes>\n        \x3c!-- Nodes support input/output variables for parameter passing and dependency handling in multi-agent collaboration. --\x3e\n        <node>Complete the corresponding step nodes of the task</node>\n        <node input="variable name">...</node>\n        <node output="variable name">...</node>\n        \x3c!-- When including duplicate tasks, `forEach` can be used --\x3e\n        <forEach items="list or variable name">\n          <node>forEach step node</node>\n        </forEach>\n        \x3c!-- When you need to monitor changes in webpage DOM elements, you can use `Watch`, the loop attribute specifies whether to listen in a loop or listen once. --\x3e\n        <watch event="dom" loop="true">\n          <description>Monitor task description</description>\n          <trigger>\n            <node>Trigger step node</node>\n            <node>...</node>\n          </trigger>\n        </watch>\n      </nodes>\n    </agent>\n    \x3c!--\n    Multi-agent Collaboration Dependency Example:\n\n    Execution Flow:\n    1. Agent 0: Initial agent with no dependencies (executes first)\n    2. Agent 1: Depends on Agent 0 completion (executes after Agent 0)\n    3. Agent 2 & 3: Both depend on Agent 1 completion (execute in parallel after Agent 1)\n    4. Agent 4: Depends on both Agent 2 and Agent 3 completion (executes last)\n\n    Dependency Chain: Agent 0 → Agent 1 → (Agent 2 ∥ Agent 3) → Agent 4\n    --\x3e\n    <agent name="Agent name" id="0" dependsOn="">...</agent>\n    <agent name="Agent name" id="1" dependsOn="0">...</agent>\n    <agent name="Agent name" id="2" dependsOn="1">...</agent>\n    <agent name="Agent name" id="3" dependsOn="1">...</agent>\n    <agent name="Agent name" id="4" dependsOn="2,3">...</agent>\n  </agents>\n</root>\n\n{example_prompt}\n'.replace("{name}","Eko").replace("{agents}",t.trim()).replace("{example_prompt}",o).trim()}function xi(t,n,s){let o="";return o=n?"\nUser Platform: {platform}\nTask Website: {task_website}\nCurrent datetime: {datetime}\nTask Description: {task_prompt}\n".replace("{task_website}",n):"\nUser Platform: {platform}\nCurrent datetime: {datetime}\nTask Description: {task_prompt}\n",o=o.replace("{task_prompt}",t).replace("{platform}",e).replace("{datetime}",(new Date).toLocaleString()).trim(),s&&(o+=`\n${s.trim()}`),o}class ki{constructor(e,t){this.context=e,this.taskId=e.taskId,this.callback=t||e.config.callback}async plan(e,t=!0){let n,s;"string"==typeof e?(n=e,s={type:"text",text:xi(e,this.context.variables.get("task_website"),this.context.variables.get("plan_ext_prompt"))}):(s=e,n=e.text||"");const o=[{role:"system",content:this.context.variables.get("plan_sys_prompt")||await _i(this.context)},{role:"user",content:[s]}];return await this.doPlan(n,o,t)}async replan(e,t=!0){const n=this.context.chain;if(n.planRequest&&n.planResult){const s=[...n.planRequest.messages,{role:"assistant",content:[{type:"text",text:n.planResult}]},{role:"user",content:[{type:"text",text:e}]}];return await this.doPlan(e,s,t)}return this.plan(e,t)}async doPlan(e,t,n){const s=this.context.config,r=new Ma(s.llms,s.planLlms),a={maxTokens:4096,temperature:.7,messages:t,abortSignal:this.context.controller.signal},i=(await r.callStream(a)).stream.getReader();let l="",u="";try{for(;;){await this.context.checkAborted(!0);const{done:e,value:t}=await i.read();if(e)break;let n=t;if("error"==n.type)throw o.error("Plan, LLM Error: ",n),new Error("LLM Error: "+n.error);if("reasoning"==n.type&&(u+=n.textDelta||""),"text-delta"==n.type&&(l+=n.textDelta||""),this.callback){let e=za(this.taskId,l,!1,u);e&&await this.callback.onMessage({taskId:this.taskId,agentName:"Planer",type:"workflow",streamDone:!1,workflow:e})}}}finally{i.releaseLock(),o.isEnableInfo()&&o.info("Planner result: \n"+l)}if(n){const e=this.context.chain;e.planRequest=a,e.planResult=l}let c=za(this.taskId,l,!0,u);return this.callback&&await this.callback.onMessage({taskId:this.taskId,agentName:"Planer",type:"workflow",streamDone:!0,workflow:c}),c.taskPrompt?c.taskPrompt+="\n"+e.trim():c.taskPrompt=e.trim(),c}}class Ti{constructor(e){this.config=e,this.taskMap=new Map}async generate(e,t=a(),n){const s=[...this.config.agents||[]],o=new ri(e),r=new p(t,this.config,s,o);n&&Object.keys(n).forEach(e=>r.variables.set(e,n[e]));try{if(this.taskMap.set(t,r),this.config.a2aClient){const t=await this.config.a2aClient.listAgents(e);r.agents=c(r.agents,t)}const n=new ki(r);return r.workflow=await n.plan(e),r.workflow}catch(e){throw this.deleteTask(t),e}}async modify(e,t){const n=this.taskMap.get(e);if(!n)return await this.generate(t,e);if(this.config.a2aClient){const e=await this.config.a2aClient.listAgents(t);n.agents=c(n.agents,e)}const s=new ki(n);return n.workflow=await s.replan(t),n.workflow}async execute(e){const t=this.getTask(e);if(!t)throw new Error("The task does not exist");t.pause&&t.setPause(!1),t.conversation=[],t.controller.signal.aborted&&(t.controller=new AbortController);try{return await this.doRunWorkflow(t)}catch(t){return o.error("execute error",t),{taskId:e,success:!1,stopReason:"AbortError"==t?.name?"abort":"error",result:t}}}async run(e,t=a(),n){return await this.generate(e,t,n),await this.execute(t)}async initContext(e,t){const n=this.config.agents||[],s=new ri(e.taskPrompt||e.name),o=new p(e.taskId,this.config,n,s);if(this.config.a2aClient){const t=await this.config.a2aClient.listAgents(e.taskPrompt||e.name);o.agents=c(o.agents,t)}return t&&Object.keys(t).forEach(e=>o.variables.set(e,t[e])),o.workflow=e,this.taskMap.set(e.taskId,o),o}async doRunWorkflow(e){const t=e.agents,n=e.workflow;if(!n||0==n.agents.length)throw new Error("Workflow error");const s=t.reduce((e,t)=>(e[t.Name]=t,e),{});let o=Va(n.agents);const r=[];for(;;){if(await e.checkAborted(),"normal"===o.type){const t=s[o.agent.name];if(!t)throw new Error("Unknown Agent: "+o.agent.name);const n=o.agent,a=new oi(n);e.chain.push(a),o.result=await this.runAgent(e,t,o,a),r.push(o.result)}else{const t=o.agents,n=async(t,n)=>{const o=s[t.agent.name];if(!o)throw new Error("Unknown Agent: "+t.agent.name);const r=new oi(t.agent);return e.chain.push(r),{result:await this.runAgent(e,o,t,r),agentChain:r,index:n}};let a=[],i=e.variables.get("agentParallel");if(void 0===i&&(i=false),i){const s=await Promise.all(t.map((e,t)=>n(e,t)));s.sort((e,t)=>e.index-t.index),s.forEach(({agentChain:t})=>{e.chain.push(t)}),a=s.map(({result:e})=>e)}else for(let s=0;s<t.length;s++){const{result:o,agentChain:r}=await n(t[s],s);e.chain.push(r),a.push(o)}r.push(a.join("\n\n"))}if(e.conversation.splice(0,e.conversation.length),!o.nextAgent)break;o=o.nextAgent}return{success:!0,stopReason:"done",result:r[r.length-1],taskId:e.taskId}}async runAgent(e,t,n,s){try{return n.agent.status="running",this.config.callback&&await this.config.callback.onMessage({taskId:e.taskId,agentName:n.agent.name,nodeId:n.agent.id,type:"agent_start",agentNode:n.agent}),n.result=await t.run(e,s),n.agent.status="done",this.config.callback&&await this.config.callback.onMessage({taskId:e.taskId,agentName:n.agent.name,nodeId:n.agent.id,type:"agent_result",agentNode:n.agent,result:n.result},t.AgentContext),n.result}catch(s){throw n.agent.status="error",this.config.callback&&await this.config.callback.onMessage({taskId:e.taskId,agentName:n.agent.name,nodeId:n.agent.id,type:"agent_result",agentNode:n.agent,error:s},t.AgentContext),s}}getTask(e){return this.taskMap.get(e)}getAllTaskId(){return[...this.taskMap.keys()]}deleteTask(e){this.abortTask(e);const t=this.taskMap.get(e);return t&&t.variables.clear(),this.taskMap.delete(e)}abortTask(e,t){let n=this.taskMap.get(e);return!!n&&(n.setPause(!1),this.onTaskStatus(n,"abort",t),n.controller.abort(t),!0)}pauseTask(e,t,n,s){const o=this.taskMap.get(e);return!!o&&(this.onTaskStatus(o,t?"pause":"resume-pause",s),o.setPause(t,n),!0)}chatTask(e,t){const n=this.taskMap.get(e);if(n)return n.conversation.push(t),n.conversation}addAgent(e){this.config.agents=this.config.agents||[],this.config.agents.push(e)}async onTaskStatus(e,t,n){const[s]=e.currentAgent()||[];if(s){const e=s.onTaskStatus;e&&await e.call(s,t,n)}}}function Ni(e=200){let t="";e=e||200;try{function n(s){if(s.nodeType===Node.ELEMENT_NODE){const e=s.tagName.toLowerCase();if(["script","style","noscript"].includes(e))return;const t=window.getComputedStyle(s);if("none"==t.display||"hidden"==t.visibility||"0"==t.opacity)return}if(s.nodeType===Node.TEXT_NODE){const e=s.textContent.trim();e&&(t+=e+" ")}else if(s.nodeType===Node.ELEMENT_NODE){const o=s.tagName.toLowerCase();if(["input","select","textarea"].includes(o))"input"==o&&"checkbox"==s.type?t+=s.checked+" ":"input"==o&&"radio"==s.type?s.checked&&s.value&&(t+=s.value+" "):s.value&&(t+=s.value+" ");else if("img"===o){const n=s.src||s.getAttribute("src")||s.getAttribute("data-src"),o=s.alt||s.title||"";n&&n.length<=e&&s.width*s.height>=1e4&&n.startsWith("http")&&(t+=`![${o||"image"}](${n.trim()}) `)}else if("a"===o&&0==s.children.length){const n=s.href||s.getAttribute("href"),o=s.innerText.trim()||s.title;o&&n&&n.length<=e&&n.startsWith("http")?t+=`[${o}](${n.trim()}) `:t+=o+" "}else if("video"===o||"audio"==o){let e=s.src||s.getAttribute("src");const n=s.querySelectorAll("source");n.length>0&&n[0].src&&(e=n[0].src,e&&e.startsWith("http")&&n[0].type&&(t+=n[0].type+" ")),e&&e.startsWith("http")&&(t+=e.trim()+" ")}else if("br"===o)t+="\n";else{if(["p","div","h1","h2","h3","h4","h5","h6"].includes(o)){t+="\n";for(let e of s.childNodes)n(e);return void(t+="\n")}if("hr"===o)t+="\n--------\n";else for(let e of s.childNodes)n(e)}}}n(document.body)}catch(s){t=document.body.innerText}return t.replace(/\s*\n/g,"\n").replace(/\n+/g,"\n").trim()}class Ii extends vi{async go_back(e){try{await this.execute_script(e,()=>{window.navigation.back()},[]),await r(100)}catch(e){}}async extract_page_content(e,t){let n=await this.execute_script(e,Ni,[]),s=await this.get_current_page(e),o=`title: ${s.title}\npage_url: ${s.url}\npage_content: \n${n}`;return t&&e.context.variables.set(t,o),{title:s.title||"",page_url:s.url,page_content:n}}async controlMcpTools(e,t,n){if(n>0){let t=null;try{t=(await this.get_current_page(e)).url}catch(e){}let s=e.variables.get("lastUrl");return e.variables.set("lastUrl",t),{mcpTools:0==n||t!=s,mcpParams:{environment:"browser",browser_url:t}}}return{mcpTools:!0,mcpParams:{environment:"browser"}}}toolExecuter(e,t){return{execute:async(n,s)=>{let o=await e.callTool({name:t,arguments:n,extInfo:{taskId:s.context.taskId,nodeId:s.agentChain.agent.id,environment:"browser",agent_name:s.agent.Name,browser_url:s.variables.get("lastUrl")}});if(o.extInfo&&o.extInfo.javascript&&"text"==o.content[0].type){let e,t=`${o.content[0].text};execute(${JSON.stringify(n)})`,r=await this.execute_mcp_script(s,t);return e="string"==typeof r||"number"==typeof r?r+"":r?JSON.stringify(r):"Successful",{content:[{type:"text",text:e}]}}return o}}}async get_current_page(e){return await this.execute_script(e,()=>({url:window.location.href,title:window.document.title}),[])}lastToolResult(e){let t=e[e.length-1];if("tool"!=t.role)return null;let n=t.content.filter(e=>"tool-result"==e.type)[0];if(!n)return null;let s=n.result,o=n.isError;for(let t=e.length-2;t>0;t--)if("assistant"===e[t].role&&"string"!=typeof e[t].content)for(let r=0;r<e[t].content.length;r++){let a=e[t].content[r];if("string"!=typeof a&&"tool-call"!==a.type)continue;let i=a;if(n.toolCallId==i.toolCallId)return{id:n.toolCallId,toolName:i.toolName,args:i.args,result:s,isError:o}}return null}toolUseNames(e){let t=[];if(!e)return t;for(let n=0;n<e.length;n++){let s=e[n];"tool"==s.role&&t.push(s.content[0].toolName)}return t}async execute_mcp_script(e,t){}}function Ci(){function e(t,n){if(!t)return;if("TEXT_NODE"==t.type)return{text:t.text||"",isVisible:t.isVisible||!1,parent:n};let s={tagName:t.tagName,xpath:t.xpath,highlightIndex:t.highlightIndex,attributes:t.attributes||{},isVisible:t.isVisible||!1,isInteractive:t.isInteractive||!1,isTopElement:t.isTopElement||!1,shadowRoot:t.shadowRoot||!1,children:[],parent:n};if(t.children){let n=[];for(let o=0;o<t.children.length;o++){let r=t.children[o];if(r){let t=e(r,s);t&&n.push(t)}}s.children=n}return s}window.get_clickable_elements=function(t=!0,n){window.clickable_elements={},document.querySelectorAll("[eko-user-highlight-id]").forEach(e=>e.removeAttribute("eko-user-highlight-id"));let s=e(function(e){let t=0;function n(e,t=!0){const n=[];let s=e;for(;s&&s.nodeType===Node.ELEMENT_NODE&&(!t||!(s.parentNode instanceof ShadowRoot||s.parentNode instanceof HTMLIFrameElement));){let e=0,t=s.previousSibling;for(;t;)t.nodeType===Node.ELEMENT_NODE&&t.nodeName===s.nodeName&&e++,t=t.previousSibling;const o=s.nodeName.toLowerCase(),r=e>0?`[${e+1}]`:"";n.unshift(`${o}${r}`),s=s.parentNode}return n.join("/")}return function s(o,r=null){if(!o)return null;if(o.nodeType===Node.TEXT_NODE){const e=o.textContent.trim();return e&&function(e){const t=document.createRange();t.selectNodeContents(e);const n=t.getBoundingClientRect();return 0!==n.width&&0!==n.height&&n.top>=0&&n.top<=window.innerHeight&&e.parentElement?.checkVisibility({checkOpacity:!0,checkVisibilityCSS:!0})}(o)?{type:"TEXT_NODE",text:e,isVisible:!0}:null}if(o.nodeType===Node.ELEMENT_NODE&&(a=o,new Set(["svg","script","style","link","meta"]).has(a.tagName.toLowerCase())))return null;var a;const i={tagName:o.tagName?o.tagName.toLowerCase():null,attributes:{},xpath:o.nodeType===Node.ELEMENT_NODE?n(o,!0):null,children:[]};if(o.nodeType===Node.ELEMENT_NODE&&o.attributes){const e=o.getAttributeNames?.()||[];for(const t of e)i.attributes[t]=o.getAttribute(t)}if(o.nodeType===Node.ELEMENT_NODE){const n=function(e){const t=new Set(["a","button","details","embed","input","label","menu","menuitem","object","select","textarea","summary"]),n=new Set(["button","menu","menuitem","link","checkbox","radio","slider","tab","tabpanel","textbox","combobox","grid","listbox","option","progressbar","scrollbar","searchbox","switch","tree","treeitem","spinbutton","tooltip","a-button-inner","a-dropdown-button","click","menuitemcheckbox","menuitemradio","a-button-text","button-text","button-icon","button-icon-only","button-text-icon-only","dropdown","combobox"]),s=e.tagName.toLowerCase(),o=e.getAttribute("role"),r=e.getAttribute("aria-role"),a=e.getAttribute("tabindex");if(t.has(s)||n.has(o)||n.has(r)||null!==a&&"-1"!==a||"a-dropdown-select"===e.getAttribute("data-action")||"a-dropdown-button"===e.getAttribute("data-action"))return!0;const i=window.getComputedStyle(e),l=null!==e.onclick||null!==e.getAttribute("onclick")||e.hasAttribute("ng-click")||e.hasAttribute("@click")||e.hasAttribute("v-on:click"),u=function(e){try{return window.getEventListeners?.(e)||{}}catch(t){const n={},s=["click","mousedown","mouseup","touchstart","touchend","keydown","keyup","focus","blur"];for(const t of s){const s=e[`on${t}`];s&&(n[t]=[{listener:s,useCapture:!1}])}return n}}(e),c=u&&(u.click?.length>0||u.mousedown?.length>0||u.mouseup?.length>0||u.touchstart?.length>0||u.touchend?.length>0),d=e.hasAttribute("aria-expanded")||e.hasAttribute("aria-pressed")||e.hasAttribute("aria-selected")||e.hasAttribute("aria-checked");void 0!==e.form||e.hasAttribute("contenteditable")||i.userSelect;const p=e.draggable||"true"===e.getAttribute("draggable");return d||l||c||p}(o),s=function(e){const t=window.getComputedStyle(e);return e.offsetWidth>0&&e.offsetHeight>0&&"hidden"!==t.visibility&&"none"!==t.display}(o),a=function(e){if(e.ownerDocument!==window.document)return!0;const t=e.getRootNode();if(t instanceof ShadowRoot){const n=e.getBoundingClientRect(),s={x:n.left+n.width/2,y:n.top+n.height/2};try{const n=t.elementFromPoint(s.x,s.y);if(!n)return!1;let o=n;for(;o&&o!==t;){if(o===e)return!0;o=o.parentElement}return!1}catch(e){return!0}}const n=e.getBoundingClientRect(),s={x:n.left+n.width/2,y:n.top+n.height/2};try{const t=document.elementFromPoint(s.x,s.y);if(!t)return!1;let n=t;for(;n&&n!==document.documentElement;){if(n===e)return!0;n=n.parentElement}return!1}catch(e){return!0}}(o);i.isInteractive=n,i.isVisible=s,i.isTopElement=a,n&&s&&a&&(i.highlightIndex=t++,window.clickable_elements[i.highlightIndex]=o,e&&function(e,t,n=null){let s=document.getElementById("eko-highlight-container");s||(s=document.createElement("div"),s.id="eko-highlight-container",s.style.position="fixed",s.style.pointerEvents="none",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.zIndex="2147483647",document.documentElement.appendChild(s));const o=["#FF0000","#00FF00","#0000FF","#FFA500","#800080","#008080","#FF69B4","#4B0082","#FF4500","#2E8B57","#DC143C","#4682B4"],r=o[t%o.length],a=`${r}1A`,i=document.createElement("div");i.style.position="absolute",i.style.border=`2px solid ${r}`,i.style.pointerEvents="none",i.style.boxSizing="border-box";const l=e.getBoundingClientRect();let u=l.top,c=l.left;if((l.width<window.innerWidth/2||l.height<window.innerHeight/2)&&(i.style.backgroundColor=a),n){const e=n.getBoundingClientRect();u+=e.top,c+=e.left}i.style.top=`${u}px`,i.style.left=`${c}px`,i.style.width=`${l.width}px`,i.style.height=`${l.height}px`;const d=document.createElement("div");d.className="eko-highlight-label",d.style.position="absolute",d.style.background=r,d.style.color="white",d.style.padding="1px 4px",d.style.borderRadius="4px",d.style.fontSize=`${Math.min(12,Math.max(8,l.height/2))}px`,d.textContent=t;let p=u+2,h=c+l.width-20-2;(l.width<24||l.height<20)&&(p=u-16-2,h=c+l.width-20),p<0&&(p=u+2),h<0&&(h=c+2),h+20>window.innerWidth&&(h=c+l.width-20-2),d.style.top=`${p}px`,d.style.left=`${h}px`,s.appendChild(i),s.appendChild(d),e.setAttribute("eko-user-highlight-id",`eko-highlight-${t}`)}(o,i.highlightIndex,r))}if(o.shadowRoot&&(i.shadowRoot=!0),o.shadowRoot){const e=Array.from(o.shadowRoot.childNodes).map(e=>s(e,r));i.children.push(...e)}if("IFRAME"===o.tagName)try{const e=o.contentDocument||o.contentWindow.document;if(e){const t=Array.from(e.body.childNodes).map(e=>s(e,o));i.children.push(...t)}}catch(e){console.warn("Unable to access iframe:",o)}else{const e=Array.from(o.childNodes).map(e=>s(e,r));i.children.push(...e)}return i}(document.body)}(t)),o=function(e){let t={};return function e(n){if(n.tagName){null!=n.highlightIndex&&(t[n.highlightIndex]=n);for(let t=0;t<n.children.length;t++)e(n.children[t])}}(e),t}(s);return{element_str:function(e,t){t||(t=["id","title","type","name","role","class","src","href","aria-label","placeholder","value","alt","aria-expanded"]);let n=[];return function e(s,o){if(null==s.text){if(null!=s.highlightIndex){let e="";if(t){for(let n=0;n<t.length;n++){let o=t[n],r=s.attributes[o];if("class"==o&&r&&r.length>30){let e=r.split(" ").slice(0,3);r=e.join(" ")}else{if(("src"==o||"href"==o)&&r&&r.length>200)continue;("src"==o||"href"==o)&&r&&r.startsWith("/")&&(r=window.location.origin+r)}o&&r&&(e+=` ${o}="${r}"`)}e=e.replace(/\n+/g," ")}let o=function(e){let t=[];return function n(s){if(!s.tagName||s==e||null==s.highlightIndex)if(!s.tagName&&s.text)t.push(s.text);else if(s.tagName)for(let e=0;e<s.children.length;e++)n(s.children[e])}(e),t.join("\n").trim().replace(/\n+/g," ")}(s);n.push(`[${s.highlightIndex}]:<${s.tagName}${e}>${o}</${s.tagName}>`)}for(let t=0;t<s.children.length;t++)e(s.children[t])}else(function(e){let t=e.parent;for(;t;){if(null!=t.highlightIndex)return!0;t=t.parent}return!1})(s)||n.push(`[]:${s.text}`)}(e),n.join("\n")}(s,n),selector_map:o}},window.get_highlight_element=function(e){return document.querySelector(`[eko-user-highlight-id="eko-highlight-${e}"]`)||window.clickable_elements[e]},window.remove_highlight=function(){let e=document.getElementById("eko-highlight-container");e&&e.remove()}}class Si extends Ii{constructor(e,t,n){const s=[];super({name:"Browser",description:"You are a browser operation agent, use structured commands to interact with the browser.\n* This is a browser GUI interface where you need to analyze webpages by taking screenshot and page element structures, and specify action sequences to complete designated tasks.\n* For your first visit, please start by calling either the `navigate_to` or `current_page` tool. After each action you perform, I will provide you with updated information about the current state, including page screenshots and structured element data that has been specially processed for easier analysis.\n* Screenshot description:\n  - Screenshot are used to understand page layouts, with labeled bounding boxes corresponding to element indexes. Each bounding box and its label share the same color, with labels typically positioned in the top-right corner of the box.\n  - Screenshot help verify element positions and relationships. Labels may sometimes overlap, so extracted elements are used to verify the correct elements.\n  - In addition to screenshot, simplified information about interactive elements is returned, with element indexes corresponding to those in the screenshot.\n  - This tool can ONLY screenshot the VISIBLE content. If a complete content is required, use 'extract_page_content' instead.\n  - If the webpage content hasn't loaded, please use the `wait` tool to allow time for the content to load.\n* ELEMENT INTERACTION:\n   - Only use indexes that exist in the provided element list\n   - Each element has a unique index number (e.g., \"[33]:<button>\")\n   - Elements marked with \"[]:\" are non-interactive (for context only)\n   - Use the latest element index, do not rely on historical outdated element indexes\n* ERROR HANDLING:\n   - If no suitable elements exist, use other functions to complete the task\n   - If stuck, try alternative approaches, don't refuse tasks\n   - Handle popups/cookies by accepting or closing them\n* BROWSER OPERATION:\n   - Use scroll to find elements you are looking for, When extracting content, prioritize using extract_page_content, only scroll when you need to load more content\n* During execution, please output user-friendly step information. Do not output HTML-related element and index information to users, as this would cause user confusion.\n",tools:s,llms:e,mcpClient:n,planDescription:"Browser operation agent, interact with the browser using the mouse and keyboard."});let o=this.buildInitTools();t&&t.length>0&&(o=u(o,t)),o.forEach(e=>s.push(e))}async input_text(e,t,n,s){await this.execute_script(e,Ei,[{index:t,text:n,enter:s}]),s&&await r(200)}async click_element(e,t,n,s){await this.execute_script(e,Ai,[{index:t,num_clicks:n,button:s}])}async scroll_to_element(e,t){await this.execute_script(e,e=>window.get_highlight_element(e).scrollIntoView({behavior:"smooth"}),[t]),await r(200)}async scroll_mouse_wheel(e,t,n){if(await this.execute_script(e,Mi,[{amount:t}]),await r(200),!n){const t=this.toolUseNames(e.agentChain.agentRequest?.messages);let s=0;for(let e=t.length-1;e>=Math.max(t.length-8,0);e--)"scroll_mouse_wheel"==t[e]&&s++;s>=3&&(n=!0)}if(n){let t=await this.extract_page_content(e);return{result:"The current page content has been extracted, latest page content:\ntitle: "+t.title+"\npage_url: "+t.page_url+"\npage_content: "+t.page_content}}}async hover_to_element(e,t){await this.execute_script(e,Oi,[{index:t}])}async get_select_options(e,t){return await this.execute_script(e,ji,[{index:t}])}async select_option(e,t,n){return await this.execute_script(e,Ri,[{index:t,option:n}])}async screenshot_and_html(e){try{let t=null;for(let n=0;n<5&&(await r(200),await this.execute_script(e,Ci,[]),await r(50),t=await this.execute_script(e,()=>window.get_clickable_elements(!0),[]),!t);n++);await r(100);let n=await this.screenshot(e),s=t.element_str;return{imageBase64:n.imageBase64,imageType:n.imageType,pseudoHtml:s}}finally{try{await this.execute_script(e,()=>window.remove_highlight(),[])}catch(e){}}}get_element_script(e){return`window.get_highlight_element(${e});`}buildInitTools(){return[{name:"navigate_to",description:"Navigate to a specific url",parameters:{type:"object",properties:{url:{type:"string",description:"The url to navigate to"}},required:["url"]},execute:async(e,t)=>await this.callInnerTool(()=>this.navigate_to(t,e.url))},{name:"current_page",description:"Get the information of the current webpage (url, title)",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.get_current_page(t))},{name:"go_back",description:"Navigate back in browser history",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.go_back(t))},{name:"input_text",description:"Input text into an element",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to input text into"},text:{type:"string",description:"The text to input"},enter:{type:"boolean",description:"When text input is completed, press Enter (applicable to search boxes)",default:!1}},required:["index","text"]},execute:async(e,t)=>await this.callInnerTool(()=>this.input_text(t,e.index,e.text,e.enter))},{name:"click_element",description:"Click on an element by index",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to click"},num_clicks:{type:"number",description:"number of times to click the element, default 1"},button:{type:"string",description:"Mouse button type, default left",enum:["left","right","middle"]}},required:["index"]},execute:async(e,t)=>await this.callInnerTool(()=>this.click_element(t,e.index,e.num_clicks||1,e.button||"left"))},{name:"scroll_mouse_wheel",description:"Scroll the mouse wheel at current position, only scroll when you need to load more content",parameters:{type:"object",properties:{amount:{type:"number",description:"Scroll amount (up / down)",minimum:1,maximum:10},direction:{type:"string",enum:["up","down"]},extract_page_content:{type:"boolean",default:!1,description:"After scrolling is completed, whether to extract the current latest page content"}},required:["amount","direction","extract_page_content"]},execute:async(e,t)=>await this.callInnerTool(async()=>{let n=e.amount;await this.scroll_mouse_wheel(t,"up"==e.direction?-n:n,1==e.extract_page_content)})},{name:"hover_to_element",description:"Mouse hover over the element",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to input text into"}},required:["index"]},execute:async(e,t)=>await this.callInnerTool(()=>this.hover_to_element(t,e.index))},{name:"extract_page_content",description:"Extract the text content and image links of the current webpage, please use this tool to obtain webpage data.",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.extract_page_content(t))},{name:"get_select_options",description:"Get all options from a native dropdown element (<select>).",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to select"}},required:["index"]},execute:async(e,t)=>await this.callInnerTool(()=>this.get_select_options(t,e.index))},{name:"select_option",description:"Select the native dropdown option, Use this after get_select_options and when you need to select an option from a dropdown.",parameters:{type:"object",properties:{index:{type:"number",description:"The index of the element to select"},option:{type:"string",description:"Text option"}},required:["index","option"]},execute:async(e,t)=>await this.callInnerTool(()=>this.select_option(t,e.index,e.option))},{name:"get_all_tabs",description:"Get all tabs of the current browser",parameters:{type:"object",properties:{}},execute:async(e,t)=>await this.callInnerTool(()=>this.get_all_tabs(t))},{name:"switch_tab",description:"Switch to the specified tab page",parameters:{type:"object",properties:{tabId:{type:"number",description:"Tab ID, obtained through get_all_tabs"}},required:["tabId"]},execute:async(e,t)=>await this.callInnerTool(()=>this.switch_tab(t,e.tabId))},{name:"wait",noPlan:!0,description:"Wait for specified duration",parameters:{type:"object",properties:{duration:{type:"number",description:"Duration in millisecond",default:500,minimum:200,maximum:1e4}},required:["duration"]},execute:async(e,t)=>await this.callInnerTool(()=>r(e.duration||200))}]}async double_screenshots(e,t,n){return!0}async handleMessages(e,t,n){const s="This is the environmental information after the operation, including the latest browser screenshot and page elements. Please perform the next operation based on the environmental information. Do not output the following elements and index information in your response.\n\nIndex and elements:\n";let o=this.lastToolResult(t);if(o&&"extract_page_content"!==o.toolName&&"get_all_tabs"!==o.toolName&&"variable_storage"!==o.toolName){await r(300);let o=[];if(await this.double_screenshots(e,t,n)){let t=await this.screenshot(e),n=l(t.imageBase64);o.push({type:"image",image:n,mimeType:t.imageType})}let a=await this.screenshot_and_html(e),i=l(a.imageBase64);o.push({type:"image",image:i,mimeType:a.imageType}),t.push({role:"user",content:[...o,{type:"text",text:s+"```html\n"+a.pseudoHtml+"\n```"}]})}super.handleMessages(e,t,n),this.handlePseudoHtmlText(t,s)}handlePseudoHtmlText(e,t){for(let n=0;n<e.length;n++){let s=e[n];if("user"!==s.role||s.content.length<=1)continue;let o=s.content;for(let s=0;s<o.length;s++){let r=o[s];"text"==r.type&&r.text.startsWith(t)&&n>=2&&n<e.length-3&&(r.text=this.removePseudoHtmlAttr(r.text,["class","src","href"]))}"[image]"==o[0].text&&"[image]"==o[1].text&&o.splice(0,1)}}removePseudoHtmlAttr(e,t){return e.split("\n").map(e=>{if(!e.startsWith("[")||-1==e.indexOf("]:<"))return e;e=e.substring(e.indexOf("]:<")+2);for(let n=0;n<t.length;n++){let s=e.indexOf(t[n]+'="');if(-1==s)continue;let o=e.indexOf('"',s+t[n].length+3);-1!=o&&(e=e.substring(0,s)+e.substring(o+1).trim())}return e.replace('" >','">').replace(" >",">")}).join("\n")}}function Ei(e){let t,{index:n,text:s,enter:o}=e,r=window.get_highlight_element(n);if(!r)return!1;if("IFRAME"==r.tagName){let e=r.contentDocument||r.contentWindow.document;t=e.querySelector("textarea")||e.querySelector('*[contenteditable="true"]')||e.querySelector("input")}else"INPUT"==r.tagName||"TEXTAREA"==r.tagName||0==r.childElementCount?t=r:(t=r.querySelector("input")||r.querySelector("textarea"),t||(t=r.querySelector('*[contenteditable="true"]')||r,"DIV"==t.tagName&&(t=t.querySelector("span")||t.querySelector("div")||t)));if(t.focus&&t.focus(),!s&&o)return["keydown","keypress","keyup"].forEach(e=>{const n=new KeyboardEvent(e,{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(n)}),!0;if(null==t.value)t.textContent=s;else if(t.value=s,t.__proto__){let e=Object.getOwnPropertyDescriptor(t.__proto__,"value")?.set;e&&e.call(t,s)}return t.dispatchEvent(new Event("input",{bubbles:!0})),o&&["keydown","keypress","keyup"].forEach(e=>{const n=new KeyboardEvent(e,{key:"Enter",code:"Enter",keyCode:13,bubbles:!0,cancelable:!0});t.dispatchEvent(n)}),!0}function Ai(e){let{index:t,button:n,num_clicks:s}=e;function o(e,n){let o=window.get_highlight_element(t);if(!o)return!1;for(let t=0;t<s;t++)for(let t=0;t<e.length;t++){const s=new MouseEvent(e[t],{view:window,bubbles:!0,cancelable:!0,button:n});o.dispatchEvent(s)}return!0}return"right"==n?o(["mousedown","mouseup","contextmenu"],2):o(["mousedown","mouseup","click"],"middle"==n?1:0)}function Oi(e){let t=window.get_highlight_element(e.index);if(!t)return!1;const n=new MouseEvent("mouseenter",{bubbles:!0,cancelable:!0,view:window});return t.dispatchEvent(n),!0}function ji(e){let t=window.get_highlight_element(e.index);return t&&"SELECT"===t.tagName.toUpperCase()?{options:Array.from(t.options).map(e=>({index:e.index,text:e.text.trim(),value:e.value})),name:t.name}:"Error: Not a select element"}function Ri(e){let t=window.get_highlight_element(e.index);if(!t||"SELECT"!==t.tagName.toUpperCase())return"Error: Not a select element";let n=e.option.trim(),s=Array.from(t.options).find(e=>e.text.trim()===n);return s||(s=Array.from(t.options).find(e=>e.value.trim()===n)),s?(t.value=s.value,t.dispatchEvent(new Event("change")),{success:!0,selectedValue:s.value,selectedText:s.text.trim()}):{success:!1,error:"Select Option not found",availableOptions:Array.from(t.options).map(e=>e.text.trim())}}function Mi(e){const t=e.amount,n=document.documentElement||document.body;if(n.scrollHeight>1.2*window.innerHeight){const e=Math.max(20,Math.min((window.innerHeight||n.clientHeight)/10,200));return void window.scrollBy(0,e*t)}function s(e=document,t=[]){for(const n of Array.from(e.querySelectorAll("*")))"IFRAME"===n.tagName&&n.contentDocument?s(n.contentDocument,t):t.push(n);return t}function o(e){const t=e.getBoundingClientRect(),s=window.innerHeight||n.clientHeight,o=window.innerWidth||n.clientWidth,r=Math.max(0,Math.min(t.left,o)),a=Math.max(0,Math.min(t.right,o)),i=Math.max(0,Math.min(t.top,s));return(a-r)*(Math.max(0,Math.min(t.bottom,s))-i)}function r(e){for(;e&&e!==document.body&&e!==document.body.parentElement;){const t=window.getComputedStyle(e);let n="auto"===t.zIndex?0:parseInt(t.zIndex)||0;if(n>0)return n;e=e.parentElement}return 0}const a=function(){const e=s();let t=e.filter(e=>{const t=window.getComputedStyle(e).getPropertyValue("overflow-y");return("auto"===t||"scroll"===t)&&e.scrollHeight>e.clientHeight});return 0==t.length&&(t=e.filter(e=>{const t=window.getComputedStyle(e).getPropertyValue("overflow-y");return"auto"===t||"scroll"===t||e.scrollHeight>e.clientHeight})),t}();if(0===a.length){const e=Math.max(20,Math.min((window.innerHeight||n.clientHeight)/10,200));return window.scrollBy(0,e*t),!1}const i=a.sort((e,t)=>{let n=r(t)-r(e);if(n>0)return 1;if(n<0)return-1;let s=o(t)-o(e);return s>0?1:s<0?-1:0}),l=i[0],u=l.clientHeight,c=Math.max(20,Math.min(u/10,200));l.scrollBy(0,c*t);const d=i.sort((e,t)=>t.getBoundingClientRect().height-e.getBoundingClientRect().height)[0];if(d!=l){const e=d.clientHeight,n=Math.max(20,Math.min(e/10,200));d.scrollBy(0,n*t)}return!0}class Di extends Si{constructor(){super(void 0,[{name:"collect_website_info",description:"从目标网站深度收集结构化信息，包括标题、描述、关键词、联系信息等",parameters:{type:"object",properties:{url:{type:"string",description:"要分析的网站URL"}},required:["url"]},execute:async(e,t)=>await this.callInnerTool(()=>this.collectWebsiteInfo(t,e.url))},{name:"analyze_form_structure",description:"分析当前页面的表单结构，识别所有输入字段、类型和要求",parameters:{type:"object",properties:{},required:[]},execute:async(e,t)=>await this.callInnerTool(()=>this.analyzeFormStructure(t))},{name:"smart_form_fill",description:"智能填充表单，根据收集的网站信息匹配到合适的表单字段",parameters:{type:"object",properties:{websiteInfo:{type:"object",description:"之前收集的网站信息档案"},formStructure:{type:"object",description:"表单结构分析结果"}},required:["websiteInfo","formStructure"]},execute:async(e,t)=>await this.callInnerTool(()=>this.smartFormFill(t,e.websiteInfo,e.formStructure))},{name:"upload_image_from_url",description:"从网络URL下载图片并上传到文件输入框",parameters:{type:"object",properties:{index:{type:"number",description:"文件输入框的元素索引"},imageUrl:{type:"string",description:"要上传的图片URL地址"},fileName:{type:"string",description:"自定义文件名（可选）",default:""}},required:["index","imageUrl"]},execute:async(e,t)=>await this.callInnerTool(()=>this.uploadImageFromUrl(t,e.index,e.imageUrl,e.fileName))}]),this.description='# 网站信息收集与多平台提交专家 Agent\n\n你是一个专业的网站信息收集与多平台提交专家，擅长从目标网站提取关键信息并智能匹配到不同平台的提交表单中。\n\n## 🔍 核心任务流程\n\n### 阶段1：信息收集与分析\n1. **深度分析目标网站**\n   - 导航到用户提供的A网站\n   - 提取页面的所有关键信息，包括：\n     - 网站标题和描述\n     - 主要内容/产品描述\n     - 关键字和标签\n     - 联系信息（邮箱、电话、地址）\n     - 网站分类/行业类型\n     - 网站图片和logo URL\n     - 技术特征和特色功能\n\n2. **结构化信息存储**\n   - 将收集到的信息按以下格式整理：\n   ```\n   网站信息档案：\n   - 网站名称: [提取的标题]\n   - 网站URL: [原始链接]\n   - 网站描述: [简介，长短两个版本]\n   - 关键词: [相关标签，用逗号分隔]\n   - 分类: [行业/类型]\n   - 联系邮箱: [如果有]\n   - 主要图片: [logo或代表性图片URL]\n   - 特色功能: [核心卖点]\n   ```\n\n### 阶段2：智能表单识别与填充\n对于每个目标提交网站，执行以下步骤：\n\n1. **表单结构分析**\n   - 仔细分析页面上的所有表单字段\n   - 识别字段类型：文本框、下拉选择、多选框、文件上传等\n   - 记录每个字段的标签、占位符文本、是否必填\n\n2. **智能信息匹配**\n   - 根据字段标签和上下文，从信息档案中匹配最合适的内容\n   - 常见匹配规则：\n     - 网站名称/标题 → "网站名称"、"公司名称"、"标题"字段\n     - 网站URL → "网站链接"、"网址"、"URL"字段\n     - 描述信息 → "描述"、"简介"、"详细信息"字段\n     - 关键词 → "标签"、"关键词"、"分类"字段\n     - 联系信息 → "邮箱"、"联系方式"字段\n     - 图片 → 文件上传字段\n\n3. **容错处理机制**\n   - 如果字段标签不清晰，优先选择最相关的信息\n   - 对于下拉选择，选择最接近的选项\n   - 对于必填字段，确保不留空\n   - 对于可选字段，优先填充重要信息\n\n## 🛠️ 具体操作规范\n\n### 信息提取技巧\n- 使用 `extract_page_content` 获取页面完整内容\n- 重点关注 `<title>`、`<meta description>`、`<h1>` 等关键标签\n- 查找 FAQ、About Us、Contact 等信息丰富的页面\n- 识别并提取图片资源URL\n\n### 表单填写策略\n- 优先填写必填字段（通常带有*号或红色标识）\n- 对于文本字段，根据长度限制调整内容\n- 对于选择字段，选择最匹配的选项\n- 对于文件上传，使用 `upload_image_from_url` 工具\n\n### 质量控制\n- 每次填写前确认信息的准确性和相关性\n- 避免填写明显不相关的信息\n- 对于不确定的字段，可以留空或使用通用信息\n\n## 🎯 执行示例\n\n当接收到任务："将网站 https://example.com 提交到 directory1.com 和 directory2.com"\n\n1. 分析 example.com，提取信息档案\n2. 访问 directory1.com 的提交页面\n3. 识别表单字段并智能匹配信息\n4. 填写表单并提交\n5. 重复步骤2-4处理 directory2.com\n6. 报告每个网站的提交状态\n\n## ⚠️ 注意事项\n\n- **准确性优先**: 宁可少填也不要填错\n- **适应性强**: 不同网站的表单结构差异很大，要灵活应对\n- **效率平衡**: 在信息收集的完整性和执行效率之间找到平衡\n- **错误处理**: 遇到识别困难的表单，记录具体问题并继续处理其他网站\n\n## 🔧 技术能力要求\n\n- 熟练使用所有 Browser Agent 工具\n- 具备强大的信息提取和模式识别能力\n- 能够处理各种复杂的表单结构\n- 支持文件上传和图片处理\n\n执行时请按照此流程严格操作，确保每个步骤都有明确的输出结果。'}async collectWebsiteInfo(e,t){return await this.execute_script(e,$i,[{url:t}])}async analyzeFormStructure(e){return await this.execute_script(e,Ui,[])}async smartFormFill(e,t,n){return await this.execute_script(e,Pi,[{websiteInfo:t,formStructure:n}])}async uploadImageFromUrl(e,t,n,s){return await this.execute_script(e,qi,[{index:t,imageUrl:n,customFileName:s}])}async screenshot(e){let t,n=await this.getWindowId(e);try{t=await chrome.tabs.captureVisibleTab(n,{format:"jpeg",quality:60})}catch(e){await this.sleep(1e3),t=await chrome.tabs.captureVisibleTab(n,{format:"jpeg",quality:60})}return{imageBase64:t.substring(t.indexOf("base64,")+7),imageType:"image/jpeg"}}async navigate_to(e,t){let n=await this.getWindowId(e),s=await chrome.tabs.create({url:t,windowId:n});s=await this.waitForTabComplete(s.id),await this.sleep(200),e.variables.set("windowId",s.windowId);let o=e.variables.get("navigateTabIds")||[];return o.push(s.id),e.variables.set("navigateTabIds",o),{url:t,title:s.title,tabId:s.id}}async get_all_tabs(e){let t=await this.getWindowId(e),n=await chrome.tabs.query({windowId:t}),s=[];for(let e=0;e<n.length;e++){let t=n[e];s.push({tabId:t.id,url:t.url,title:t.title})}return s}async switch_tab(e,t){let n=await chrome.tabs.update(t,{active:!0});if(!n)throw new Error("tabId does not exist: "+t);return e.variables.set("windowId",n.windowId),{tabId:n.id,url:n.url,title:n.title}}async execute_script(e,t,n){let s=await this.getTabId(e);return(await chrome.scripting.executeScript({target:{tabId:s},func:t,args:n}))[0].result}async getTabId(e){let t=await this.getWindowId(e),n=await chrome.tabs.query({windowId:t,active:!0,windowType:"normal"});return 0==n.length&&(n=await chrome.tabs.query({windowId:t,windowType:"normal"})),n[n.length-1].id}async getWindowId(e){let t=e.variables.get("windowId");if(t)return t;let n=await chrome.windows.getLastFocused({windowTypes:["normal"]});if(n||(n=await chrome.windows.getCurrent({windowTypes:["normal"]})),n)return n.id;let s=await chrome.tabs.query({windowType:"normal",currentWindow:!0});return 0==s.length&&(s=await chrome.tabs.query({windowType:"normal",lastFocusedWindow:!0})),s[s.length-1].windowId}async waitForTabComplete(e,t=8e3){return new Promise(async(n,s)=>{const o=setTimeout(async()=>{chrome.tabs.onUpdated.removeListener(r);let t=await chrome.tabs.get(e);n(t)},t),r=async(t,s,a)=>{t==e&&"complete"===s.status&&(chrome.tabs.onUpdated.removeListener(r),clearTimeout(o),n(a))};let a=await chrome.tabs.get(e);if("complete"===a.status)return n(a),void clearTimeout(o);chrome.tabs.onUpdated.addListener(r)})}sleep(e){return new Promise(t=>setTimeout(()=>t(),e))}}async function $i(e){var t,n,s,o,r,a,i,l;try{const u={url:e.url,title:"",descriptions:{short:"",long:""},keywords:[],category:"",contactEmail:"",images:{logo:"",featured:[]},features:[],metadata:{}};u.title=document.title||(null===(n=null===(t=document.querySelector("h1"))||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim())||"";const c=null===(s=document.querySelector('meta[name="description"]'))||void 0===s?void 0:s.getAttribute("content");c&&(u.descriptions.short=c.substring(0,150),u.descriptions.long=c);const d=document.querySelector('[class*="about"], [id*="about"], [class*="intro"], [id*="intro"]');d&&!u.descriptions.long&&(u.descriptions.long=(null===(o=d.textContent)||void 0===o?void 0:o.trim().substring(0,500))||"");const p=null===(r=document.querySelector('meta[name="keywords"]'))||void 0===r?void 0:r.getAttribute("content");p&&(u.keywords=p.split(",").map(e=>e.trim()));const h=u.title.toLowerCase().split(/\s+/);u.keywords=[...new Set([...u.keywords,...h])];const m=/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,g=(document.body.textContent||"").match(m);g&&g.length>0&&(u.contactEmail=g[0]);const f=document.querySelector('img[class*="logo"], img[id*="logo"], .logo img');return f&&(u.images.logo=f.src),document.querySelectorAll('img[class*="hero"], img[class*="featured"], img[class*="banner"]').forEach((e,t)=>{t<3&&u.images.featured.push(e.src)}),u.metadata={language:document.documentElement.lang||"en",charset:document.characterSet,ogTitle:null===(a=document.querySelector('meta[property="og:title"]'))||void 0===a?void 0:a.getAttribute("content"),ogDescription:null===(i=document.querySelector('meta[property="og:description"]'))||void 0===i?void 0:i.getAttribute("content"),ogImage:null===(l=document.querySelector('meta[property="og:image"]'))||void 0===l?void 0:l.getAttribute("content")},{success:!0,websiteInfo:u,message:`成功收集网站信息: ${u.title}`}}catch(e){return{success:!1,error:`信息收集失败: ${e.message}`}}}function Ui(){try{const e=document.querySelectorAll("form"),t={formsCount:e.length,fields:[]};return e.forEach((e,n)=>{e.querySelectorAll("input, textarea, select").forEach((s,o)=>{var r,a;const i=s,l={formIndex:n,elementIndex:o,type:i.type||s.tagName.toLowerCase(),name:i.name||"",id:i.id||"",placeholder:i.placeholder||"",required:s.hasAttribute("required"),label:"",options:[]},u=e.querySelector(`label[for="${s.id}"]`)||s.closest("label")||"LABEL"===(null===(r=s.previousElementSibling)||void 0===r?void 0:r.tagName)?s.previousElementSibling:null;u&&(l.label=(null===(a=u.textContent)||void 0===a?void 0:a.trim())||""),"select"===s.tagName.toLowerCase()&&s.querySelectorAll("option").forEach(e=>{var t;l.options.push({value:e.value,text:null===(t=e.textContent)||void 0===t?void 0:t.trim()})}),t.fields.push(l)})}),{success:!0,formStructure:t,message:`分析了 ${e.length} 个表单，共 ${t.fields.length} 个字段`}}catch(e){return{success:!1,error:`表单分析失败: ${e.message}`}}}function Pi(e){try{const{websiteInfo:t,formStructure:n}=e,s=[];return n.fields.forEach((e,n)=>{const o=document.querySelector(`input:nth-of-type(${n+1}), textarea:nth-of-type(${n+1}), select:nth-of-type(${n+1})`);if(!o)return;let r="";const a=(e.label+e.placeholder+e.name+e.id).toLowerCase();if(a.includes("title")||a.includes("name")||a.includes("site"))r=t.title;else if(a.includes("url")||a.includes("website")||a.includes("link"))r=t.url;else if(a.includes("description")||a.includes("about")||a.includes("summary"))r="textarea"===e.type?t.descriptions.long:t.descriptions.short;else if(a.includes("email")||a.includes("contact"))r=t.contactEmail;else if(a.includes("keyword")||a.includes("tag"))r=t.keywords.join(", ");else if((a.includes("category")||a.includes("type"))&&"select"===e.type&&e.options.length>0){const t=e.options.find(e=>e.value&&""!==e.value);t&&(r=t.value)}r&&o&&(e.type,o.value=r,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),s.push({field:e.label||e.name||e.id,value:r,success:!0}))}),{success:!0,fillResults:s,message:`成功填充 ${s.length} 个字段`}}catch(e){return{success:!1,error:`表单填充失败: ${e.message}`}}}async function qi(e){try{const{index:t,imageUrl:n,customFileName:s}=e,o=window.get_highlight_element(t);if(!o)return{success:!1,error:`无法找到索引为 ${t} 的元素`};if("file"!==o.type)return{success:!1,error:"目标元素不是文件输入框"};const r=await fetch(n,{mode:"cors",credentials:"omit"});if(!r.ok)throw new Error(`HTTP错误: ${r.status} ${r.statusText}`);const a=await r.blob();if(!a.type.startsWith("image/"))return{success:!1,error:`URL返回的不是图片文件，而是: ${a.type}`};let i=s;i||(i=new URL(n).pathname.split("/").pop()||"image",i.includes(".")||(i+=`.${a.type.split("/")[1]||"jpg"}`));const l=new File([a],i,{type:a.type,lastModified:Date.now()}),u=new DataTransfer;return u.items.add(l),o.files=u.files,o.dispatchEvent(new Event("change",{bubbles:!0})),o.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,fileName:l.name,fileSize:l.size,fileType:l.type,originalUrl:n,message:`成功上传图片: ${l.name} (${Math.round(l.size/1024)}KB)`}}catch(t){return console.error("图片上传失败:",t),{success:!1,error:`上传失败: ${t.message}`,originalUrl:e.imageUrl}}}function Li(e,t,n){chrome.runtime.sendMessage({type:"log",log:e+"",level:t||"info",stream:n})}var Fi;chrome.storage.local.set({isRunning:!1}),chrome.runtime.onMessage.addListener(async function(e,t,n){if("run"==e.type)try{chrome.runtime.sendMessage({type:"log",log:"开始运行..."}),Fi=await async function(e){let t=await async function(e="llmConfig"){return(await chrome.storage.sync.get([e]))[e]}();if(!t||!t.apiKey)return Li("请配置API密钥，请在浏览器扩展的选项页面中配置LLM参数。","error"),chrome.runtime.openOptionsPage(),chrome.storage.local.set({isRunning:!1}),void chrome.runtime.sendMessage({type:"stop"});const n={default:{provider:t.llm,model:t.modelName,apiKey:t.apiKey,config:{baseURL:t.options.baseURL}}};let s={onMessage:async e=>{try{"workflow"==e.type?Li("计划生成完成","info",!e.streamDone):"text"==e.type?Li(e.text,"info",!e.streamDone):"tool_streaming"==e.type?Li(`${e.agentName} > ${e.toolName}`,"info",!0):"tool_use"==e.type&&Li(`${e.agentName} > ${e.toolName}`,"info")}catch(e){console.error("消息处理错误:",e),Li("处理消息时出现错误","error")}},onHumanConfirm:async(e,t)=>async function(e){let t=await chrome.tabs.query({active:!0,windowType:"normal"});return(await chrome.scripting.executeScript({target:{tabId:t[0].id},func:e=>window.confirm(e),args:[e]}))[0].result}(t)},o=[new Di],r=new Ti({llms:n,agents:o,callback:s});return r.run(e).then(e=>{Li(e.result,e.success?"success":"error")}).catch(e=>{Li(e,"error")}).finally(()=>{chrome.storage.local.set({isRunning:!1}),chrome.runtime.sendMessage({type:"stop"})}),r}(e.prompt)}catch(e){console.error(e),chrome.runtime.sendMessage({type:"log",log:e+"",level:"error"})}else"stop"==e.type&&(Fi&&Fi.getAllTaskId().forEach(e=>{Fi.abortTask(e),chrome.runtime.sendMessage({type:"log",log:"中止任务: "+e})}),chrome.runtime.sendMessage({type:"log",log:"停止"}))})})();